<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§å–®å­—å°è€ƒå®˜ v15.0 (å…¥å£åˆ†æµç‰ˆ)</title>
    <style>
        /* --- ğŸ¨ è‰²å½©èˆ‡è®Šæ•¸ --- */
        :root {
            --bg-color: #FFFbf0;
            --card-bg: #ffffff;
            --primary: #5dade2;  /* è€å¸«è— */
            --student: #48c9b0;  /* å­¸ç”Ÿç¶  */
            --accent: #f5b041;
            --danger: #ec7063;
            --success: #27ae60;
            --text-main: #2c3e50;
            --radius-box: 20px;
            --radius-btn: 50px;
            --shadow: 0 8px 20px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Microsoft JhengHei', 'Varela Round', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 15px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
        }

        /* --- ğŸšª å…¥å£å¤§å»³æ¨£å¼ (Landing Page) --- */
        #landing-page {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; max-width: 600px; margin-top: 5vh; gap: 30px; animation: fadeIn 0.5s;
        }

        .landing-card {
            background: white; width: 100%; padding: 40px 20px;
            border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center; cursor: pointer; transition: 0.2s;
            border: 4px solid transparent; position: relative; overflow: hidden;
        }
        
        /* è€å¸«å¡ç‰‡æ¨£å¼ */
        .card-teacher { border-color: var(--primary); }
        .card-teacher:hover { background: #eaf2f8; transform: translateY(-5px); }
        .card-teacher .icon { font-size: 4rem; margin-bottom: 10px; display: block; }
        .card-teacher h2 { color: var(--primary); margin: 0; font-size: 1.8rem; }
        .card-teacher p { color: #7f8c8d; margin-top: 5px; }

        /* å­¸ç”Ÿå¡ç‰‡æ¨£å¼ */
        .card-student { border-color: var(--student); }
        .card-student:hover { background: #e8f8f5; transform: translateY(-5px); }
        .card-student .icon { font-size: 4rem; margin-bottom: 10px; display: block; }
        .card-student h2 { color: var(--student); margin: 0; font-size: 1.8rem; }
        .card-student p { color: #7f8c8d; margin-top: 5px; }

        .app-title { font-size: 2.2rem; font-weight: 900; color: var(--text-main); margin-bottom: 10px; text-align: center; }
        .app-subtitle { color: #7f8c8d; text-align: center; margin-bottom: 20px; }

        /* --- ğŸ‘©â€ğŸ« è€å¸«ç‰ˆæ‡‰ç”¨ç¨‹å¼å®¹å™¨ --- */
        #teacher-app {
            display: none; /* é è¨­éš±è— */
            width: 100%; max-width: 900px;
            background: var(--card-bg); border-radius: var(--radius-box);
            box-shadow: var(--shadow); overflow: hidden;
            border: 2px solid #fff; min-height: 85vh;
            flex-direction: column;
            animation: slideIn 0.3s;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Header å„ªåŒ– --- */
        header {
            background: var(--primary); color: white; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-title { display: flex; align-items: center; gap: 10px; font-size: 1.3rem; font-weight: bold; }
        
        /* å°èˆªæŒ‰éˆ•ç¾¤çµ„ */
        .nav-group { display: flex; gap: 10px; flex-wrap: wrap; }

        /* å„ªåŒ–å¾Œçš„æŒ‰éˆ• */
        .nav-btn {
            background: rgba(255,255,255,0.2); 
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px; /* ç¨å¾®æ–¹ä¸€é»ï¼Œåƒæ¨™ç±¤ */
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: bold;
            display: flex; align-items: center; gap: 6px; /* åœ–æ¨™èˆ‡æ–‡å­—é–“è· */
            transition: 0.2s;
            text-decoration: none;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.35); transform: translateY(-2px); }
        .nav-btn:active { transform: scale(0.95); }
        
        /* ç‰¹åˆ¥æŒ‰éˆ•é¡è‰²å€éš” */
        .btn-home { border-bottom: 3px solid #AED6F1; } /* è—åº•ç·š */
        .btn-record { border-bottom: 3px solid #ABEBC6; } /* ç¶ åº•ç·š */
        .btn-help { border-bottom: 3px solid #F9E79F; color: #FFF; } /* é»ƒåº•ç·š */
        .btn-exit { background: rgba(0,0,0,0.2); font-size: 0.85rem; margin-left: 10px; }

        /* --- å…§å®¹å€å¡Š --- */
        .screen { padding: 25px; display: none; flex: 1; }
        .screen.active { display: block; animation: fadeIn 0.3s; }

        /* è¨­å®šå€èˆ‡æ¸¬é©—å€ (æ²¿ç”¨ä¹‹å‰çš„è¨­è¨ˆ) */
        .section-title { font-size: 1.1rem; color: var(--primary-dark); margin: 15px 0 10px; border-left: 4px solid var(--accent); padding-left: 10px; font-weight: bold; }
        .session-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px; max-height: 180px; overflow-y: auto; }
        .session-btn { background: #f4f6f7; border: 1px solid #e5e8e8; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer; font-weight: bold; color: #7f8c8d; position: relative; }
        .session-btn input { position: absolute; opacity: 0; }
        .session-btn:has(input:checked) { background: #eaf2f8; border-color: var(--primary); color: var(--primary-dark); box-shadow: 0 2px 5px rgba(93,173,226,0.2); }
        
        .quick-select-bar { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .btn-pill { padding: 8px 12px; background: #fff; border: 1px solid #bdc3c7; border-radius: 50px; color: var(--text-main); cursor: pointer; font-weight: bold; flex-grow: 1; }
        .btn-pill:active { background: #eee; }
        select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #bdc3c7; font-size: 1rem; }
        
        .btn-big { width: 100%; padding: 15px; background: var(--primary); color: white; font-size: 1.3rem; font-weight: 800; border: none; border-radius: 15px; cursor: pointer; box-shadow: 0 4px 0 #2874a6; margin-top: 20px; }
        .btn-big:disabled { background: #ccc; box-shadow: none; }

        /* æ¸¬é©—å¡ç‰‡ */
        .card-container { display: flex; gap: 15px; margin-bottom: 20px; align-items: flex-start; }
        .flash-card { flex-grow: 1; background: #fff; border: 2px dashed #d5dbdb; border-radius: 15px; padding: 20px 10px; text-align: center; }
        .word-display { font-size: clamp(2.5rem, 8vw, 5rem); font-weight: 900; color: var(--primary-dark); margin-bottom: 10px; }
        .sentence-display { font-size: clamp(1rem, 4vw, 1.6rem); color: #555; background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: left; }
        
        .timer-wrapper { display: flex; flex-direction: column; align-items: center; gap: 5px; min-width: 80px; }
        .timer-btn { width: 70px; height: 70px; background: white; border: 4px solid var(--accent); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2rem; font-weight: 900; color: var(--accent); cursor: pointer; }
        .timer-btn.ticking { color: var(--danger); border-color: var(--danger); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* å­¸ç”ŸæŒ‰éˆ• */
        .student-grid { display: grid; gap: 10px; grid-template-columns: repeat(5, 1fr); margin-bottom: 20px; }
        .btn-student { background: white; border: 2px solid #e5e8e8; border-radius: 12px; cursor: pointer; padding: 10px 0; display: flex; flex-direction: column; align-items: center; aspect-ratio: 1/1; justify-content: center; }
        .btn-student.marked-wrong { background: var(--danger); border-color: #c0392b; color: white; }
        .btn-student.marked-wrong .name { color: white; }
        .avatar { font-size: 2.5rem; } .name { font-weight: 900; color: #7f8c8d; font-size: 1.2rem; }
        
        /* æœ—è®€èˆ‡åŠŸèƒ½æŒ‰éˆ• */
        .btn-auto-speak { background: var(--accent); color: white; border: none; padding: 8px 20px; border-radius: 30px; font-weight: bold; cursor: pointer; margin-bottom: 10px; display: inline-flex; align-items: center; gap: 5px; }
        .btn-speak-small { background: #eaf2f8; border: none; color: var(--primary); width: 30px; height: 30px; border-radius: 50%; cursor: pointer; margin-left: 10px; }

        /* RWD */
        @media (max-width: 600px) {
            .card-container { flex-direction: column; }
            .timer-wrapper { flex-direction: row; width: 100%; justify-content: center; margin-top: -10px; }
            .student-grid { grid-template-columns: repeat(3, 1fr); }
            .nav-btn { padding: 6px 10px; font-size: 0.85rem; }
            .nav-group { width: 100%; justify-content: space-between; margin-top: 10px; }
            header { justify-content: center; }
        }

        /* å ±è¡¨å€ */
        .data-area { background: #eaf2f8; padding: 15px; border-radius: 15px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; }
        .btn-dl { background: var(--success); color: white; border: none; padding: 10px; border-radius: 30px; font-weight: bold; cursor: pointer; width: 100%; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 25px; width: 90%; max-width: 600px; border-radius: 20px; max-height: 80vh; overflow-y: auto; position: relative; }
        .close-btn { float: right; font-size: 28px; cursor: pointer; }

    </style>
</head>
<body>

    <div id="landing-page">
        <div>
            <div class="app-title">ğŸ æ™ºæ…§å–®å­—å°è€ƒå®˜</div>
            <div class="app-subtitle">Smart Spelling Bee Assistant</div>
        </div>

        <div class="landing-card card-teacher" onclick="enterTeacherMode()">
            <span class="icon">ğŸ‘©â€ğŸ«</span>
            <h2>æˆ‘æ˜¯è€å¸«</h2>
            <p>Teacher Mode</p>
            <div style="font-size:0.9rem; margin-top:10px; color:#aaa;">(æ¸¬é©—æ§åˆ¶ã€éŒ¯é¡Œç´€éŒ„ã€ç­ç´šç®¡ç†)</div>
        </div>

        <div class="landing-card card-student" onclick="enterStudentMode()">
            <span class="icon">ğŸ’</span>
            <h2>æˆ‘æ˜¯å­¸ç”Ÿ</h2>
            <p>Student Mode</p>
            <div style="font-size:0.9rem; margin-top:10px; color:#aaa;">(è‡ªä¸»ç·´ç¿’ã€è½å¯«æŒ‘æˆ°ã€å–®å­—å¡)</div>
        </div>
    </div>


    <div id="teacher-app">
        <header>
            <div class="header-title">
                <span>ğŸ‘©â€ğŸ«</span>
                <span>æ¸¬é©—æ§åˆ¶å°</span>
            </div>
            <div class="nav-group">
                <button class="nav-btn btn-home" onclick="showScreen('setupScreen')">
                    <span>ğŸ </span> æ¸¬é©—é¦–é 
                </button>
                <button class="nav-btn btn-record" onclick="showHistory()">
                    <span>ğŸ“Š</span> ç­ç´šç´€éŒ„
                </button>
                <button class="nav-btn btn-help" onclick="openHelp()">
                    <span>â“</span> ä½¿ç”¨èªªæ˜
                </button>
                <button class="nav-btn btn-exit" onclick="exitTeacherMode()">
                    ğŸšª å›å…¥å£
                </button>
            </div>
        </header>

        <div id="setupScreen" class="screen active">
            <div id="loadError" style="display:none; color:red; text-align:center; padding:10px;">âš ï¸ æ‰¾ä¸åˆ° words.js</div>
            
            <div class="section-title">1. é¸æ“‡ç¯„åœ</div>
            <div class="session-panel">
                <div class="quick-select-bar">
                    <button class="btn-pill" onclick="selectRange(1,5)">1~5</button>
                    <button class="btn-pill" onclick="selectRange(6,10)">6~10</button>
                    <button class="btn-pill" onclick="selectRange(11,16)">11~16</button>
                    <button class="btn-pill" onclick="selectRange(1,16)">å…¨éƒ¨</button>
                    <button class="btn-pill" onclick="clearSelection()" style="color:var(--danger); border-color:var(--danger); flex-grow:0;">æ¸…é™¤</button>
                </div>
                <div id="sessionGrid" class="session-grid"></div>
            </div>

            <div class="section-title">2. é¡Œæ•¸è¨­å®š</div>
            <select id="wordCount">
                <option value="5">5 é¡Œ (æš–èº«)</option>
                <option value="10" selected>10 é¡Œ (æ¨™æº–)</option>
                <option value="20">20 é¡Œ (é€²éš)</option>
                <option value="30">30 é¡Œ (é«˜æ‰‹)</option>
                <option value="50">50 é¡Œ (ç¸½è¤‡ç¿’)</option>
            </select>

            <button id="startBtn" class="btn-big" onclick="startTest()" disabled>é–‹å§‹æ¸¬é©— â–¶</button>
        </div>

        <div id="testScreen" class="screen">
            <div class="progress-text">ç¬¬ <strong id="currentNum" style="color:var(--primary);">1</strong> / <span id="totalNum">10</span> é¡Œ</div>
            
            <div class="card-container">
                <div class="flash-card">
                    <button class="btn-auto-speak" onclick="playQuestionSequence()">ğŸ”Š æ’­æ”¾é¡Œç›® (å­—-å¥-å­—)</button>
                    
                    <div style="display:flex; align-items:center; justify-content:center; margin-bottom:10px;">
                        <div class="word-display" id="displayWord">...</div>
                        <button class="btn-speak-small" onclick="speakText('word')">ğŸ”Š</button>
                    </div>
                    
                    <div style="display:flex; align-items:center; justify-content:center;">
                        <div class="sentence-display" id="displaySentence">...</div>
                        <button class="btn-speak-small" onclick="speakText('sentence')">ğŸ”Š</button>
                    </div>
                </div>
                
                <div class="timer-wrapper">
                    <button class="timer-btn" id="timerBtn" onclick="toggleTimer()">8</button>
                    <div style="font-size:0.8rem; color:#aaa; font-weight:bold;">å€’æ•¸</div>
                </div>
            </div>

            <div class="mistake-label">ğŸ‘‡ èª°ç­”éŒ¯äº†ï¼Ÿé»æ“Šæ¨™è¨˜ (è®Šç´…è‰²)ï¼š</div>
            <div class="student-grid">
                <div class="btn-student" id="btn-s1" onclick="toggleStudent(1)"><span class="avatar">ğŸƒ</span><span class="name">1</span></div>
                <div class="btn-student" id="btn-s2" onclick="toggleStudent(2)"><span class="avatar">ğŸ¦«</span><span class="name">2</span></div>
                <div class="btn-student" id="btn-s3" onclick="toggleStudent(3)"><span class="avatar">ğŸ¦¥</span><span class="name">3</span></div>
                <div class="btn-student" id="btn-s4" onclick="toggleStudent(4)"><span class="avatar">ğŸ¦›</span><span class="name">4</span></div>
                <div class="btn-student" id="btn-s5" onclick="toggleStudent(5)"><span class="avatar">ğŸ¨</span><span class="name">5</span></div>
            </div>

            <button class="btn-big btn-next" onclick="nextWord()">ä¸‹ä¸€é¡Œ â¡</button>
        </div>

        <div id="historyScreen" class="screen">
            <div class="data-area">
                <button class="btn-dl" onclick="exportToCSV()">ğŸ“¥ åŒ¯å‡º Excel å ±è¡¨</button>
                <div style="display:flex; gap:10px;">
                    <button class="btn-dl" style="background:#8e44ad;" onclick="backupData()">ğŸ’¾ å‚™ä»½</button>
                    <button class="btn-dl" style="background:#34495e;" onclick="document.getElementById('fileInput').click()">ğŸ“‚ åŒ¯å…¥</button>
                    <input type="file" id="fileInput" style="display:none" onchange="restoreData(this)">
                </div>
                <button style="background:transparent; border:1px solid var(--danger); color:var(--danger); padding:8px; border-radius:20px; cursor:pointer;" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…ç©ºç´€éŒ„</button>
            </div>
            
            <div style="display:flex; flex-direction:column; gap:20px;">
                <div style="background:#f9f9f9; padding:15px; border-radius:15px;">
                    <h3 style="margin:0 0 10px 0; font-size:1rem;">ğŸ§‘â€ğŸ“ å­¸ç”Ÿæ’è¡Œæ¦œ</h3>
                    <select id="historyStudentSelect" onchange="renderStudentHistory()" style="width:100%; padding:10px; margin-bottom:10px;">
                        <option value="1">ğŸƒ 1è™Ÿ</option><option value="2">ğŸ¦« 2è™Ÿ</option><option value="3">ğŸ¦¥ 3è™Ÿ</option><option value="4">ğŸ¦› 4è™Ÿ</option><option value="5">ğŸ¨ 5è™Ÿ</option>
                    </select>
                    <div id="studentStatsTable" class="table-container"></div>
                </div>
                <div style="background:#f9f9f9; padding:15px; border-radius:15px;">
                    <h3 style="margin:0 0 10px 0; font-size:1rem;">ğŸš¨ å¸¸éŒ¯å–®å­— TOP 50</h3>
                    <div id="globalStatsTable" class="table-container"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeHelp()">&times;</span>
            <h2 style="color:var(--primary); text-align:center;">ğŸ“– æ•™å¸«æ“ä½œæŒ‡å—</h2>
            <div class="help-section"><div class="help-title">ğŸ¯ å¦‚ä½•ä½¿ç”¨</div><p>1. å‹¾é¸å–®å…ƒç¯„åœã€‚<br>2. é–‹å§‹æ¸¬é©—ï¼ŒæŒ‰ä¸‹ã€Œæ’­æ”¾é¡Œç›®ã€è‡ªå‹•å”¸å­—ã€‚<br>3. é»æ“Šç­”éŒ¯å­¸ç”Ÿçš„é ­åƒã€‚<br>4. æ¸¬é©—çµæŸè‡ªå‹•çµ±è¨ˆã€‚</p></div>
            <div class="help-section" style="border:none;"><div class="help-title">ğŸ’¾ é—œæ–¼å­˜æª”</div><p>è³‡æ–™å­˜åœ¨é€™å°é›»è…¦ã€‚è‹¥è¦æ›é›»è…¦ï¼Œè«‹å…ˆã€Œå‚™ä»½ã€å†ã€ŒåŒ¯å…¥ã€ã€‚</p></div>
            <div style="text-align:center;"><button class="btn-big" style="width:auto; padding:10px 30px; margin:0;" onclick="closeHelp()">OK</button></div>
        </div>
    </div>

<script src="words.js" onerror="document.getElementById('loadError').style.display='block'"></script>
<script>
    // --- å…¥å£é‚è¼¯ ---
    function enterTeacherMode() {
        document.getElementById('landing-page').style.display = 'none';
        document.getElementById('teacher-app').style.display = 'flex';
        // å¦‚æœé‚„æ²’åˆå§‹åŒ–ï¼Œé€™æ™‚è¼‰å…¥
        if(typeof masterWordList !== 'undefined' && db.length === 0) {
            db = masterWordList; initApp();
        }
    }
    function enterStudentMode() { window.location.href = "student.html"; }
    function exitTeacherMode() {
        document.getElementById('teacher-app').style.display = 'none';
        document.getElementById('landing-page').style.display = 'flex';
        showScreen('setupScreen'); // é‡ç½®å›è¨­å®šé 
    }

    // --- è€å¸«ç‰ˆé‚è¼¯ ---
    let db = [], testList = [], currentIndex = 0;
    let timerValue = 8, timerInterval = null, isTimerRunning = false;

    // é è¼‰ (è‹¥ç›´æ¥é‡æ•´)
    window.onload = function() { if (typeof masterWordList !== 'undefined') db = masterWordList; }

    function initApp() {
        document.getElementById('startBtn').disabled = false;
        const sessions = [...new Set(db.map(x => x.session))].sort((a,b)=>a-b);
        const grid = document.getElementById('sessionGrid'); grid.innerHTML = '';
        sessions.forEach(s => { grid.innerHTML += `<label class="session-btn"><input type="checkbox" value="${s}" class="sess-cb"> U${s}</label>`; });
    }

    // ç•«é¢åˆ‡æ›
    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function openHelp() { document.getElementById('helpModal').style.display = 'block'; }
    function closeHelp() { document.getElementById('helpModal').style.display = 'none'; }
    
    // é¸å–åŠŸèƒ½
    function selectRange(s, e) { document.querySelectorAll('.sess-cb').forEach(cb => { const v = parseInt(cb.value); if(!isNaN(v)) cb.checked = (v >= s && v <= e); }); }
    function clearSelection() { document.querySelectorAll('.sess-cb').forEach(cb => cb.checked = false); }

    // æ¸¬é©—æµç¨‹
    function startTest() {
        const cbs = document.querySelectorAll('.sess-cb:checked');
        const sids = Array.from(cbs).map(cb => isNaN(parseInt(cb.value)) ? cb.value : parseInt(cb.value));
        if(sids.length === 0) { alert("è«‹é¸æ“‡å–®å…ƒ"); return; }
        const pool = db.filter(i => sids.includes(i.session));
        if(pool.length === 0) { alert("ç„¡å–®å­—"); return; }
        testList = [...pool].sort(() => 0.5 - Math.random()).slice(0, parseInt(document.getElementById('wordCount').value));
        currentIndex = 0; showScreen('testScreen'); document.getElementById('totalNum').innerText = testList.length; loadCard();
    }

    function loadCard() {
        resetTimer(); const item = testList[currentIndex];
        document.getElementById('currentNum').innerText = currentIndex + 1;
        document.getElementById('displayWord').innerText = item.word;
        document.getElementById('displaySentence').innerText = item.sentence;
        for(let i=1; i<=5; i++) document.getElementById(`btn-s${i}`).classList.remove('marked-wrong');
    }

    // æœ—è®€
    function speakText(type) {
        const item = testList[currentIndex];
        speak(type === 'word' ? item.word : item.sentence);
    }
    function playQuestionSequence() {
        const item = testList[currentIndex];
        window.speechSynthesis.cancel();
        speak(item.word); speak(item.sentence); speak(item.word);
    }
    function speak(text) {
        const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; u.rate = 0.8;
        window.speechSynthesis.speak(u);
    }

    // è¨ˆæ™‚å™¨
    function toggleTimer() { if(isTimerRunning) resetTimer(); else startTimer(); }
    function startTimer() {
        if(isTimerRunning) return; isTimerRunning = true; timerValue = 8;
        document.getElementById('timerBtn').innerText = timerValue;
        document.getElementById('timerBtn').classList.add('ticking');
        timerInterval = setInterval(() => {
            timerValue--; document.getElementById('timerBtn').innerText = timerValue;
            if(timerValue <= 0) { clearInterval(timerInterval); playDing(); isTimerRunning = false; document.getElementById('timerBtn').classList.remove('ticking'); }
        }, 1000);
    }
    function resetTimer() { clearInterval(timerInterval); isTimerRunning = false; timerValue = 8; document.getElementById('timerBtn').innerText = "8"; document.getElementById('timerBtn').classList.remove('ticking'); }
    function playDing() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator(); const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.frequency.setValueAtTime(1200, ctx.currentTime); osc.frequency.exponentialRampToValueAtTime(600, ctx.currentTime+0.5);
        gain.gain.setValueAtTime(0.5, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime+0.5);
        osc.start(); osc.stop(ctx.currentTime+0.5);
    }

    // ç­”éŒ¯æ¨™è¨˜
    function toggleStudent(id) { document.getElementById(`btn-s${id}`).classList.toggle('marked-wrong'); }
    function nextWord() {
        const item = testList[currentIndex]; const date = new Date().toLocaleDateString('zh-TW');
        for(let i=1; i<=5; i++) {
            if (document.getElementById(`btn-s${i}`).classList.contains('marked-wrong')) saveMistake(i, item, date);
        }
        currentIndex++; if(currentIndex < testList.length) loadCard(); else { alert("æ¸¬é©—çµæŸ"); showHistory(); }
    }

    // è³‡æ–™å­˜å–
    function saveMistake(sid, w, d) {
        let h = JSON.parse(localStorage.getItem('spellingHistory')) || [];
        h.push({ student: sid, word: w.word, session: w.session, sentence: w.sentence, date: d });
        localStorage.setItem('spellingHistory', JSON.stringify(h));
    }
    function getHistory() { return JSON.parse(localStorage.getItem('spellingHistory')) || []; }
    function showHistory() { showScreen('historyScreen'); renderStudentHistory(); renderGlobalStats(); }
    
    function renderStudentHistory() {
        const sid = parseInt(document.getElementById('historyStudentSelect').value);
        const h = getHistory().filter(x => x.student === sid);
        const c = document.getElementById('studentStatsTable');
        if(h.length===0){c.innerHTML="<p style='text-align:center;color:#999'>ç„¡ç´€éŒ„</p>";return;}
        let counts={}; h.forEach(x=>{if(!counts[x.word])counts[x.word]={c:0,s:x.session};counts[x.word].c++;});
        let s = Object.keys(counts).map(k=>({w:k,...counts[k]})).sort((a,b)=>b.c-a.c);
        let html="<table><tr><th>æ¬¡</th><th>å­—</th><th>U</th></tr>";
        s.forEach(i=>{html+=`<tr><td><span class="badge">${i.c}</span></td><td>${i.w}</td><td>${i.s}</td></tr>`});
        c.innerHTML = html+"</table>";
    }
    function renderGlobalStats() {
        const h = getHistory(); const c = document.getElementById('globalStatsTable');
        if(h.length===0){c.innerHTML="<p style='text-align:center;color:#999'>ç„¡ç´€éŒ„</p>";return;}
        let counts={}; h.forEach(x=>{if(!counts[x.word])counts[x.word]=0;counts[x.word]++;});
        let s = Object.keys(counts).map(k=>({w:k,c:counts[k]})).sort((a,b)=>b.c-a.c).slice(0,50);
        let html="<table><tr><th>éŒ¯</th><th>å­—</th></tr>";
        s.forEach(i=>{html+=`<tr><td><span class="badge" style="background:var(--primary)">${i.c}</span></td><td>${i.w}</td></tr>`});
        c.innerHTML = html+"</table>";
    }

    // åŒ¯å‡º/å‚™ä»½
    function exportToCSV() {
        const h = getHistory(); if(h.length===0){alert("ç„¡è³‡æ–™");return;}
        const n = {1:"æ°´ç‰›",2:"æ°´è±š",3:"æ¨¹æ‡¶",4:"æ²³é¦¬",5:"ç„¡å°¾ç†Š"};
        let csv = "data:text/csv;charset=utf-8,\uFEFFæ—¥æœŸ,å­¸ç”Ÿ,ä»£è™Ÿ,å–®å…ƒ,å–®å­—,ä¾‹å¥\n";
        h.forEach(r => { csv+=`${r.date},${n[r.student]},${r.student},${r.session},${r.word},${(r.sentence||"").replace(/,/g,"ï¼Œ")}\n` });
        const a = document.createElement("a"); a.href=encodeURI(csv); a.download="éŒ¯é¡Œç´€éŒ„.csv"; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    function backupData() {
        const h = getHistory(); if(h.length===0){alert("ç„¡è³‡æ–™");return;}
        const a = document.createElement("a"); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(h));
        a.download="spelling_backup.json"; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    function restoreData(input) {
        const f = input.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = function(e) {
            try { const d = JSON.parse(e.target.result);
                if(Array.isArray(d)) { localStorage.setItem('spellingHistory', JSON.stringify(getHistory().concat(d))); alert("åŒ¯å…¥æˆåŠŸ"); showHistory(); }
            } catch(e){ alert("æª”æ¡ˆéŒ¯èª¤"); }
        }; r.readAsText(f); input.value='';
    }
    function clearHistory(){ if(confirm("ç¢ºå®šæ¸…ç©º?")) { localStorage.removeItem('spellingHistory'); showHistory(); } }

</script>
</body>
</html>