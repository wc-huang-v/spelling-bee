<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§å–®å­—å°è€ƒå®˜ v14.0 (è‡ªå‹•æœ—è®€ç‰ˆ)</title>
    <style>
        /* --- ğŸ¨ 1. è‰²å½©èˆ‡å­—é«”è¨­å®š --- */
        :root {
            --bg-color: #FFFbf0; /* æº«æš–çš„å¥¶æ²¹è‰² */
            --card-bg: #ffffff;
            --primary: #5dade2;  /* æŸ”å’Œè— */
            --primary-dark: #3498db;
            --accent: #f5b041;   /* æ´»æ½‘é»ƒ */
            --danger: #ec7063;   /* æŸ”å’Œç´… */
            --success: #27ae60;  /* ç¶ è‰² */
            --backup: #8e44ad;   /* ç´«è‰² */
            --text-main: #2c3e50;
            --text-light: #95a5a6;
            --radius-box: 20px;
            --radius-btn: 50px;
            --shadow: 0 8px 20px rgba(0,0,0,0.08);
        }

        body {
            font-family: 'Microsoft JhengHei', 'Varela Round', 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- ğŸ“¦ 2. å®¹å™¨èˆ‡æ’ç‰ˆ --- */
        .app-container {
            width: 100%;
            max-width: 900px;
            background: var(--card-bg);
            border-radius: var(--radius-box);
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 2px solid #fff;
            min-height: 85vh;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 1px; }

        .nav-group { display: flex; gap: 8px; flex-wrap: wrap; }

        .nav-btn {
            background: rgba(255,255,255,0.25);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 6px 12px;
            border-radius: var(--radius-btn);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: 0.2s;
            display: flex; align-items: center; gap: 5px; text-decoration: none;
        }
        .nav-btn:active { transform: scale(0.95); }

        .screen { padding: 20px; display: none; flex: 1; }
        .screen.active { display: block; animation: popIn 0.3s ease-out; }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.98); } 100% { opacity: 1; transform: scale(1); } }

        /* --- âš™ï¸ è¨­å®šç•«é¢ --- */
        .section-title {
            font-size: 1.1rem;
            color: var(--primary-dark);
            margin-bottom: 10px;
            border-left: 4px solid var(--accent);
            padding-left: 10px;
            font-weight: bold;
            margin-top: 15px;
        }

        .session-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 8px;
            margin-bottom: 20px;
            max-height: 180px;
            overflow-y: auto;
            padding: 2px;
        }

        .session-btn {
            background: #f4f6f7;
            border: 1px solid #e5e8e8;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            color: #7f8c8d;
            font-size: 0.9rem;
            position: relative;
        }
        .session-btn input { position: absolute; opacity: 0; cursor: pointer; }
        .session-btn:has(input:checked) {
            background: #eaf2f8;
            border-color: var(--primary);
            color: var(--primary-dark);
            box-shadow: 0 2px 5px rgba(93, 173, 226, 0.2);
        }

        .quick-select-bar { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .btn-pill {
            padding: 8px 12px; background: #fff; border: 1px solid var(--text-light);
            border-radius: var(--radius-btn); color: var(--text-main); cursor: pointer;
            font-size: 0.85rem; font-weight: bold; flex-grow: 1; text-align: center;
        }
        .btn-pill:active { background: #f2f4f4; }

        select {
            width: 100%; padding: 12px; border-radius: 12px;
            border: 1px solid #d5dbdb; font-size: 1rem;
            background: white; color: var(--text-main); cursor: pointer;
        }

        .btn-big {
            width: 100%; padding: 15px; background: var(--primary); color: white;
            font-size: 1.3rem; font-weight: 800; border: none; border-radius: 15px;
            cursor: pointer; box-shadow: 0 4px 0 #2874a6; transition: 0.1s; margin-top: 20px;
        }
        .btn-big:active { transform: translateY(4px); box-shadow: none; }
        .btn-big:disabled { background: #bdc3c7; box-shadow: none; cursor: not-allowed; }

        /* --- ğŸ“ æ¸¬é©—ç•«é¢ --- */
        .progress-text { text-align: right; font-size: 1rem; color: var(--text-light); margin-bottom: 10px; }

        .card-container { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; }

        .flash-card {
            flex-grow: 1;
            background: #fff; border: 2px dashed #d5dbdb; border-radius: 15px;
            padding: 20px 10px; text-align: center;
            width: 100%; position: relative;
        }

        .word-row, .sentence-row { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; }
        
        .word-display { 
            font-size: clamp(2.5rem, 8vw, 5rem); 
            font-weight: 900; color: var(--primary-dark); line-height: 1.1; 
            word-break: break-word;
        }
        
        .sentence-display { 
            font-size: clamp(1rem, 4vw, 1.6rem); 
            font-weight: 500; color: #555; 
            background: #f8f9fa; padding: 15px; border-radius: 10px; line-height: 1.4; text-align: left;
            width: 100%;
        }

        /* ä¸»å‹•æœ—è®€æŒ‰éˆ• */
        .btn-auto-speak {
            background: var(--accent); color: white; border: none;
            padding: 10px 20px; border-radius: 30px; font-weight: bold; font-size: 1.1rem;
            cursor: pointer; box-shadow: 0 4px 0 #d68910; margin-bottom: 15px;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-auto-speak:active { transform: translateY(3px); box-shadow: none; }

        /* å°å–‡å­æŒ‰éˆ• */
        .btn-speak-small {
            background: #eaf2f8; border: none; color: var(--primary); width: 35px; height: 35px;
            border-radius: 50%; cursor: pointer; font-size: 1rem; display: flex; align-items: center;
            justify-content: center; flex-shrink: 0;
        }
        .btn-speak-small:active { transform: scale(0.9); background: var(--primary); color: white; }

        .timer-wrapper { display: flex; flex-direction: column; align-items: center; gap: 5px; min-width: 80px; }
        .timer-btn {
            width: 70px; height: 70px; background: white; border: 4px solid var(--accent); border-radius: 50%;
            display: flex; justify-content: center; align-items: center; font-size: 2rem; font-weight: 900;
            color: var(--accent); cursor: pointer; box-shadow: 0 4px 0 #d68910; transition: 0.1s;
        }
        .timer-btn:active { transform: translateY(3px); box-shadow: 0 1px 0 #d68910; }
        .timer-btn.ticking { color: var(--danger); border-color: var(--danger); box-shadow: 0 4px 0 #c0392b; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .timer-label { font-size: 0.8rem; font-weight: bold; color: var(--text-light); }

        .mistake-label { text-align: center; color: var(--danger); font-weight: bold; margin-bottom: 10px; font-size: 1rem; }
        
        .student-grid { 
            display: grid; gap: 10px; margin-bottom: 20px;
            grid-template-columns: repeat(5, 1fr); 
        }

        .btn-student {
            background: white; border: 2px solid #e5e8e8; border-radius: 12px;
            cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: 0.1s; box-shadow: 0 3px 0 #e5e8e8; padding: 10px 0; height: auto; aspect-ratio: 1/1;
        }
        .avatar { font-size: 2.5rem; margin-bottom: 0px; }
        .name { font-weight: 900; color: #7f8c8d; font-size: 1.2rem; }
        .btn-student:active { transform: translateY(3px); box-shadow: none; }
        .btn-student.marked-wrong { background: var(--danger); border-color: #c0392b; box-shadow: 0 3px 0 #c0392b; }
        .btn-student.marked-wrong .name { color: white; }

        .btn-next { background: var(--accent); box-shadow: 0 4px 0 #d68910; }

        @media (max-width: 600px) {
            .app-container { border-radius: 0; border: none; box-shadow: none; height: 100vh; }
            .screen { padding: 15px; }
            h1 { font-size: 1.1rem; }
            .card-container { flex-direction: column; }
            .timer-wrapper { flex-direction: row; width: 100%; justify-content: center; margin-top: -10px; }
            .timer-btn { width: 60px; height: 60px; font-size: 1.5rem; border-width: 3px; }
            .timer-label { margin-left: 10px; }
            .student-grid { grid-template-columns: repeat(3, 1fr); }
            .btn-big { font-size: 1.2rem; padding: 12px; }
            .word-display { font-size: 3rem; }
        }

        /* --- ğŸ“Š å ±è¡¨ & ç®¡ç†å€ --- */
        .table-container { max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 300px; }
        th { background: #eaf2f8; color: var(--primary-dark); padding: 10px; text-align: left; position: sticky; top: 0; font-size: 0.9rem; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .badge { background: var(--danger); color: white; padding: 3px 6px; border-radius: 8px; font-size: 0.75rem; font-weight: bold; }

        .error-box { background: #fadbd8; color: #922b21; padding: 10px; border-radius: 8px; display: none; margin-bottom: 15px; text-align: center; border: 1px solid #e6b0aa; font-size: 0.9rem; }
        
        .data-management-area {
            background: #eaf2f8; border: 2px solid #a9cce3; padding: 20px;
            border-radius: 15px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px;
            align-items: center;
        }
        .btn-download, .btn-backup { width: 100%; max-width: 100%; font-size: 1rem; padding: 12px; border:none; border-radius:30px; cursor:pointer; font-weight:bold; color:white; }
        .btn-download { background: var(--success); box-shadow:0 4px 0 #1e8449; }
        .btn-backup { background: var(--backup); box-shadow:0 4px 0 #6c3483; }
        .area-label { font-size: 0.85rem; font-weight: bold; color: #546e7a; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        
        .btn-clear { background: transparent; color: var(--danger); border: 2px solid var(--danger); padding: 8px 20px; border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 0.9rem; }

        /* --- ğŸ“– Modal --- */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative; max-height: 80vh; overflow-y: auto; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .help-section { margin-bottom: 20px; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
        .help-title { font-size: 1.1rem; color: var(--primary-dark); font-weight: bold; margin-bottom: 8px; }
        .help-text { font-size: 0.95rem; line-height: 1.5; color: #555; }
        .help-tag { background: #eee; padding: 2px 5px; border-radius: 4px; font-weight: bold; font-size: 0.85rem; }

    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div style="display:flex; align-items:center; gap:8px;">
            <span style="font-size:1.8rem;">ğŸ</span>
            <h1>æ™ºæ…§å°è€ƒå®˜</h1>
        </div>
        <div class="nav-group">
            <button class="nav-btn" onclick="showScreen('setupScreen')">ğŸ </button>
            <button class="nav-btn" onclick="showHistory()">ğŸ“Š</button>
            <button class="nav-btn" style="border-color:#f1c40f; color:#f1c40f;" onclick="openHelp()">â“</button>
            <a href="student.html" class="nav-btn" style="text-decoration:none; color:white; background:#48c9b0; border:none;">ğŸ“ å­¸ç”Ÿå€</a>
        </div>
    </header>

    <div id="setupScreen" class="screen active">
        <div id="loadError" class="error-box"><strong>âš ï¸ æ‰¾ä¸åˆ° words.js</strong><br>è«‹ç¢ºèªæª”æ¡ˆä½ç½®ã€‚</div>
        <div id="statusMsg" style="text-align:center; color:#999; margin-bottom:15px; font-size:0.9rem;">è³‡æ–™è¼‰å…¥ä¸­...</div>

        <div class="section-title">1. é¸æ“‡ç¯„åœ</div>
        <div class="session-panel">
            <div class="quick-select-bar">
                <button class="btn-pill" onclick="selectRange(1,5)">1~5</button>
                <button class="btn-pill" onclick="selectRange(6,10)">6~10</button>
                <button class="btn-pill" onclick="selectRange(11,16)">11~16</button>
                <button class="btn-pill" onclick="selectRange(1,16)">å…¨éƒ¨</button>
                <button class="btn-pill" onclick="clearSelection()" style="color:var(--danger); border-color:var(--danger); flex-grow:0;">æ¸…é™¤</button>
            </div>
            <div id="sessionGrid" class="session-grid"></div>
        </div>

        <div class="section-title">2. é¡Œæ•¸</div>
        <select id="wordCount">
            <option value="5">5 é¡Œ (æš–èº«)</option>
            <option value="10" selected>10 é¡Œ (æ¨™æº–)</option>
            <option value="20">20 é¡Œ (é€²éš)</option>
            <option value="30">30 é¡Œ (é«˜æ‰‹)</option>
            <option value="50">50 é¡Œ (ç¸½è¤‡ç¿’)</option>
        </select>

        <button id="startBtn" class="btn-big" onclick="startTest()" disabled>é–‹å§‹æ¸¬é©— â–¶</button>
    </div>

    <div id="testScreen" class="screen">
        <div class="progress-text">ç¬¬ <strong id="currentNum" style="color:var(--primary); font-size:1.2rem;">1</strong> / <span id="totalNum">10</span> é¡Œ</div>
        
        <div class="card-container">
            <div class="flash-card">
                <div style="text-align:center;">
                    <button class="btn-auto-speak" onclick="playQuestionSequence()">
                        ğŸ”Š æ’­æ”¾é¡Œç›® (å­—-å¥-å­—)
                    </button>
                </div>

                <div class="word-row">
                    <div class="word-display" id="displayWord">...</div>
                    <button class="btn-speak-small" onclick="speakText('word')">ğŸ”Š</button>
                </div>
                <div class="sentence-row">
                    <div class="sentence-display" id="displaySentence">...</div>
                    <button class="btn-speak-small" onclick="speakText('sentence')">ğŸ”Š</button>
                </div>
            </div>
            
            <div class="timer-wrapper">
                <button class="timer-btn" id="timerBtn" onclick="toggleTimer()">8</button>
                <div class="timer-label">å€’æ•¸</div>
            </div>
        </div>

        <div class="mistake-label">ğŸ‘‡ èª°ç­”éŒ¯äº†ï¼Ÿé»æ“Šæ¨™è¨˜ï¼š</div>
        
        <div class="student-grid">
            <div class="btn-student" id="btn-s1" onclick="toggleStudent(1)"><span class="avatar">ğŸƒ</span><span class="name">1</span></div>
            <div class="btn-student" id="btn-s2" onclick="toggleStudent(2)"><span class="avatar">ğŸ¦«</span><span class="name">2</span></div>
            <div class="btn-student" id="btn-s3" onclick="toggleStudent(3)"><span class="avatar">ğŸ¦¥</span><span class="name">3</span></div>
            <div class="btn-student" id="btn-s4" onclick="toggleStudent(4)"><span class="avatar">ğŸ¦›</span><span class="name">4</span></div>
            <div class="btn-student" id="btn-s5" onclick="toggleStudent(5)"><span class="avatar">ğŸ¨</span><span class="name">5</span></div>
        </div>

        <button class="btn-big btn-next" onclick="nextWord()">ä¸‹ä¸€é¡Œ â¡</button>
    </div>

    <div id="historyScreen" class="screen">
        <h2 style="text-align:center; color:var(--primary); margin-bottom:15px;">ğŸ“Š éŒ¯é¡Œä¸­å¿ƒ</h2>
        
        <div class="data-management-area">
            <div class="area-label">è³‡æ–™ç®¡ç†</div>
            <button class="btn-download" onclick="exportToCSV()">ğŸ“¥ åŒ¯å‡º Excel</button>
            <div style="display:flex; gap:10px; width:100%;">
                <button class="btn-backup" onclick="backupData()">ğŸ’¾ ä¸‹è¼‰å‚™ä»½</button>
                <button class="btn-backup" onclick="document.getElementById('fileInput').click()" style="background:#34495e; box-shadow:0 4px 0 #2c3e50;">ğŸ“‚ åŒ¯å…¥å‚™ä»½</button>
                <input type="file" id="fileInput" style="display:none" onchange="restoreData(this)">
            </div>
            <button class="btn-clear" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…ç©ºç´€éŒ„</button>
        </div>

        <div style="display:flex; flex-direction:column; gap:20px;">
            <div style="background:#f9f9f9; padding:15px; border-radius:15px;">
                <div class="section-title" style="margin-top:0;">ğŸ§‘â€ğŸ“ å­¸ç”Ÿæ’è¡Œæ¦œ</div>
                <select id="historyStudentSelect" onchange="renderStudentHistory()" style="margin-bottom:10px;">
                    <option value="1">ğŸƒ 1è™Ÿ (æ°´ç‰›)</option>
                    <option value="2">ğŸ¦« 2è™Ÿ (æ°´è±š)</option>
                    <option value="3">ğŸ¦¥ 3è™Ÿ (æ¨¹æ‡¶)</option>
                    <option value="4">ğŸ¦› 4è™Ÿ (æ²³é¦¬)</option>
                    <option value="5">ğŸ¨ 5è™Ÿ (ç„¡å°¾ç†Š)</option>
                </select>
                <div id="studentStatsTable" class="table-container"></div>
            </div>
            <div style="background:#f9f9f9; padding:15px; border-radius:15px;">
                <div class="section-title" style="margin-top:0;">ğŸš¨ å¸¸éŒ¯å–®å­— TOP 50</div>
                <div id="globalStatsTable" class="table-container"></div>
            </div>
        </div>
    </div>
</div>

<div id="helpModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeHelp()">&times;</span>
        <h2 style="color:var(--primary); text-align:center;">ğŸ“– ä½¿ç”¨æŒ‡å—</h2>
        <div class="help-section"><div class="help-title">ğŸ¯ åŠŸèƒ½ä»‹ç´¹</div><div class="help-text">æ•¸ä½è½å¯«å°å¹«æ‰‹ï¼Œæä¾›è‡ªå‹•æœ—è®€ã€éŒ¯é¡Œçµ±è¨ˆåŠŸèƒ½ã€‚</div></div>
        <div class="help-section"><div class="help-title">âš¡ æ“ä½œæµç¨‹</div><div class="help-text">1. é¸ç¯„åœã€é–‹å§‹æ¸¬é©—ã€‚<br>2. é»æ“Š <strong>ğŸ”Š æ’­æ”¾é¡Œç›®</strong> (å­—-å¥-å­—)ã€‚<br>3. å­¸ç”Ÿç­”éŒ¯é»æ“Šå‹•ç‰©é ­åƒã€‚<br>4. å…¨å°ç›´æ¥ä¸‹ä¸€é¡Œã€‚</div></div>
        <div class="help-section" style="border:none;"><div class="help-title">ğŸ’¾ å‚™ä»½èˆ‡é‚„åŸ</div><div class="help-text">è³‡æ–™å­˜åœ¨ç•¶å‰è£ç½®ã€‚æ›é›»è…¦å‰è«‹å…ˆ<span class="help-tag">ä¸‹è¼‰å‚™ä»½</span>ï¼Œå†åˆ°æ–°é›»è…¦<span class="help-tag">åŒ¯å…¥</span>ã€‚</div></div>
        <div style="text-align:center;"><button class="btn-big" style="width:auto; padding:10px 30px; font-size:1rem; margin-top:0;" onclick="closeHelp()">OKï¼</button></div>
    </div>
</div>

<script src="words.js" onerror="handleMissingFile()"></script>
<script>
    let db = [], testList = [], currentIndex = 0;
    let timerValue = 8, timerInterval = null, isTimerRunning = false;

    window.onload = function() { if (typeof masterWordList !== 'undefined') { db = masterWordList; initApp(); } else { if(document.getElementById('loadError').style.display === 'none') handleMissingFile(); } };
    function handleMissingFile() { document.getElementById('loadError').style.display = 'block'; document.getElementById('statusMsg').style.display = 'none'; }
    function initApp() {
        document.getElementById('statusMsg').innerText = `âœ… è¼‰å…¥ ${db.length} å–®å­—`; document.getElementById('statusMsg').style.color = 'var(--success)'; document.getElementById('startBtn').disabled = false;
        const sessions = [...new Set(db.map(x => x.session))].sort((a,b)=>a-b);
        const grid = document.getElementById('sessionGrid'); grid.innerHTML = '';
        sessions.forEach(s => { grid.innerHTML += `<label class="session-btn"><input type="checkbox" value="${s}" class="sess-cb"> U${s}</label>`; });
    }
    function openHelp() { document.getElementById('helpModal').style.display = 'block'; }
    function closeHelp() { document.getElementById('helpModal').style.display = 'none'; }
    window.onclick = function(e) { if (e.target == document.getElementById('helpModal')) closeHelp(); }
    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function selectRange(s, e) { document.querySelectorAll('.sess-cb').forEach(cb => { const v = parseInt(cb.value); if(!isNaN(v)) cb.checked = (v >= s && v <= e); }); }
    function clearSelection() { document.querySelectorAll('.sess-cb').forEach(cb => cb.checked = false); }
    
    function startTest() {
        const cbs = document.querySelectorAll('.sess-cb:checked');
        const sids = Array.from(cbs).map(cb => isNaN(parseInt(cb.value)) ? cb.value : parseInt(cb.value));
        if(sids.length === 0) { alert("è«‹é¸æ“‡å–®å…ƒï¼"); return; }
        const pool = db.filter(i => sids.includes(i.session));
        if(pool.length === 0) { alert("ç„¡å–®å­—"); return; }
        testList = [...pool].sort(() => 0.5 - Math.random()).slice(0, parseInt(document.getElementById('wordCount').value));
        currentIndex = 0; showScreen('testScreen'); document.getElementById('totalNum').innerText = testList.length; loadCard();
    }

    // --- ç™¼éŸ³åŠŸèƒ½ ---
    function speakText(type) {
        const item = testList[currentIndex];
        const text = (type === 'word') ? item.word : item.sentence;
        speak(text);
    }

    // æ ¸å¿ƒåŠŸèƒ½ï¼šå–®å­—-ä¾‹å¥-å–®å­—
    function playQuestionSequence() {
        const item = testList[currentIndex];
        window.speechSynthesis.cancel(); // åœæ­¢å…ˆå‰çš„ç™¼éŸ³
        
        const u1 = new SpeechSynthesisUtterance(item.word); u1.lang = 'en-US'; u1.rate = 0.8;
        const u2 = new SpeechSynthesisUtterance(item.sentence); u2.lang = 'en-US'; u2.rate = 0.8;
        const u3 = new SpeechSynthesisUtterance(item.word); u3.lang = 'en-US'; u3.rate = 0.8;

        window.speechSynthesis.speak(u1);
        window.speechSynthesis.speak(u2);
        window.speechSynthesis.speak(u3);
    }

    function speak(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; u.rate = 0.8;
        window.speechSynthesis.speak(u);
    }

    function toggleTimer() { if(isTimerRunning) resetTimer(); else startTimer(); }
    function startTimer() {
        if(isTimerRunning) return; isTimerRunning = true; timerValue = 8; updateTimerDisplay();
        document.getElementById('timerBtn').classList.add('ticking');
        timerInterval = setInterval(() => {
            timerValue--; updateTimerDisplay();
            if(timerValue <= 0) { clearInterval(timerInterval); playDing(); isTimerRunning = false; document.getElementById('timerBtn').classList.remove('ticking'); }
        }, 1000);
    }
    function resetTimer() { clearInterval(timerInterval); isTimerRunning = false; timerValue = 8; document.getElementById('timerBtn').innerText = "8"; document.getElementById('timerBtn').classList.remove('ticking'); }
    function updateTimerDisplay() { document.getElementById('timerBtn').innerText = timerValue; }
    function playDing() {
        const AC = window.AudioContext || window.webkitAudioContext; if (!AC) return; 
        const ctx = new AC(); const osc = ctx.createOscillator(); const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination); osc.type = "sine";
        osc.frequency.setValueAtTime(1200, ctx.currentTime); osc.frequency.exponentialRampToValueAtTime(600, ctx.currentTime + 0.5);
        gain.gain.setValueAtTime(0.5, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
        osc.start(); osc.stop(ctx.currentTime + 0.5);
    }

    function loadCard() {
        resetTimer(); const item = testList[currentIndex];
        document.getElementById('currentNum').innerText = currentIndex + 1;
        document.getElementById('displayWord').innerText = item.word;
        document.getElementById('displaySentence').innerText = item.sentence;
        for(let i=1; i<=5; i++) document.getElementById(`btn-s${i}`).classList.remove('marked-wrong');
    }
    function toggleStudent(id) { document.getElementById(`btn-s${id}`).classList.toggle('marked-wrong'); }
    function nextWord() {
        const w = testList[currentIndex]; const d = new Date().toLocaleDateString('zh-TW');
        for(let i=1; i<=5; i++) { if (document.getElementById(`btn-s${i}`).classList.contains('marked-wrong')) saveMistake(i, w, d); }
        currentIndex++; if(currentIndex < testList.length) loadCard(); else { alert("æ¸¬é©—çµæŸï¼"); showHistory(); }
    }
    function saveMistake(sid, w, d) {
        let h = JSON.parse(localStorage.getItem('spellingHistory')) || [];
        h.push({ student: sid, word: w.word, session: w.session, sentence: w.sentence, date: d });
        localStorage.setItem('spellingHistory', JSON.stringify(h));
    }
    function getHistory() { return JSON.parse(localStorage.getItem('spellingHistory')) || []; }
    function showHistory() { showScreen('historyScreen'); renderStudentHistory(); renderGlobalStats(); }
    
    function renderStudentHistory() {
        const sid = parseInt(document.getElementById('historyStudentSelect').value);
        const h = getHistory().filter(x => x.student === sid);
        const c = document.getElementById('studentStatsTable');
        if(h.length === 0) { c.innerHTML = "<p style='color:#999;text-align:center;padding:10px;'>ç„¡ç´€éŒ„</p>"; return; }
        let counts = {}; h.forEach(x => { if(!counts[x.word]) counts[x.word]={count:0,s:x.session}; counts[x.word].count++; });
        let s = Object.keys(counts).map(k => ({w:k, ...counts[k]})).sort((a,b)=>b.count-a.count);
        let html = `<table><tr><th>æ¬¡</th><th>å­—</th><th>U</th></tr>`;
        s.forEach(i => { html += `<tr><td><span class="badge">${i.count}</span></td><td style="font-weight:bold;">${i.w}</td><td>${i.s}</td></tr>`; });
        c.innerHTML = html + "</table>";
    }
    function renderGlobalStats() {
        const h = getHistory(); const c = document.getElementById('globalStatsTable');
        if(h.length === 0) { c.innerHTML = "<p style='color:#999;text-align:center;padding:10px;'>ç„¡è³‡æ–™</p>"; return; }
        let counts = {}; h.forEach(x => { if(!counts[x.word]) counts[x.word]=0; counts[x.word]++; });
        let s = Object.keys(counts).map(k => ({w:k, c:counts[k]})).sort((a,b)=>b.c-a.c).slice(0,50);
        let html = `<table><tr><th>éŒ¯</th><th>å­—</th></tr>`;
        s.forEach(i => { html += `<tr><td><span class="badge" style="background:var(--primary);">${i.c}</span></td><td style="font-weight:bold;">${i.w}</td></tr>`; });
        c.innerHTML = html + "</table>";
    }
    function exportToCSV() {
        const h = getHistory(); if(h.length === 0) { alert("ç„¡è³‡æ–™"); return; }
        const n = {1:"æ°´ç‰›", 2:"æ°´è±š", 3:"æ¨¹æ‡¶", 4:"æ²³é¦¬", 5:"ç„¡å°¾ç†Š"};
        let csv = "data:text/csv;charset=utf-8,\uFEFFæ—¥æœŸ,å­¸ç”Ÿ,ä»£è™Ÿ,å–®å…ƒ,å–®å­—,ä¾‹å¥\n";
        h.forEach(r => { csv += `${r.date},${n[r.student]},${r.student},${r.session},${r.word},${(r.sentence||"").replace(/,/g,"ï¼Œ")}\n`; });
        const a = document.createElement("a"); a.href = encodeURI(csv); a.download = "éŒ¯é¡Œç´€éŒ„.csv"; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    function backupData() {
        const h = getHistory(); if(h.length === 0) { alert("ç„¡è³‡æ–™"); return; }
        const a = document.createElement("a"); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(h));
        a.download = "spelling_backup.json"; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    function restoreData(input) {
        const f = input.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = function(e) {
            try { const d = JSON.parse(e.target.result);
                if(Array.isArray(d)) { localStorage.setItem('spellingHistory', JSON.stringify(getHistory().concat(d))); alert("åŒ¯å…¥æˆåŠŸï¼"); showHistory(); }
            } catch(err) { alert("æª”æ¡ˆéŒ¯èª¤"); }
        }; r.readAsText(f); input.value = '';
    }
    function clearHistory() { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { localStorage.removeItem('spellingHistory'); showHistory(); } }
</script>
</body>
</html>