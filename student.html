<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¸ç”Ÿè‡ªä¸»å­¸ç¿’å¹³æ¿ v45.1 (Achievement Hints)</title>
    <style>
        /* --- ğŸ¨ è¦–è¦ºé¢¨æ ¼ï¼šé«˜å°æ¯”ã€æ˜ç¢ºæŒ‰éˆ• --- */
        :root {
            --bg-color: #a8dadc;
            --panel-bg: #ffffff;
            --primary: #457b9d;
            --accent: #e63946;
            --text-main: #1d3557;
            --border-color: #1d3557;
            
            /* ç¨€æœ‰åº¦é¡è‰² */
            --tier-common: #cd7f32;
            --tier-rare: #95a5a6;
            --tier-epic: #ffb300;
            --tier-legend: #9b59b6;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Microsoft JhengHei', sans-serif; }
        
        body { 
            background-color: var(--bg-color); 
            color: var(--text-main); margin: 0; padding: 20px; 
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; 
        }

        /* --- é é¢åˆ‡æ›ç‰¹æ•ˆ --- */
        .screen { display: none; width: 100%; max-width: 700px; animation: fadeIn 0.3s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- æŒ‰éˆ•è¨­è¨ˆ --- */
        .btn-solid {
            background: #fff; border: 3px solid var(--border-color); border-radius: 12px;
            padding: 12px 20px; font-size: 1.1rem; font-weight: 900; color: var(--text-main);
            cursor: pointer; box-shadow: 0 4px 0 var(--border-color); transition: all 0.1s;
            display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%;
        }
        .btn-solid:active { transform: translateY(4px); box-shadow: 0 0 0 var(--border-color); }
        
        .btn-green { background: #d4edda; border-color: #155724; color: #155724; box-shadow: 0 4px 0 #155724; }
        .btn-green:active { box-shadow: 0 0 0 #155724; }
        .btn-yellow { background: #fff3cd; border-color: #856404; color: #856404; box-shadow: 0 4px 0 #856404; }
        .btn-yellow:active { box-shadow: 0 0 0 #856404; }
        .btn-red { background: #f8d7da; border-color: #721c24; color: #721c24; box-shadow: 0 4px 0 #721c24; }
        .btn-red:active { box-shadow: 0 0 0 #721c24; }

        .white-panel { background: white; border: 3px solid var(--border-color); border-radius: 16px; padding: 20px; box-shadow: 0 6px 0 rgba(0,0,0,0.1); margin-bottom: 20px; }
        .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .page-title { font-size: 1.8rem; font-weight: 900; color: var(--text-main); margin: 0; text-shadow: 1px 1px 0 #fff; }

        /* --- 1. é¦–é  --- */
        .hero-banner { text-align: center; margin-bottom: 30px; margin-top: 10px; }
        .hero-title { font-size: 2.5rem; font-weight: 900; color: #1d3557; margin-bottom: 5px; }
        .hero-sub { background: white; padding: 5px 15px; border-radius: 20px; border: 2px solid var(--border-color); display: inline-block; font-weight: bold; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .dash-btn {
            background: white; border: 3px solid var(--border-color); border-radius: 20px;
            padding: 20px 10px; text-align: center; cursor: pointer;
            box-shadow: 0 6px 0 var(--border-color); transition: 0.1s; display: flex; flex-direction: column; align-items: center;
        }
        .dash-btn:active { transform: translateY(6px); box-shadow: 0 0 0; }
        .dash-icon { font-size: 3.5rem; margin-bottom: 10px; }
        .dash-btn h2 { font-size: 1.4rem; margin: 0; color: var(--text-main); font-weight: 900; }
        .dash-btn p { font-size: 0.9rem; color: #666; margin: 5px 0 0; font-weight: bold; }
        .dash-btn.study { border-color: #2e7d32; box-shadow: 0 6px 0 #2e7d32; }
        .dash-btn.study h2 { color: #2e7d32; }
        .dash-btn.quiz { border-color: #d84315; box-shadow: 0 6px 0 #d84315; }
        .dash-btn.quiz h2 { color: #d84315; }

        /* --- ç¨±è™Ÿç³»çµ± (Updated) --- */
        .achievement-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        
        .badge-card {
            /* é–å®šç‹€æ…‹æ¨£å¼ */
            background: #f0f0f0; 
            border: 3px dashed #bbb; /* è™›ç·šä»£è¡¨æœªç²å¾— */
            border-radius: 15px; 
            padding: 15px 10px; 
            text-align: center;
            opacity: 1; /* å–æ¶ˆé€æ˜åº¦ï¼Œè®“å­—æ¸…æ¥š */
            position: relative;
        }
        
        /* é–å®šæ™‚çš„æç¤ºæ–‡å­— */
        .badge-hint-box {
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
            padding: 5px;
            margin-top: 5px;
            font-size: 0.8rem;
            color: #666;
            font-weight: bold;
        }
        
        /* è§£é–ç‹€æ…‹ */
        .badge-card.unlocked { 
            opacity: 1; 
            border-style: solid; /* å¯¦ç·š */
            border-width: 3px;
            border-color: var(--gold); 
            background: #fffde7; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.1); 
        }
        
        /* ç¨€æœ‰åº¦æ¡†è‰² */
        .badge-card.unlocked.common { border-color: var(--tier-common); background: #fff; }
        .badge-card.unlocked.rare { border-color: var(--tier-rare); background: #f8f9fa; }
        .badge-card.unlocked.epic { border-color: var(--tier-epic); background: #fffbe6; }
        .badge-card.unlocked.legendary { border-color: var(--tier-legend); background: #f3e5f5; }

        .badge-icon { font-size: 3rem; margin-bottom: 5px; display: block; }
        .badge-title { font-weight: 900; font-size: 1rem; margin-bottom: 5px; color: var(--text-main); }
        .badge-desc { font-size: 0.8rem; color: #555; line-height: 1.2; }
        
        .category-header {
            grid-column: 1 / -1;
            font-size: 1.1rem;
            font-weight: 900;
            margin: 20px 0 10px 0;
            padding: 5px 10px;
            background: var(--text-main);
            color: white;
            border-radius: 20px;
            width: fit-content;
        }

        /* --- å…¶ä»–æ¨£å¼ä¿ç•™ --- */
        .unit-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
        .unit-card { background: white; border: 2px solid #ccc; border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; transition: 0.2s; }
        .unit-card:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .unit-card h3 { margin: 0; font-size: 1.3rem; color: var(--text-main); }
        .unit-card .action-hint { font-size: 0.8rem; color: var(--primary); margin-top: 5px; font-weight: bold; }
        .word-overview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; padding-bottom: 100px; }
        .word-overview-card { background: white; border: 2px solid #ddd; border-radius: 12px; padding: 20px 10px; text-align: center; cursor: pointer; position: relative; }
        .word-overview-card:hover { border-color: var(--primary); background: #f0f9ff; }
        .word-overview-card h4 { margin: 0; font-size: 1.2rem; font-weight: bold; }
        .word-overview-card.read { background: #e8f5e9; border-color: #66bb6a; }
        .word-overview-card.read::after { content: "âœ” å·²è®€"; position: absolute; top: 5px; right: 5px; color: #2e7d32; font-size: 0.7rem; font-weight: bold; }
        .detail-container { text-align: center; display: flex; flex-direction: column; align-items: center; }
        .detail-word { font-size: 3.5rem; font-weight: 900; color: var(--text-main); margin: 10px 0; }
        .detail-zh { font-size: 1.6rem; color: #555; margin-bottom: 30px; font-weight: bold; }
        .audio-btn-big { width: 70px; height: 70px; border-radius: 50%; background: var(--primary); color: white; border: 4px solid #1d3557; display: flex; align-items: center; justify-content: center; font-size: 2rem; cursor: pointer; box-shadow: 0 4px 0 #1d3557; margin-bottom: 30px; }
        .audio-btn-big:active { transform: translateY(4px); box-shadow: 0 0 0; }
        .detail-sent-box { background: #f1f1f1; padding: 20px; border-radius: 15px; width: 100%; text-align: left; border-left: 6px solid var(--primary); }
        .detail-sent-en { font-size: 1.3rem; font-weight: bold; color: #333; margin-bottom: 8px; }
        .detail-sent-zh { font-size: 1.1rem; color: #666; }
        .nav-controls { display: flex; justify-content: space-between; width: 100%; margin-top: 30px; gap: 20px; }
        .nav-controls button { flex: 1; }
        .setup-row { margin-bottom: 20px; }
        .setup-label { font-weight: 900; font-size: 1.1rem; margin-bottom: 8px; display: block; }
        .toggle-group { display: flex; gap: 10px; }
        .toggle-btn { flex: 1; padding: 15px; border: 2px solid #ccc; background: white; border-radius: 12px; font-weight: bold; color: #777; cursor: pointer; font-size: 1rem; }
        .toggle-btn.active { border-color: var(--primary); background: #e3f2fd; color: var(--primary); box-shadow: 0 0 0 2px var(--primary) inset; }
        .range-selector { display: flex; flex-wrap: wrap; gap: 10px; max-height: 200px; overflow-y: auto; margin-top: 10px; }
        .range-btn { padding: 10px 15px; border-radius: 20px; border: 2px solid #ddd; background: white; cursor: pointer; font-weight: bold; color: #555; }
        .range-btn.selected { border-color: var(--accent); background: #fff3e0; color: #e65100; }
        .quiz-status { display: flex; justify-content: space-between; font-weight: bold; color: #666; margin-bottom: 10px; }
        .q-hint { font-size: 1.4rem; font-weight: 900; color: var(--text-main); margin: 20px 0; min-height: 1.5em; }
        .choice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-choice { background: white; border: 3px solid #ccc; border-radius: 15px; padding: 20px; font-size: 1.2rem; font-weight: bold; color: var(--text-main); cursor: pointer; box-shadow: 0 4px 0 #ccc; transition: 0.1s; }
        .btn-choice:active { transform: translateY(4px); box-shadow: 0 0 0; }
        .btn-choice.correct { background: #d4edda; border-color: #155724; color: #155724; box-shadow: 0 4px 0 #155724; }
        .btn-choice.wrong { background: #f8d7da; border-color: #721c24; color: #721c24; box-shadow: 0 4px 0 #721c24; }
        .input-spelling { width: 100%; padding: 15px; font-size: 1.8rem; text-align: center; border: 3px solid var(--text-main); border-radius: 12px; margin-bottom: 15px; }
        .weak-stats-card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .weak-header { font-size: 1.2rem; font-weight: bold; color: var(--danger); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .top-weak-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
        .weak-item-card { background: #fff5f5; border: 1px solid #ffcdd2; border-radius: 12px; padding: 15px; min-width: 100px; text-align: center; flex-shrink: 0; }
        .weak-word { font-size: 1.2rem; font-weight: 900; color: var(--danger); display: block; }
        .weak-count { font-size: 0.8rem; color: #888; margin-top: 5px; }
        .full-mistake-list { max-height: 300px; overflow-y: auto; }
        .mistake-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px dashed #eee; }
        .rank-num { font-weight: 900; color: #ccc; width: 30px; font-style: italic; }
        .rank-num.top1 { color: #f1c40f; font-size: 1.2rem; }
        .rank-num.top2 { color: #95a5a6; font-size: 1.1rem; }
        .rank-num.top3 { color: #d35400; font-size: 1.1rem; }
        .mistake-word { font-weight: bold; font-size: 1.1rem; flex: 1; text-align: left; }
        .mistake-val { color: var(--danger); font-weight: bold; background: #ffebee; padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; }
        .toast-notification { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: white; padding: 15px 25px; border-radius: 50px; border: 3px solid var(--gold); z-index: 2000; display: flex; align-items: center; gap: 15px; transition: top 0.5s; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .toast-notification.show { top: 30px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; }
        .modal-content { background: white; margin: 10% auto; padding: 25px; width: 90%; max-width: 500px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-height: 80vh; overflow-y: auto; }

    </style>
</head>
<body>

    <div id="toastNotification" class="toast-notification">
        <div style="font-size:2rem;">ğŸ†</div>
        <div>
            <h4 style="margin:0; color:var(--text-main);">æ­å–œç²å¾—ç¨±è™Ÿï¼</h4>
            <p id="toastMsg" style="margin:0; color:var(--accent); font-weight:bold;">å–®å­—å°å­¸å¾’</p>
        </div>
    </div>

    <div id="homeScreen" class="screen active">
        <div class="hero-banner">
            <div class="hero-title">æ™ºæ…§å–®å­—å°è€ƒå®˜</div>
            <div class="hero-sub">ä»Šå¤©æƒ³åšä»€éº¼å‘¢ï¼Ÿ</div>
        </div>

        <div class="dashboard-grid">
            <button class="dash-btn study" onclick="openUnitSelector('study')">
                <span class="dash-icon">ğŸ“–</span>
                <h2>æˆ‘è¦èƒŒå–®å­—</h2>
                <p>ç€è¦½å–®å­—å¡ã€è½ç™¼éŸ³</p>
            </button>
            <button class="dash-btn quiz" onclick="openQuizSetup()">
                <span class="dash-icon">âœï¸</span>
                <h2>æˆ‘è¦æ¸¬é©—</h2>
                <p>æŒ‘æˆ°é¡Œç›®ã€æ‹šé€Ÿåº¦</p>
            </button>
        </div>

        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn-solid" onclick="openAchievementScreen()">ğŸ† ç¨±è™Ÿè’é›†</button>
            <button class="btn-solid" onclick="openAnalysisScreen()">ğŸ“Š å¼±é»åˆ†æ</button>
        </div>
    </div>

    <div id="unitSelectScreen" class="screen">
        <div class="page-header">
            <button class="btn-solid" style="width:auto;" onclick="goHome()">â¬… å›é¦–é </button>
            <h2 class="page-title">é¸æ“‡å–®å…ƒ</h2>
            <div style="width: 80px;"></div>
        </div>
        <div id="unitGridContainer" class="unit-grid"></div>
    </div>

    <div id="studyOverviewScreen" class="screen">
        <div class="page-header">
            <button class="btn-solid" style="width:auto;" onclick="openUnitSelector('study')">â¬… å›é¸å–®</button>
            <h2 class="page-title" id="overviewTitle">Unit A</h2>
            <div style="width:60px;"></div>
        </div>
        <div style="text-align:center; color:#666; margin-bottom:15px; font-weight:bold;">ğŸ‘‡ é»æ“Šå–®å­—å¡é–‹å§‹å­¸ç¿’</div>
        <div id="overviewGrid" class="word-overview-grid"></div>
        <div style="position:fixed; bottom:20px; left:50%; transform:translateX(-50%); width:90%; max-width:600px;">
            <button class="btn-solid btn-green" onclick="quickQuizFromStudy()">âš¡ èƒŒå®Œäº†ï¼é¦¬ä¸Šæ¸¬é©—æ­¤å–®å…ƒ</button>
        </div>
    </div>

    <div id="studyDetailScreen" class="screen">
        <div class="page-header">
            <button class="btn-solid" style="width:auto;" onclick="backToOverview()">â¬… å›åˆ—è¡¨</button>
            <div style="font-weight:bold; color:#777;">Word <span id="detailIdx">1</span> / <span id="detailTotal">20</span></div>
            <div style="width:80px;"></div>
        </div>

        <div class="white-panel detail-container">
            <div class="detail-word" id="cardWord">Apple</div>
            <div class="detail-zh" id="cardZh">è˜‹æœ</div>
            
            <button class="audio-btn-big" onclick="playCurrentCardAudio()">ğŸ”Š</button>

            <div class="detail-sent-box">
                <div class="detail-sent-en" id="cardSentEn">I eat an apple.</div>
                <div class="detail-sent-zh" id="cardSentZh">æˆ‘åƒä¸€é¡†è˜‹æœã€‚</div>
                <button class="btn-icon" style="float:right; margin-top:-30px; color:var(--primary);" onclick="playCurrentCardSent()">ğŸ”Š</button>
            </div>

            <div class="nav-controls">
                <button class="btn-solid" onclick="prevCard()">â—€ ä¸Šä¸€å€‹</button>
                <button class="btn-solid" onclick="nextCard()">ä¸‹ä¸€å€‹ â–¶</button>
            </div>
        </div>
    </div>

    <div id="quizSetupScreen" class="screen">
        <div class="page-header">
            <button class="btn-solid" style="width:auto;" onclick="goHome()">â¬… å›é¦–é </button>
            <h2 class="page-title">æ¸¬é©—è¨­å®š</h2>
            <div style="width:80px;"></div>
        </div>

        <div class="white-panel">
            <div class="setup-row">
                <span class="setup-label">1. é¸æ“‡é¡Œå‹</span>
                <div class="toggle-group">
                    <button class="toggle-btn active" id="modeChoice" onclick="setQuizMode('choice')">ğŸ‘† é¸æ“‡é¡Œ</button>
                    <button class="toggle-btn" id="modeSpelling" onclick="setQuizMode('spelling')">âŒ¨ï¸ æ‹¼å­—é¡Œ</button>
                </div>
            </div>
        </div>

        <div class="white-panel">
            <div class="setup-row" style="display:flex; justify-content:space-between;">
                <span class="setup-label">2. é¸æ“‡ç¯„åœ (å¯è¤‡é¸)</span>
                <button class="btn-icon" style="color:var(--danger); font-size:1rem; font-weight:bold;" onclick="clearAllSelectedWords()">[æ¸…ç©º]</button>
            </div>
            <div style="margin-bottom:10px;">ç›®å‰å·²é¸ï¼š<b id="totalSelectedCount" style="color:var(--primary); font-size:1.2rem;">0</b> å€‹å­—</div>
            <div id="quizRangeGrid" class="range-selector"></div>
        </div>

        <div class="white-panel">
            <span class="setup-label">3. é€²éšè¨­å®š</span>
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:15px;">
                <span>è‡ªå‹•æ›é¡Œ (ç­”å°å¾Œè‡ªå‹•ä¸‹ä¸€é¡Œ)</span>
                <input type="checkbox" id="autoNextSwitch" checked style="transform:scale(1.5);">
            </div>
            <div style="display:flex; align-items:center; justify-content:space-between;">
                <span>é™æ™‚æŒ‘æˆ° (æ¯é¡Œ8ç§’)</span>
                <input type="checkbox" id="timerSwitch" style="transform:scale(1.5);">
            </div>
        </div>

        <button class="btn-solid btn-red" onclick="startConfiguredQuiz()">ğŸš€ é–‹å§‹æ¸¬é©—</button>
    </div>

    <div id="wordPickerModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="pickerTitle" style="margin:0;">æŒ‘é¸å–®å­—</h3>
                <span style="font-size:1.5rem; cursor:pointer;" onclick="closeWordPicker()">Ã—</span>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="btn-solid" style="padding:5px 10px; font-size:0.9rem;" onclick="pickerSelectViewed()">åƒ…é¸å·²è®€</button>
                <button class="btn-solid" style="padding:5px 10px; font-size:0.9rem;" onclick="pickerSelectAll()">å…¨é¸</button>
                <button class="btn-solid" style="padding:5px 10px; font-size:0.9rem;" onclick="pickerSelectNone()">å…¨å–æ¶ˆ</button>
            </div>
            <div id="pickerGrid" class="word-picker-container"></div>
            
            <div id="btnPickerSave" style="margin-top:20px;">
                <button class="btn-solid btn-green" onclick="closeWordPicker()">å®Œæˆé¸å–</button>
            </div>
            <div id="btnPickerQuickStart" style="display:none; gap:10px; margin-top:20px;">
                <button class="btn-solid btn-green" onclick="startQuickQuizDirect('choice')">é–‹å§‹é¸æ“‡é¡Œ</button>
                <button class="btn-solid btn-yellow" onclick="startQuickQuizDirect('spelling')">é–‹å§‹æ‹¼å­—é¡Œ</button>
            </div>
        </div>
    </div>

    <div id="quizScreen" class="screen">
        <div class="quiz-status">
            <span>ç¬¬ <span id="qIdx">1</span> / <span id="qTotal">10</span> é¡Œ</span>
            <span id="timerBadge" style="color:var(--danger); display:none;">â±ï¸ <span id="timeLeft">8</span></span>
            <button style="border:none; background:none; font-weight:bold; color:#888;" onclick="quitQuiz()">é›¢é–‹</button>
        </div>

        <div class="white-panel" style="text-align:center; padding:40px 20px;">
            <div style="font-size:4rem; cursor:pointer;" onclick="playQuizSequence()">ğŸ”Š</div>
            <div id="qHint" class="q-hint" style="display:none; margin-top:20px; font-size:1.5rem; font-weight:bold; color:var(--text-main);"></div>
            <button id="btnShowHint" class="btn-solid" style="margin-top:20px; width:auto; display:inline-block;" onclick="showHint()">ğŸ’¡ é¡¯ç¤ºä¸­æ–‡æç¤º</button>
        </div>

        <div id="choiceArea" class="choice-grid" style="display:none;"></div>

        <div id="spellingArea" style="display:none; text-align:center;">
            <input type="text" id="spellingInput" class="input-spelling" placeholder="è«‹è¼¸å…¥å–®å­—..." autocomplete="off" style="width:100%; padding:15px; font-size:1.5rem; text-align:center; border:3px solid #ccc; border-radius:12px; margin-bottom:15px;">
            <div id="spellingFeedback" style="height:25px; font-weight:bold; margin-bottom:10px; font-size:1.2rem;"></div>
            <button class="btn-solid btn-green" onclick="checkSpelling()">é€å‡ºç­”æ¡ˆ</button>
        </div>

        <button id="btnNextQ" class="btn-solid" style="margin-top:20px; display:none;" onclick="nextQuestion()">â¡ ä¸‹ä¸€é¡Œ</button>
    </div>

    <div id="resultScreen" class="screen">
        <div class="white-panel" style="text-align:center; padding:40px;">
            <div style="font-size:5rem;">ğŸ†</div>
            <h2 style="font-size:2rem; margin:10px 0;">æ¸¬é©—å®Œæˆï¼</h2>
            <div id="finalScore" style="font-size:4rem; font-weight:900; color:var(--primary); margin:20px 0;">100</div>
            <p id="finalMsg" style="font-size:1.2rem; color:#666; margin-bottom:40px;">å¤ªå²å®³äº†ï¼</p>
            
            <button class="btn-solid btn-green" style="margin-bottom:15px;" onclick="goHome()">ğŸ  å›é¦–é </button>
            <button class="btn-solid" onclick="retryQuiz()">ğŸ”„ å†æ¸¬ä¸€æ¬¡</button>
        </div>
    </div>

    <div id="achievementScreen" class="screen">
        <div class="page-header">
            <button class="btn-solid" style="width:auto;" onclick="goHome()">â¬… å›é¦–é </button>
            <h2 class="page-title">ç¨±è™Ÿè’é›†</h2>
            <div style="width:80px;"></div>
        </div>
        <div class="achievement-container">
            <div id="badgeGrid" class="achievement-grid"></div>
        </div>
    </div>

    <div id="analysisScreen" class="screen">
        <div class="page-header">
            <button class="btn-solid" style="width:auto;" onclick="goHome()">â¬… å›é¦–é </button>
            <h2 class="page-title">å¼±é»åˆ†æ</h2>
            <div style="width:80px;"></div>
        </div>
        <div class="white-panel">
            <div style="font-weight:bold; color:var(--danger); margin-bottom:10px;">âš ï¸ æœ€å¸¸éŒ¯ Top 3</div>
            <div id="topWeakList" style="display:flex; gap:10px; overflow-x:auto;"></div>
        </div>
        <div class="white-panel">
            <div style="font-weight:bold; margin-bottom:10px;">ğŸ“ éŒ¯é¡Œåˆ—è¡¨</div>
            <div id="fullMistakeList" class="full-mistake-list" style="max-height:250px; overflow-y:auto;"></div>
        </div>
        <button class="btn-solid btn-red" onclick="startTop30WeaknessQuiz()">ğŸ”¥ æŒ‘æˆ° Top 30 å¸¸éŒ¯å­—</button>
    </div>

<script src="words.js"></script>
<script>
    let sessions = [];
    let viewedWords = new Set(); 
    let studyData = { sid: null, list: [], currentIndex: 0 };
    let quizConfig = { mode: 'choice', selectedWords: new Set(), timer: false, autoNext: true };
    let quizData = { list: [], index: 0, score: 0, timerId: null };
    let currentPickerSid = null;
    let isQuickQuizPicker = false; 
    
    let userStats = { wordsViewedCount: 0, quizCount: 0, totalCorrect: 0, totalMistakes: 0 };
    let unlockedTitles = new Set();

    // ğŸ† v43.0 ç¨±è™Ÿè³‡æ–™åº« (Expanded)
    const achievements = [
        { id: 'view_5', category: 'learn', tier: 'common', icon: 'ğŸªµ', title: 'å–®å­—å°èŒæ–°', desc: 'çœ‹é 5 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 5 },
        { id: 'view_20', category: 'learn', tier: 'common', icon: 'ğŸ•¯ï¸', title: 'å……æ»¿å¥½å¥‡', desc: 'çœ‹é 20 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 20 },
        { id: 'view_50', category: 'learn', tier: 'common', icon: 'ğŸ“œ', title: 'ç´¯ç©å¯¦åŠ›', desc: 'çœ‹é 50 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 50 },
        { id: 'view_80', category: 'learn', tier: 'rare', icon: 'ğŸ““', title: 'æ¼¸å…¥ä½³å¢ƒ', desc: 'çœ‹é 80 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 80 },
        { id: 'view_100', category: 'learn', tier: 'rare', icon: 'ğŸ“˜', title: 'è¨˜æ†¶è¶…äºº', desc: 'çœ‹é 100 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 100 },
        { id: 'view_200', category: 'learn', tier: 'rare', icon: 'ğŸ“', title: 'åšå­¸å¤šè', desc: 'çœ‹é 200 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 200 },
        { id: 'view_300', category: 'learn', tier: 'epic', icon: 'ğŸ”®', title: 'å–®å­—ç‹è€…', desc: 'çœ‹é 300 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 300 },
        { id: 'view_500', category: 'learn', tier: 'epic', icon: 'ğŸ§™â€â™‚ï¸', title: 'è¡Œèµ°å­—å…¸', desc: 'çœ‹é 500 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 500 },
        { id: 'view_all', category: 'learn', tier: 'legendary', icon: 'ğŸª', title: 'å…¨çŸ¥å…¨èƒ½', desc: 'çœ‹éæ‰€æœ‰å–®å­— (800+)', check: (s) => s.wordsViewedCount >= 800 },
        { id: 'unit_1', category: 'unit', tier: 'common', icon: 'ğŸš©', title: 'åˆæˆ°å‘Šæ·', desc: 'å®Œæˆ 1 å€‹å–®å…ƒ', check: () => checkUnitsCompleted(1) },
        { id: 'unit_3', category: 'unit', tier: 'rare', icon: 'â›º', title: 'ä¸‰å…ƒåŠç¬¬', desc: 'å®Œæˆ 3 å€‹å–®å…ƒ', check: () => checkUnitsCompleted(3) },
        { id: 'unit_5', category: 'unit', tier: 'rare', icon: 'ğŸ›–', title: 'äº”æ˜Ÿä¸Šå°‡', desc: 'å®Œæˆ 5 å€‹å–®å…ƒ', check: () => checkUnitsCompleted(5) },
        { id: 'unit_10', category: 'unit', tier: 'epic', icon: 'ğŸ°', title: 'åå…¨åç¾', desc: 'å®Œæˆ 10 å€‹å–®å…ƒ', check: () => checkUnitsCompleted(10) },
        { id: 'unit_all', category: 'unit', tier: 'legendary', icon: 'ğŸ‘‘', title: 'åˆ¶éœ¸å…¨åœ‹', desc: 'å®Œæˆæ‰€æœ‰å–®å…ƒ', check: () => checkUnitsCompleted(sessions.length) },
        { id: 'alpha_1', category: 'alpha', tier: 'common', icon: 'ğŸ§©', title: 'å­—æ¯æœé›†', desc: 'å®Œæˆ 1 å€‹å­—æ¯', check: () => checkLettersCompleted(1) },
        { id: 'alpha_3', category: 'alpha', tier: 'rare', icon: 'ğŸ§±', title: 'æ‹¼å­—æ‹¼åœ–', desc: 'å®Œæˆ 3 å€‹å­—æ¯', check: () => checkLettersCompleted(3) },
        { id: 'alpha_5', category: 'alpha', tier: 'rare', icon: 'ğŸ—ï¸', title: 'èªå½™çµäºº', desc: 'å®Œæˆ 5 å€‹å­—æ¯', check: () => checkLettersCompleted(5) },
        { id: 'alpha_10', category: 'alpha', tier: 'epic', icon: 'ğŸ›ï¸', title: 'å­—æ¯å¤§äº¨', desc: 'å®Œæˆ 10 å€‹å­—æ¯', check: () => checkLettersCompleted(10) },
        { id: 'quiz_1', category: 'quiz', tier: 'common', icon: 'ğŸ—¡ï¸', title: 'å‹‡æ–¼æŒ‘æˆ°', desc: 'å®Œæˆ 1 æ¬¡æ¸¬é©—', check: (s) => s.quizCount >= 1 },
        { id: 'quiz_10', category: 'quiz', tier: 'rare', icon: 'âš”ï¸', title: 'æ¸¬é©—å¸¸å®¢', desc: 'å®Œæˆ 10 æ¬¡æ¸¬é©—', check: (s) => s.quizCount >= 10 },
        { id: 'quiz_50', category: 'quiz', tier: 'epic', icon: 'ğŸ›¡ï¸', title: 'èº«ç¶“ç™¾æˆ°', desc: 'å®Œæˆ 50 æ¬¡æ¸¬é©—', check: (s) => s.quizCount >= 50 },
        { id: 'correct_10', category: 'milestone', tier: 'common', icon: 'ğŸ’°', title: 'ç­”é¡Œæ–°æ‰‹', desc: 'ç´¯ç©ç­”å° 10 é¡Œ', check: (s) => s.totalCorrect >= 10 },
        { id: 'correct_100', category: 'milestone', tier: 'rare', icon: 'ğŸ’', title: 'æ™ºæ…§ä¹‹æ˜Ÿ', desc: 'ç´¯ç©ç­”å° 100 é¡Œ', check: (s) => s.totalCorrect >= 100 },
        { id: 'correct_500', category: 'milestone', tier: 'epic', icon: 'ğŸ†', title: 'ç¥æº–å°„æ‰‹', desc: 'ç´¯ç©ç­”å° 500 é¡Œ', check: (s) => s.totalCorrect >= 500 },
        { id: 'correct_1000', category: 'milestone', tier: 'legendary', icon: 'ğŸ‰', title: 'å‚³èªªå­¸éœ¸', desc: 'ç´¯ç©ç­”å° 1000 é¡Œ', check: (s) => s.totalCorrect >= 1000 },
        { id: 'secret_night', category: 'secret', tier: 'rare', icon: 'ğŸ§›', title: 'å¤œè²“å­', desc: 'æ™šä¸Š 10 é»å¾ŒèƒŒå–®å­—', secretDesc: 'æ·±å¤œå‡ºæ²’...', check: () => new Date().getHours() >= 22 },
        { id: 'secret_early', category: 'secret', tier: 'rare', icon: 'ğŸ”', title: 'æ—©èµ·çš„é³¥å…’', desc: 'æ—©ä¸Š 7 é»å‰èƒŒå–®å­—', secretDesc: 'æ—©èµ·çš„é³¥å…’...', check: () => new Date().getHours() < 7 },
        { id: 'secret_fail', category: 'secret', tier: 'epic', icon: 'ğŸ’€', title: 'æ„ˆæŒ«æ„ˆå‹‡', desc: 'ç´¯ç©ç­”éŒ¯ 50 æ¬¡', secretDesc: 'å¤±æ•—ç‚ºæˆåŠŸä¹‹æ¯...', check: (s) => s.totalMistakes >= 50 }
    ];

    window.onload = function() {
        if (typeof masterWordList === 'undefined') { alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è³‡æ–™åº« words.js"); return; }
        sessions = [...new Set(masterWordList.map(item => item.session))].sort();
        loadUserData();
        goHome();
    };

    function loadUserData() {
        const savedViewed = localStorage.getItem('viewedWords');
        if (savedViewed) viewedWords = new Set(JSON.parse(savedViewed));
        const savedStats = localStorage.getItem('userStats');
        if (savedStats) {
            const parsed = JSON.parse(savedStats);
            userStats.quizCount = parsed.quizCount || 0;
            userStats.totalCorrect = parsed.totalCorrect || 0;
            userStats.totalMistakes = parsed.totalMistakes || 0;
            userStats.wordsViewedCount = viewedWords.size;
        }
        const savedTitles = localStorage.getItem('unlockedTitles');
        if (savedTitles) unlockedTitles = new Set(JSON.parse(savedTitles));
    }

    function saveUserData() {
        localStorage.setItem('viewedWords', JSON.stringify([...viewedWords]));
        localStorage.setItem('userStats', JSON.stringify(userStats));
        localStorage.setItem('unlockedTitles', JSON.stringify([...unlockedTitles]));
    }

    function checkUnitsCompleted(targetCount) {
        let completed = 0;
        sessions.forEach(sid => {
            const words = masterWordList.filter(w => w.session === sid);
            if (words.every(w => viewedWords.has(w.word))) completed++;
        });
        return completed >= targetCount;
    }

    function checkLettersCompleted(targetCount) {
        const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
        let completed = 0;
        letters.forEach(char => {
            const words = masterWordList.filter(w => w.word.toUpperCase().startsWith(char));
            if (words.length > 0 && words.every(w => viewedWords.has(w.word))) completed++;
        });
        return completed >= targetCount;
    }

    function checkAchievements() {
        let newUnlock = false;
        userStats.wordsViewedCount = viewedWords.size;
        achievements.forEach(ach => {
            if (!unlockedTitles.has(ach.id) && ach.check(userStats)) {
                unlockedTitles.add(ach.id);
                showToast(ach.title, ach.icon);
                newUnlock = true;
            }
        });
        if (newUnlock) saveUserData();
    }

    function showToast(title, icon) {
        const toast = document.getElementById('toastNotification');
        toast.querySelector('div').innerText = icon || 'ğŸ';
        document.getElementById('toastMsg').innerText = title;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function goHome() { showScreen('homeScreen'); }
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
        clearInterval(quizData.timerId); 
        window.speechSynthesis.cancel(); 
    }

    function speak(text) {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        u.rate = 0.9; 
        const voices = window.speechSynthesis.getVoices();
        const preferred = voices.find(v => v.name.includes("Google US English") || v.name.includes("Samantha"));
        if (preferred) u.voice = preferred;
        window.speechSynthesis.speak(u);
    }

    function openAchievementScreen() {
        const grid = document.getElementById('badgeGrid');
        grid.innerHTML = "";
        const categories = { 'learn': 'ğŸ“š å‹¤å­¸ä¹‹è·¯', 'unit': 'ğŸ« Unit åˆ¶éœ¸', 'alpha': 'ğŸ”¡ å­—æ¯è’é›†', 'quiz': 'âš”ï¸ è©¦ç…‰æˆ°å ´', 'milestone': 'ğŸ’ å‚³å¥‡é‡Œç¨‹ç¢‘', 'secret': 'âœ¨ ç¥ç§˜å½©è›‹' };
        
        for (let cat in categories) {
            const header = document.createElement('div');
            header.className = `category-header cat-${cat}`;
            header.style.gridColumn = "1 / -1";
            header.innerText = categories[cat];
            grid.appendChild(header);

            achievements.filter(a => a.category === cat).forEach(ach => {
                const isUnlocked = unlockedTitles.has(ach.id);
                const div = document.createElement('div');
                div.className = `badge-card ${isUnlocked ? 'unlocked' : ''} ${ach.tier}`;
                
                let icon = 'ğŸ”’'; let title = ach.title; let hintLabel = "ğŸ¯ ç›®æ¨™ï¼š"; let desc = ach.desc;

                if (isUnlocked) {
                    icon = ach.icon || 'ğŸ†';
                } else {
                    if (ach.category === 'secret') {
                        title = 'ï¼Ÿï¼Ÿï¼Ÿ';
                        hintLabel = "ğŸ•µï¸ ç·šç´¢ï¼š";
                        desc = ach.secretDesc;
                    }
                }
                
                div.innerHTML = `
                    <div class="badge-icon">${icon}</div>
                    <div class="badge-title">${title}</div>
                    ${!isUnlocked ? `<div class="badge-hint-box">${hintLabel}${desc}</div>` : `<div class="badge-desc">${desc}</div>`}
                `;
                grid.appendChild(div);
            });
        }
        showScreen('achievementScreen');
    }

    function openAnalysisScreen() {
        const m = JSON.parse(localStorage.getItem('myMistakes')) || {};
        const topList = document.getElementById('topWeakList');
        const fullList = document.getElementById('fullMistakeList');
        let sorted = Object.keys(m).map(k => ({ word: k, count: m[k] })).sort((a,b) => b.count - a.count);
        if (sorted.length === 0) {
            topList.innerHTML = "<div style='color:#999;'>ç„¡éŒ¯é¡Œç´€éŒ„</div>";
            fullList.innerHTML = "";
        } else {
            topList.innerHTML = "";
            sorted.slice(0, 3).forEach((item, idx) => {
                let medal = idx===0?'ğŸ¥‡':(idx===1?'ğŸ¥ˆ':'ğŸ¥‰');
                topList.innerHTML += `<div class="weak-item-card"><div style="font-size:1.5rem;">${medal}</div><span class="weak-word">${item.word}</span><span class="weak-count">éŒ¯ ${item.count} æ¬¡</span></div>`;
            });
            let html = "";
            sorted.forEach((item, idx) => {
                let rankClass = idx < 3 ? `top${idx+1}` : '';
                html += `<div class="mistake-row"><span class="rank-num ${rankClass}">#${idx+1}</span><span class="mistake-word">${item.word}</span><span class="mistake-val">éŒ¯ ${item.count} æ¬¡</span></div>`;
            });
            fullList.innerHTML = html;
        }
        showScreen('analysisScreen');
    }

    function startTop30WeaknessQuiz() {
        const m = JSON.parse(localStorage.getItem('myMistakes')) || {};
        const sorted = Object.keys(m).map(k => ({ word: k, count: m[k] })).sort((a,b) => b.count - a.count);
        if (sorted.length === 0) { alert("æ²’æœ‰éŒ¯é¡Œï¼"); return; }
        const top30 = sorted.slice(0, 30).map(i => i.word);
        quizConfig.selectedWords = new Set(top30);
        quizConfig.mode = 'choice'; quizConfig.timer = false; quizConfig.autoNext = true;
        startConfiguredQuiz();
    }

    function openUnitSelector(targetMode) {
        currentMode = targetMode; 
        const grid = document.getElementById('unitGridContainer');
        grid.innerHTML = "";
        sessions.forEach(sid => {
            const count = masterWordList.filter(w => w.session === sid).length;
            const btn = document.createElement('div');
            btn.className = 'unit-card';
            btn.innerHTML = `<h3>Unit ${sid}</h3><span class="action-hint">${count} words â–¶</span>`;
            btn.onclick = () => loadStudyOverview(sid);
            grid.appendChild(btn);
        });
        showScreen('unitSelectScreen');
    }

    function loadStudyOverview(sid) {
        studyData.sid = sid;
        studyData.list = masterWordList.filter(w => w.session === sid);
        document.getElementById('overviewTitle').innerText = `Unit ${sid}`;
        renderOverviewGrid();
        showScreen('studyOverviewScreen');
    }

    function renderOverviewGrid() {
        const grid = document.getElementById('overviewGrid');
        grid.innerHTML = "";
        studyData.list.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'word-overview-card';
            if (viewedWords.has(item.word)) card.classList.add('read');
            card.innerHTML = `<h4>${item.word}</h4>`;
            card.onclick = () => openFlashcard(index);
            grid.appendChild(card);
        });
    }

    function openFlashcard(index) {
        studyData.currentIndex = index;
        updateFlashcardUI();
        showScreen('studyDetailScreen');
    }

    function updateFlashcardUI() {
        const item = studyData.list[studyData.currentIndex];
        if (!viewedWords.has(item.word)) {
            viewedWords.add(item.word);
            saveUserData();
            checkAchievements(); 
        }
        document.getElementById('detailIdx').innerText = studyData.currentIndex + 1;
        document.getElementById('detailTotal').innerText = studyData.list.length;
        document.getElementById('cardWord').innerText = item.word;
        document.getElementById('cardZh').innerText = item.word_zh || '';
        document.getElementById('cardSentEn').innerText = item.sentence;
        document.getElementById('cardSentZh').innerText = item.sentence_zh || '';
        window.speechSynthesis.cancel();
        setTimeout(() => speak(item.word), 300);
    }

    function prevCard() { if (studyData.currentIndex > 0) { studyData.currentIndex--; updateFlashcardUI(); } }
    function nextCard() { if (studyData.currentIndex < studyData.list.length - 1) { studyData.currentIndex++; updateFlashcardUI(); } }
    function backToOverview() { renderOverviewGrid(); showScreen('studyOverviewScreen'); }
    function playCurrentCardAudio() { window.speechSynthesis.cancel(); speak(studyData.list[studyData.currentIndex].word); }
    function playCurrentCardSent() { window.speechSynthesis.cancel(); speak(studyData.list[studyData.currentIndex].sentence); }

    function quickQuizFromStudy() { openQuickQuizPicker(); }
    function openQuickQuizPicker() { isQuickQuizPicker = true; openWordPicker(studyData.sid); }
    function startQuickQuizDirect(mode) { quizConfig.mode = mode; quizConfig.timer = false; quizConfig.autoNext = true; closeWordPicker(); startConfiguredQuiz(); }

    function openQuizSetup() {
        quizConfig.mode = 'choice'; quizConfig.timer = false; quizConfig.autoNext = true;
        updateModeUI();
        document.getElementById('timerSwitch').checked = false;
        document.getElementById('autoNextSwitch').checked = true;
        renderQuizRangeGrid();
        updateTotalCount();
        showScreen('quizSetupScreen');
    }

    function renderQuizRangeGrid() {
        const grid = document.getElementById('quizRangeGrid');
        grid.innerHTML = "";
        sessions.forEach(sid => {
            const btn = document.createElement('div');
            btn.className = 'range-btn';
            const unitWords = masterWordList.filter(w => w.session === sid);
            let pickedCount = 0;
            unitWords.forEach(w => { if (quizConfig.selectedWords.has(w.word)) pickedCount++; });
            if (pickedCount > 0) btn.classList.add('has-data');
            btn.innerHTML = `Unit ${sid} ${pickedCount > 0 ? `<span class="badge-count">${pickedCount}</span>` : ''}`;
            btn.onclick = () => { isQuickQuizPicker = false; openWordPicker(sid); };
            grid.appendChild(btn);
        });
    }

    function setQuizMode(mode) { quizConfig.mode = mode; updateModeUI(); }
    function updateModeUI() {
        document.getElementById('modeChoice').classList.toggle('active', quizConfig.mode === 'choice');
        document.getElementById('modeSpelling').classList.toggle('active', quizConfig.mode === 'spelling');
    }
    function clearAllSelectedWords() { if(confirm("æ¸…é™¤æ‰€æœ‰ï¼Ÿ")) { quizConfig.selectedWords.clear(); renderQuizRangeGrid(); updateTotalCount(); } }
    function updateTotalCount() { document.getElementById('totalSelectedCount').innerText = quizConfig.selectedWords.size; }

    function openWordPicker(sid) {
        currentPickerSid = sid;
        document.getElementById('pickerTitle').innerText = `æŒ‘é¸ (Unit ${sid})`;
        if (isQuickQuizPicker) {
            quizConfig.selectedWords.clear();
            const unitWords = masterWordList.filter(w => w.session === sid);
            unitWords.forEach(w => { if (viewedWords.has(w.word)) quizConfig.selectedWords.add(w.word); });
            document.getElementById('btnPickerSave').style.display = 'none';
            document.getElementById('btnPickerQuickStart').style.display = 'flex';
        } else {
            document.getElementById('btnPickerSave').style.display = 'block';
            document.getElementById('btnPickerQuickStart').style.display = 'none';
        }
        document.getElementById('wordPickerModal').style.display = 'block';
        renderPickerGrid();
    }
    function closeWordPicker() { document.getElementById('wordPickerModal').style.display = 'none'; if (!isQuickQuizPicker) { renderQuizRangeGrid(); updateTotalCount(); } }
    function renderPickerGrid() {
        const container = document.getElementById('pickerGrid'); container.innerHTML = "";
        const unitWords = masterWordList.filter(w => w.session === currentPickerSid);
        unitWords.forEach(item => {
            const div = document.createElement('div'); div.className = 'picker-item';
            if (quizConfig.selectedWords.has(item.word)) div.classList.add('picked');
            div.innerText = item.word;
            div.onclick = () => {
                if (quizConfig.selectedWords.has(item.word)) { quizConfig.selectedWords.delete(item.word); div.classList.remove('picked'); }
                else { quizConfig.selectedWords.add(item.word); div.classList.add('picked'); }
            };
            container.appendChild(div);
        });
    }
    function pickerSelectAll() { masterWordList.filter(w => w.session === currentPickerSid).forEach(w => quizConfig.selectedWords.add(w.word)); renderPickerGrid(); }
    function pickerSelectNone() { masterWordList.filter(w => w.session === currentPickerSid).forEach(w => quizConfig.selectedWords.delete(w.word)); renderPickerGrid(); }
    function pickerSelectViewed() {
        masterWordList.filter(w => w.session === currentPickerSid).forEach(w => {
            if (viewedWords.has(w.word)) quizConfig.selectedWords.add(w.word); else quizConfig.selectedWords.delete(w.word);
        }); renderPickerGrid();
    }

    function startConfiguredQuiz() {
        if (quizConfig.selectedWords.size === 0) { alert("è«‹è‡³å°‘é¸æ“‡ 1 å€‹å–®å­—ï¼"); return; }
        if (document.getElementById('quizSetupScreen').classList.contains('active')) {
            quizConfig.timer = document.getElementById('timerSwitch').checked;
            quizConfig.autoNext = document.getElementById('autoNextSwitch').checked;
        }
        let questions = masterWordList.filter(w => quizConfig.selectedWords.has(w.word));
        questions.sort(() => 0.5 - Math.random());
        quizData.list = questions; quizData.index = 0; quizData.score = 0;
        document.getElementById('choiceArea').style.display = (quizConfig.mode === 'choice') ? 'grid' : 'none';
        document.getElementById('spellingArea').style.display = (quizConfig.mode === 'spelling') ? 'block' : 'none';
        document.getElementById('timerBadge').style.display = quizConfig.timer ? 'inline-block' : 'none';
        document.getElementById('btnNextQ').style.display = 'none';
        showScreen('quizScreen');
        loadQuestion();
    }

    function loadQuestion() {
        clearInterval(quizData.timerId);
        document.getElementById('btnNextQ').style.display = 'none';
        document.getElementById('qHint').style.display = 'none';
        document.getElementById('btnShowHint').style.display = 'inline-block';

        const item = quizData.list[quizData.index];
        document.getElementById('qIdx').innerText = quizData.index + 1;
        document.getElementById('qTotal').innerText = quizData.list.length;
        document.getElementById('qHint').innerText = item.word_zh || "(ç„¡ä¸­æ–‡)";
        if (quizConfig.mode === 'choice') renderChoices(item); else renderSpelling();
        playQuizSequence();
    }

    function showHint() {
        document.getElementById('qHint').style.display = 'block';
        document.getElementById('btnShowHint').style.display = 'none';
    }

    function playQuizSequence() {
        const item = quizData.list[quizData.index];
        window.speechSynthesis.cancel();
        const u1 = new SpeechSynthesisUtterance(item.word); u1.rate = 0.9; u1.lang = 'en-US';
        const u2 = new SpeechSynthesisUtterance(item.sentence); u2.rate = 0.9; u2.lang = 'en-US';
        const u3 = new SpeechSynthesisUtterance(item.word); u3.rate = 0.9; u3.lang = 'en-US';
        u3.onend = function() { if (quizConfig.timer) startTimer(); };
        window.speechSynthesis.speak(u1); window.speechSynthesis.speak(u2); window.speechSynthesis.speak(u3);
    }

    function startTimer() {
        clearInterval(quizData.timerId); let timeLeft = 8;
        document.getElementById('timeLeft').innerText = timeLeft;
        quizData.timerId = setInterval(() => {
            timeLeft--; document.getElementById('timeLeft').innerText = timeLeft;
            if (timeLeft <= 0) { clearInterval(quizData.timerId); handleTimeUp(); }
        }, 1000);
    }

    function handleTimeUp() {
        speak("Time's up!");
        saveMistake(quizData.list[quizData.index].word);
        userStats.totalMistakes++;
        if (quizConfig.mode === 'choice') {
            const btns = document.querySelectorAll('.btn-choice');
            btns.forEach(b => {
                if (b.innerText === quizData.list[quizData.index].word) b.classList.add('correct');
                b.disabled = true;
            });
        } else {
            document.getElementById('spellingInput').value = quizData.list[quizData.index].word;
            document.getElementById('spellingInput').style.borderColor = "var(--danger)";
        }
        handleNextStep();
    }

    function handleNextStep() {
        if (quizConfig.autoNext) setTimeout(nextQuestion, 1500); else document.getElementById('btnNextQ').style.display = 'block';
    }

    function nextQuestion() {
        quizData.index++;
        if (quizData.index < quizData.list.length) loadQuestion(); else showResult();
    }

    function renderChoices(correctItem) {
        const container = document.getElementById('choiceArea'); container.innerHTML = "";
        let opts = [correctItem];
        let pool = quizData.list.length >= 4 ? quizData.list : masterWordList;
        while(opts.length < 4) { const rand = pool[Math.floor(Math.random() * pool.length)]; if (!opts.some(o => o.word === rand.word)) opts.push(rand); }
        opts.sort(() => 0.5 - Math.random());
        opts.forEach(opt => {
            const btn = document.createElement('button'); btn.className = 'btn-choice'; btn.innerText = opt.word;
            btn.onclick = () => checkChoice(btn, opt.word === correctItem.word);
            container.appendChild(btn);
        });
    }

    function checkChoice(btn, isCorrect) {
        clearInterval(quizData.timerId); window.speechSynthesis.cancel();
        const allBtns = document.querySelectorAll('.btn-choice'); allBtns.forEach(b => b.disabled = true);
        if (isCorrect) { btn.classList.add('correct'); quizData.score++; speak("Correct"); userStats.totalCorrect++; } 
        else { btn.classList.add('wrong'); saveMistake(quizData.list[quizData.index].word); speak("Wrong"); userStats.totalMistakes++;
               allBtns.forEach(b => { if (b.innerText === quizData.list[quizData.index].word) b.classList.add('correct'); }); }
        handleNextStep();
    }

    function renderSpelling() {
        const input = document.getElementById('spellingInput'); input.value = ""; input.disabled = false; input.style.borderColor = "#ccc"; document.getElementById('spellingFeedback').innerText = ""; input.focus();
    }

    function checkSpelling() {
        clearInterval(quizData.timerId); window.speechSynthesis.cancel();
        const input = document.getElementById('spellingInput');
        const correct = quizData.list[quizData.index].word.trim().toLowerCase();
        const userVal = input.value.trim().toLowerCase();
        input.disabled = true;
        if (userVal === correct || (correct.includes('(') && correct.startsWith(userVal))) {
            input.style.borderColor = "var(--success)"; quizData.score++; speak("Correct"); userStats.totalCorrect++;
        } else {
            input.style.borderColor = "var(--danger)";
            document.getElementById('spellingFeedback').innerText = `Ans: ${quizData.list[quizData.index].word}`;
            document.getElementById('spellingFeedback').style.color = "var(--danger)";
            saveMistake(quizData.list[quizData.index].word); speak("Wrong"); userStats.totalMistakes++;
        }
        handleNextStep();
    }
    document.getElementById('spellingInput').addEventListener('keyup', function(e) { if (e.key === 'Enter' && !this.disabled) checkSpelling(); });

    function showResult() {
        userStats.quizCount++;
        saveUserData();
        checkAchievements(); 
        showScreen('resultScreen');
        const finalScore = Math.round((quizData.score / quizData.list.length) * 100);
        document.getElementById('finalScore').innerText = finalScore;
    }

    function quitQuiz() { if (confirm("ç¢ºå®šæ”¾æ£„ï¼Ÿ")) goHome(); }
    function retryQuiz() { startConfiguredQuiz(); }

    function saveMistake(word) { let m = JSON.parse(localStorage.getItem('myMistakes')) || {}; m[word] = (m[word] || 0) + 1; localStorage.setItem('myMistakes', JSON.stringify(m)); }
    function openMistakes() { openAnalysisScreen(); }
    function clearMistakes() { if (confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) { localStorage.removeItem('myMistakes'); openAnalysisScreen(); } }

</script>
</body>
</html>