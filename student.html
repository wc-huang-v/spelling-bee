<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¸ç”Ÿè‡ªä¸»å­¸ç¿’å¹³æ¿ v48.0 (Mobile Fix)</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* --- ğŸ¨ è¦–è¦ºé¢¨æ ¼ï¼šç¾ä»£å¾©å¤åƒç´ é¢¨ (Pixel Lite) --- */
        :root {
            --bg-color: #87CEEB;
            --panel-bg: #ffffff;
            --primary: #4a90e2;
            --primary-dark: #2980b9;
            --accent: #ff9f43;
            --student: #2ecc71;
            --danger: #ff7675;
            --text-main: #2d3436;
            --border-black: #000000;
            
            /* ç¨€æœ‰åº¦é¡è‰² */
            --tier-common: #cd7f32;
            --tier-rare: #bdc3c7;
            --tier-epic: #f1c40f;
            --tier-legend: #9b59b6;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'VT323', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-main);
            margin: 0; padding: 15px; /* ç¨å¾®æ¸›å°‘é‚Šè·ä»¥é©æ‡‰æ‰‹æ©Ÿ */
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
        }

        /* --- éŸ¿æ‡‰å¼èª¿æ•´ (Mobile Fixes) --- */
        @media (max-width: 600px) {
            .hero-title { font-size: 2.8rem !important; } /* æ‰‹æ©Ÿæ¨™é¡Œç¸®å° */
            .hero-sub { font-size: 1rem !important; }
            .dashboard-grid { grid-template-columns: 1fr 1fr !important; gap: 10px !important; }
            .dash-btn { min-height: 120px !important; padding: 15px 5px !important; }
            .dash-icon { font-size: 2.5rem !important; }
            .dash-btn h2 { font-size: 1.2rem !important; }
            
            /* æ¸¬é©—å€èª¿æ•´ */
            .detail-word { font-size: 3rem !important; }
            .word-display { font-size: 2.5rem !important; }
            
            /* é¸å­—æ ¼èª¿æ•´ */
            .word-picker-container { 
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)) !important; /* å¯¬åº¦å¢åŠ ï¼Œé¿å…æ“æ“  */
                gap: 12px !important;
            }
            .picker-item { 
                font-size: 1rem !important; 
                padding: 12px 5px !important; 
                min-height: 50px;
                display: flex; align-items: center; justify-content: center;
            }
        }

        /* --- é€šç”¨å…ƒä»¶ --- */
        .pixel-card {
            background: #fff; border: 3px solid var(--border-black); border-radius: 8px;
            box-shadow: 6px 6px 0px rgba(0,0,0,0.2); padding: 20px; position: relative; margin-bottom: 20px;
            width: 100%; /* ç¢ºä¿å¡ç‰‡æ’æ»¿å®¹å™¨ */
        }

        .btn-pixel {
            background: #fff; border: 3px solid var(--border-black); border-radius: 8px; padding: 10px 20px;
            font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 4px 4px 0px var(--border-black);
            transition: all 0.1s; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            color: var(--text-main); text-decoration: none;
        }
        .btn-pixel:active { transform: translate(4px, 4px); box-shadow: 0px 0px 0px; }
        
        .btn-primary { background: #74b9ff; }
        .btn-success { background: #55efc4; }
        .btn-danger { background: #ff7675; color: white; }
        .btn-warning { background: #ffeaa7; }
        .btn-back { background: #dfe6e9; width: auto; font-size: 1rem; padding: 8px 12px; }
        .btn-cancel { background: #eee; color: #666; border-color: #999; box-shadow: 4px 4px 0 #999; }

        /* --- é é¢åˆ‡æ› --- */
        .screen { display: none; width: 100%; max-width: 700px; padding-bottom: 20px; animation: fadeIn 0.3s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .page-title { font-size: 2rem; font-weight: 900; color: white; margin: 0; text-shadow: 3px 3px 0 #000; letter-spacing: 1px; }

        /* --- 1. é¦–é  --- */
        .hero-banner { text-align: center; margin-bottom: 30px; margin-top: 10px; }
        .hero-title { font-size: 4rem; font-weight: 900; color: #feca57; text-shadow: 4px 4px 0 #000; margin-bottom: 5px; line-height: 1; }
        .hero-sub { background: #fff; padding: 5px 15px; border-radius: 20px; border: 2px solid #000; display: inline-block; font-weight: bold; font-size: 1.1rem; box-shadow: 3px 3px 0 rgba(0,0,0,0.1); }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 40px; }
        .dash-btn {
            background: white; border: 3px solid var(--border-black); border-radius: 12px; padding: 20px 10px;
            text-align: center; cursor: pointer; box-shadow: 6px 6px 0 var(--border-black); transition: 0.1s;
            display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 140px;
        }
        .dash-btn:active { transform: translate(6px, 6px); box-shadow: 0 0 0; }
        .dash-icon { font-size: 3rem; margin-bottom: 5px; }
        .dash-btn h2 { font-size: 1.5rem; margin: 0; color: var(--text-main); font-weight: 900; }
        .dash-btn p { font-size: 0.9rem; color: #666; margin: 5px 0 0; font-weight: bold; }
        
        .dash-btn.study { background: #dff9fb; }
        .dash-btn.quiz { background: #ff7979; color: white; } .dash-btn.quiz h2 { color: white; } .dash-btn.quiz p { color: #ffecec; }
        .dash-btn.achievement { background: #fff3cd; }
        .dash-btn.analysis { background: #d4efdf; }

        /* --- 2. å–®å…ƒé¸æ“‡ --- */
        .unit-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
        .unit-card { background: white; border: 3px solid #ccc; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; transition: 0.2s; box-shadow: 4px 4px 0 #ccc; }
        .unit-card:hover { border-color: var(--border-black); box-shadow: 4px 4px 0 var(--border-black); transform: translate(-2px, -2px); }
        .unit-card h3 { margin: 0; font-size: 1.5rem; color: var(--text-main); }
        .unit-card .action-hint { font-size: 0.9rem; color: var(--primary); margin-top: 5px; font-weight: bold; display: block;}

        /* --- 3. èƒŒå–®å­— (Overview) --- */
        .word-overview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; padding-bottom: 100px; }
        .word-overview-card { background: white; border: 3px solid #ddd; border-radius: 8px; padding: 15px 10px; text-align: center; cursor: pointer; position: relative; box-shadow: 3px 3px 0 #ddd; word-wrap: break-word; }
        .word-overview-card:active { transform: translate(3px, 3px); box-shadow: 0 0 0; }
        .word-overview-card h4 { margin: 0; font-size: 1.2rem; font-weight: 900; }
        .word-overview-card.read { background: #e8f5e9; border-color: #27ae60; box-shadow: 3px 3px 0 #27ae60; }
        .word-overview-card.read::after { content: "âœ”"; position: absolute; top: 2px; right: 2px; color: #27ae60; font-weight: bold; font-size: 0.8rem; }

        /* --- 4. è©³ç´°å¡ç‰‡ --- */
        .detail-box { text-align: center; padding: 20px 10px; }
        .word-header-row { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 5px; }
        .detail-word { font-size: 4.5rem; font-weight: 900; color: #000; letter-spacing: 1px; line-height: 1; word-wrap: break-word; }
        .btn-speak-inline { background: var(--primary); color: white; border: 3px solid #000; border-radius: 50%; width: 40px; height: 40px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 3px 3px 0 #000; flex-shrink: 0; }
        .btn-speak-inline:active { transform: translate(2px, 2px); box-shadow: 0 0 0; }
        .detail-zh { font-size: 1.8rem; color: #555; margin-bottom: 30px; font-weight: bold; }
        .detail-sent-box { background: #eee; padding: 15px; border-radius: 8px; width: 100%; text-align: left; border: 3px solid #ccc; position: relative; }
        .detail-sent-en { font-size: 1.3rem; font-weight: bold; color: #333; margin-bottom: 5px; font-family: 'VT323'; line-height: 1.2; padding-right: 30px; }
        .detail-sent-zh { font-size: 1rem; color: #666; font-family: 'Microsoft JhengHei'; }
        .btn-small-audio { position: absolute; right: 10px; top: 10px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
        .nav-controls { display: flex; justify-content: space-between; width: 100%; margin-top: 30px; gap: 15px; }
        .nav-controls button { flex: 1; }

        /* --- 5. æ¸¬é©—è¨­å®š --- */
        .toggle-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .toggle-btn { flex: 1; padding: 15px; border: 3px solid #ccc; background: white; border-radius: 8px; font-weight: bold; color: #777; cursor: pointer; font-size: 1.2rem; }
        .toggle-btn.active { border-color: #000; background: var(--primary); color: #fff; box-shadow: 4px 4px 0 #000; transform: translate(-2px, -2px); }
        .range-selector { display: flex; flex-wrap: wrap; gap: 10px; max-height: 200px; overflow-y: auto; margin-top: 15px; }
        .range-btn { padding: 8px 12px; border-radius: 8px; border: 3px solid #ccc; background: white; cursor: pointer; font-weight: bold; color: #555; font-size: 1rem; }
        .range-btn.selected { border-color: #000; background: #feca57; color: #000; box-shadow: 3px 3px 0 #000; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-weight: bold; font-size: 1.1rem; }
        
        /* Switch */
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; cursor: pointer; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .2s; border-radius: 4px; border: 2px solid #000; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .2s; border: 3px solid #000; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- 6. æ¸¬é©—é€²è¡Œä¸­ --- */
        .quiz-settings-bar { display: flex; justify-content: center; gap: 20px; background: #eee; padding: 10px; border-radius: 8px; border: 3px solid #000; margin-bottom: 15px; }
        .mini-setting { display: flex; align-items: center; gap: 8px; font-weight: bold; font-size: 0.9rem; }
        .quiz-status { display: flex; justify-content: space-between; font-weight: bold; color: #fff; margin-bottom: 10px; font-size: 1.4rem; background: #000; padding: 5px 10px; border-radius: 4px; }
        .q-hint { font-size: 1.5rem; font-weight: 900; color: #000; margin: 20px 0; min-height: 1.5em; background: #eee; border: 2px dashed #000; padding: 10px; }
        .choice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-choice { background: #fff; border: 4px solid #000; padding: 20px; font-size: 1.5rem; font-weight: bold; color: #000; cursor: pointer; box-shadow: 6px 6px 0 #000; transition: 0.1s; word-wrap: break-word; }
        .btn-choice:active { transform: translate(6px, 6px); box-shadow: 0 0 0; }
        .btn-choice.correct { background: #55efc4; }
        .btn-choice.wrong { background: #ff7675; }
        .input-spelling { width: 100%; padding: 15px; font-size: 2rem; text-align: center; border: 4px solid #000; margin-bottom: 15px; background: #fffde7; font-family: 'VT323', monospace; letter-spacing: 3px; text-transform: lowercase; }

        /* --- 7. çµæœé  --- */
        .result-list { text-align: left; background: #f9f9f9; border: 2px solid #ccc; padding: 10px; max-height: 200px; overflow-y: auto; margin-bottom: 20px; }
        .result-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #ccc; font-weight: bold; font-size: 1.1rem; }
        .res-icon { width: 30px; text-align: center; }
        .res-correct { color: var(--success); }
        .res-wrong { color: var(--danger); }

        /* --- ç¨±è™Ÿ --- */
        .achievement-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
        .badge-card { background: #ddd; border: 4px dashed #999; padding: 15px 10px; text-align: center; opacity: 1; position: relative; }
        .badge-card.unlocked { border-style: solid; border-color: #000; background: #fff; box-shadow: 6px 6px 0 rgba(0,0,0,0.2); }
        .badge-card.unlocked.common { background: #fff; }
        .badge-card.unlocked.rare { background: #e0f2f1; }
        .badge-card.unlocked.epic { background: #fff9c4; border-color: #f1c40f; }
        .badge-card.unlocked.legendary { background: #f3e5f5; border-color: #9b59b6; box-shadow: 6px 6px 0 #9b59b6; }
        .badge-icon { font-size: 3rem; margin-bottom: 5px; display: block; }
        .badge-title { font-weight: 900; font-size: 1.1rem; margin-bottom: 5px; }
        .badge-desc { font-size: 0.8rem; color: #555; font-family: 'Microsoft JhengHei'; }
        .badge-hint-box { background: rgba(0,0,0,0.1); font-size: 0.8rem; margin-top: 5px; padding: 5px; font-weight: bold; color: #555; }
        .category-header { grid-column: 1/-1; font-size: 1.2rem; font-weight: 900; margin: 20px 0 10px; padding: 5px 15px; background: #000; color: #fff; width: fit-content; border-radius: 4px; transform: skew(-5deg); }

        /* --- Word Picker Modal (Mobile Optimized) --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; }
        .modal-content { background: #fff; margin: 5% auto; padding: 20px; width: 90%; max-width: 500px; border: 6px solid #000; box-shadow: 15px 15px 0 #222; text-align: center; max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 2.5rem; cursor: pointer; color: #000; line-height: 0.8; }
        
        .word-picker-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* Optimised for mobile visibility */
            gap: 8px; margin-top: 10px; padding: 5px; overflow-y: auto; flex: 1; 
        }
        .picker-item { 
            background: #f9f9f9; border: 2px solid #ccc; padding: 10px 5px; border-radius: 4px; 
            text-align: center; cursor: pointer; font-size: 1rem; font-weight: bold; 
            position: relative; overflow: hidden; word-break: break-all;
        }
        .picker-item.picked { background: #fff3cd; border-color: #000; color: #000; box-shadow: 2px 2px 0 #000; transform: translate(-1px, -1px); }
        .picker-actions { display: flex; gap: 8px; margin-top: 15px; padding-top: 10px; border-top: 2px dashed #ccc; flex-shrink: 0; }

        /* Safe Exit */
        .safe-exit-area { text-align: center; margin-top: auto; padding: 20px 0; width: 100%; }
        .btn-safe-exit { color: rgba(0,0,0,0.4); text-decoration: none; font-size: 0.8rem; font-weight: bold; border: 1px solid rgba(0,0,0,0.1); padding: 5px 10px; border-radius: 20px; transition: 0.2s; }
        .btn-safe-exit:hover { color: #d63031; border-color: #d63031; opacity: 1; }

        /* Toast */
        .toast-notification { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: #fff; padding: 15px 25px; border: 4px solid #000; z-index: 2000; display: flex; align-items: center; gap: 15px; box-shadow: 10px 10px 0 rgba(0,0,0,0.5); transition: top 0.5s; }
        .toast-notification.show { top: 30px; }

    </style>
</head>
<body>

    <div id="toastNotification" class="toast-notification">
        <div style="font-size:3rem;">ğŸ</div>
        <div style="text-align:left;">
            <h4 style="margin:0; font-size:1.5rem; color:#f1c40f; text-shadow:1px 1px 0 #000;">LEVEL UP!</h4>
            <p id="toastMsg" style="margin:0; font-weight:bold; font-family:'Microsoft JhengHei';">ç²å¾—æ–°ç¨±è™Ÿ</p>
        </div>
    </div>

    <div id="homeScreen" class="screen active">
        <div class="hero-banner">
            <div class="hero-title">VOCAB HERO</div>
            <div class="hero-sub">å–®å­—å¤§å†’éšª v48.0</div>
        </div>

        <div class="dashboard-grid">
            <div class="dash-btn study" onclick="openUnitSelector('study')">
                <div class="dash-icon">ğŸ“–</div>
                <h2>èƒŒå–®å­—</h2>
                <p>STUDY</p>
            </div>
            <div class="dash-btn quiz" onclick="openQuizSetup()">
                <div class="dash-icon">âš”ï¸</div>
                <h2>æŒ‘æˆ°é­”ç‹</h2>
                <p>QUIZ</p>
            </div>
            <div class="dash-btn achievement" onclick="openAchievementScreen()">
                <div class="dash-icon">ğŸ†</div>
                <h2>æ¦®è­½æ®¿å ‚</h2>
                <p>AWARDS</p>
            </div>
            <div class="dash-btn analysis" onclick="openAnalysisScreen()">
                <div class="dash-icon">ğŸ©¹</div>
                <h2>é†«ç™‚ä¸­å¿ƒ</h2>
                <p>WEAKNESS</p>
            </div>
        </div>
        
        <div class="safe-exit-area">
            <a href="index.html" class="btn-safe-exit">ğŸ”Œ é›¢é–‹éŠæˆ² (å›è€å¸«/é¦–é )</a>
        </div>
    </div>

    <div id="unitSelectScreen" class="screen">
        <div class="page-header">
            <button class="btn-pixel btn-back" onclick="goHome()">â¬… MENU</button>
            <h2 class="page-title">SELECT MAP</h2>
            <div style="width: 80px;"></div>
        </div>
        <div id="unitGridContainer" class="unit-grid"></div>
    </div>

    <div id="studyOverviewScreen" class="screen">
        <div class="page-header">
            <button class="btn-pixel btn-back" onclick="openUnitSelector('study')">â¬… MAP</button>
            <h2 class="page-title" id="overviewTitle">Unit A</h2>
            <div style="width:60px;"></div>
        </div>
        <div style="text-align:center; color:#555; margin-bottom:15px; font-weight:bold; font-family:'Microsoft JhengHei';">ğŸ‘‡ é»æ“Šå¡ç‰‡é–‹å§‹ä¿®ç·´</div>
        <div id="overviewGrid" class="word-overview-grid"></div>
        <div style="position:fixed; bottom:20px; left:50%; transform:translateX(-50%); width:90%; max-width:600px;">
            <button class="btn-pixel btn-success" style="width:100%; box-shadow: 6px 6px 0 rgba(0,0,0,0.5);" onclick="quickQuizFromStudy()">âš¡ ç«‹å³æˆ°é¬¥ (æ¸¬é©—æ­¤å–®å…ƒ)</button>
        </div>
    </div>

    <div id="studyDetailScreen" class="screen">
        <div class="page-header">
            <button class="btn-pixel btn-back" onclick="backToOverview()">â¬… LIST</button>
            <div style="font-weight:bold; color:#fff; text-shadow:2px 2px 0 #000; font-size:1.5rem;">Word <span id="detailIdx">1</span> / <span id="detailTotal">20</span></div>
            <div style="width:80px;"></div>
        </div>

        <div class="pixel-card detail-box">
            <div style="display:flex; align-items:center; justify-content:center; gap:15px; margin:20px 0 10px;">
                <div class="detail-word" id="cardWord">Apple</div>
                <button class="btn-speak-inline" onclick="playCurrentCardAudio()">ğŸ”Š</button>
            </div>
            <div class="detail-zh" id="cardZh">è˜‹æœ</div>
            <div class="detail-sent-box">
                <div class="detail-sent-en" id="cardSentEn">I eat an apple.</div>
                <div class="detail-sent-zh" id="cardSentZh">æˆ‘åƒä¸€é¡†è˜‹æœã€‚</div>
                <button class="btn-small-audio" onclick="playCurrentCardSent()">ğŸ”Š</button>
            </div>
        </div>
        <div class="nav-controls">
            <button class="btn-pixel" onclick="prevCard()">â—€ PREV</button>
            <button class="btn-pixel" onclick="nextCard()">NEXT â–¶</button>
        </div>
    </div>

    <div id="quizSetupScreen" class="screen">
        <div class="page-header">
            <button class="btn-pixel btn-back" onclick="goHome()">â¬… MENU</button>
            <h2 class="page-title">SETUP</h2>
            <div style="width:80px;"></div>
        </div>

        <div class="pixel-card">
            <div class="setup-label">1. é¸æ“‡æ­¦å™¨ (é¡Œå‹)</div>
            <div class="toggle-group">
                <button class="toggle-btn active" id="modeChoice" onclick="setQuizMode('choice')">ğŸ‘† é¸æ“‡é¡Œ</button>
                <button class="toggle-btn" id="modeSpelling" onclick="setQuizMode('spelling')">âŒ¨ï¸ æ‹¼å­—é¡Œ</button>
            </div>
        </div>

        <div class="pixel-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div class="setup-label" style="margin:0; border:none;">2. é¸æ“‡æˆ°å ´ (ç¯„åœ)</div>
                <button class="btn-pixel btn-danger" style="width:auto; font-size:0.8rem; padding:5px 10px;" onclick="clearAllSelectedWords()">RESET</button>
            </div>
            <div style="margin:10px 0;">ç›®å‰å·²é¸ï¼š<b id="totalSelectedCount" style="color:var(--primary); font-size:1.5rem;">0</b> å€‹å­—</div>
            <div id="quizRangeGrid" class="range-selector"></div>
        </div>

        <div class="pixel-card">
            <div class="setup-label">3. é›£åº¦è¨­å®š</div>
            <div class="setting-row">
                <span>è‡ªå‹•ä¸‹ä¸€é—œ</span>
                <label class="switch"><input type="checkbox" id="setupAutoNext" checked><span class="slider"></span></label>
            </div>
            <div class="setting-row">
                <span>8ç§’é™æ™‚</span>
                <label class="switch"><input type="checkbox" id="setupTimer"><span class="slider"></span></label>
            </div>
        </div>

        <button class="btn-pixel btn-danger" style="width:100%; font-size:1.8rem;" onclick="startConfiguredQuiz()">ğŸš€ FIGHT!</button>
    </div>

    <div id="wordPickerModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-shrink:0;">
                <h3 id="pickerTitle" style="margin:0; font-size:1.5rem;">æŒ‘é¸å–®å­—</h3>
                <span style="font-size:2rem; cursor:pointer;" onclick="closeWordPicker_Cancel()">Ã—</span>
            </div>
            <div class="picker-actions">
                <button class="btn-pixel" style="padding:5px; font-size:0.9rem;" onclick="pickerSelectViewed()">åƒ…å·²è®€</button>
                <button class="btn-pixel" style="padding:5px; font-size:0.9rem;" onclick="pickerSelectAll()">å…¨é¸</button>
                <button class="btn-pixel" style="padding:5px; font-size:0.9rem;" onclick="pickerSelectNone()">å…¨æ¶ˆ</button>
            </div>
            <div id="pickerGrid" class="word-picker-container"></div>
            <div style="margin-top:15px; flex-shrink:0;">
                <div id="btnPickerSave" style="display:flex; gap:10px;">
                    <button class="btn-pixel btn-cancel" style="flex:1;" onclick="closeWordPicker_Cancel()">âŒ å–æ¶ˆ</button>
                    <button class="btn-pixel btn-success" style="flex:1;" onclick="closeWordPicker_Confirm()">â­• ç¢ºå®š</button>
                </div>
                <div id="btnPickerQuickStart" style="display:none; gap:10px;">
                    <button class="btn-pixel btn-cancel" style="flex:0.5;" onclick="closeWordPicker_Cancel()">âŒ</button>
                    <button class="btn-pixel btn-success" style="flex:1;" onclick="startQuickQuizDirect('choice')">é¸æ“‡é¡Œ</button>
                    <button class="btn-pixel btn-warning" style="flex:1;" onclick="startQuickQuizDirect('spelling')">æ‹¼å­—é¡Œ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="quizScreen" class="screen">
        <div class="quiz-settings-bar">
            <div class="mini-setting">
                <span>â© è‡ªå‹•æ›é¡Œ</span>
                <label class="switch"><input type="checkbox" id="ingameAutoNext" onchange="toggleAutoNext(this.checked)"><span class="slider"></span></label>
            </div>
            <div class="mini-setting">
                <span>â±ï¸ è¨ˆæ™‚å™¨</span>
                <label class="switch"><input type="checkbox" id="ingameTimer" onchange="toggleTimer(this.checked)"><span class="slider"></span></label>
            </div>
        </div>
        <div class="quiz-status">
            <span>Q: <span id="qIdx">1</span>/<span id="qTotal">10</span></span>
            <span id="timerBadge" style="color:#ff5252; display:none;">â±ï¸ <span id="timeLeft">8</span></span>
            <button style="border:none; background:none; color:#fff; font-weight:bold; cursor:pointer;" onclick="quitQuiz()">ğŸ³ï¸ æ”¾æ£„</button>
        </div>
        <div class="pixel-card" style="text-align:center; padding:30px 20px;">
            <div style="font-size:4rem; cursor:pointer;" onclick="playQuizSequence()">ğŸ”Š</div>
            <div id="qHint" class="q-hint" style="display:none;"></div>
            <button id="btnShowHint" class="btn-pixel" style="width:auto; margin:20px auto 0;" onclick="showHint()">ğŸ’¡ æç¤º</button>
        </div>
        <div id="choiceArea" class="choice-grid" style="display:none;"></div>
        <div id="spellingArea" style="display:none; text-align:center;">
            <input type="text" id="spellingInput" class="input-spelling" placeholder="TYPE HERE..." autocomplete="off">
            <div id="spellingFeedback" style="height:25px; font-weight:bold; margin-bottom:10px; font-size:1.5rem;"></div>
            <button class="btn-pixel btn-success" style="width:100%;" onclick="checkSpelling()">ATTACK (é€å‡º)</button>
        </div>
        <button id="btnNextQ" class="btn-pixel" style="width:100%; margin-top:20px; display:none;" onclick="nextQuestion()">â¡ NEXT</button>
    </div>

    <div id="resultScreen" class="screen">
        <div class="pixel-card" style="text-align:center; padding:30px;">
            <div style="font-size:5rem;">ğŸ†</div>
            <h2 style="font-size:3rem; margin:10px 0;">VICTORY!</h2>
            <div id="finalScore" style="font-size:5rem; font-weight:900; color:var(--primary); margin:10px 0; text-shadow:4px 4px 0 #000;">100</div>
            <p id="finalMsg" style="font-size:1.5rem; color:#555; margin-bottom:20px;">PERFECT!</p>
            <div style="text-align:left; font-weight:bold; margin-bottom:5px;">ğŸ“ æˆ°å ± (Battle Report):</div>
            <div id="quizReviewList" class="result-list"></div>
            <button class="btn-pixel btn-success" style="width:100%; margin-bottom:15px;" onclick="goHome()">ğŸ  HOME</button>
            <button class="btn-pixel" style="width:100%;" onclick="retryQuiz()">ğŸ”„ RETRY</button>
        </div>
    </div>

    <div id="achievementScreen" class="screen">
        <div class="page-header"><button class="btn-pixel btn-back" onclick="goHome()">â¬… MENU</button><h2 class="page-title">TROPHIES</h2><div style="width:80px;"></div></div>
        <div class="achievement-container"><div id="badgeGrid" class="achievement-grid"></div></div>
    </div>
    <div id="analysisScreen" class="screen">
        <div class="page-header"><button class="btn-pixel btn-back" onclick="goHome()">â¬… MENU</button><h2 class="page-title">WEAKNESS</h2><div style="width:80px;"></div></div>
        <div class="pixel-card"><div class="weak-header">âš ï¸ BOSS (Top 3)</div><div id="topWeakList" style="display:flex; gap:10px; overflow-x:auto;"></div></div>
        <div class="pixel-card"><div style="font-weight:bold; margin-bottom:10px;">ğŸ“ æ•—ç¸¾ç´€éŒ„</div><div id="fullMistakeList" class="full-mistake-list" style="max-height:250px; overflow-y:auto;"></div></div>
        <button class="btn-pixel btn-danger" style="width:100%;" onclick="startTop30WeaknessQuiz()">ğŸ”¥ æŒ‘æˆ°é­”ç‹ (Top 30)</button>
    </div>

<script src="words.js"></script>
<script>
    let sessions = [], viewedWords = new Set(), studyData = { sid: null, list: [], currentIndex: 0 };
    let quizConfig = { mode: 'choice', selectedWords: new Set(), timer: false, autoNext: true };
    let quizData = { list: [], index: 0, score: 0, timerId: null, results: [] };
    let currentPickerSid = null, isQuickQuizPicker = false, tempSelectedWords = new Set(); 
    let userStats = { wordsViewedCount: 0, quizCount: 0, totalCorrect: 0, totalMistakes: 0 };
    let unlockedTitles = new Set();
    
    // Voice List (Lazy Load & Apple Fix)
    let availableVoices = [];
    function initVoices() {
        availableVoices = window.speechSynthesis.getVoices();
        // Safari voices load async, sometimes need a retry
        if (availableVoices.length === 0) {
            setTimeout(initVoices, 500);
        }
    }
    // Apple needs this to trigger loading voices
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = initVoices;
    }
    initVoices();

    const achievements = [
        { id: 'view_5', category: 'learn', tier: 'common', icon: 'ğŸªµ', title: 'å–®å­—å°èŒæ–°', desc: 'çœ‹é 5 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 5 },
        { id: 'view_20', category: 'learn', tier: 'common', icon: 'ğŸ•¯ï¸', title: 'å……æ»¿å¥½å¥‡', desc: 'çœ‹é 20 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 20 },
        { id: 'view_50', category: 'learn', tier: 'common', icon: 'ğŸ“œ', title: 'ç´¯ç©å¯¦åŠ›', desc: 'çœ‹é 50 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 50 },
        { id: 'view_80', category: 'learn', tier: 'rare', icon: 'ğŸ““', title: 'æ¼¸å…¥ä½³å¢ƒ', desc: 'çœ‹é 80 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 80 },
        { id: 'view_100', category: 'learn', tier: 'rare', icon: 'ğŸ“˜', title: 'è¨˜æ†¶è¶…äºº', desc: 'çœ‹é 100 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 100 },
        { id: 'view_200', category: 'learn', tier: 'rare', icon: 'ğŸ“', title: 'åšå­¸å¤šè', desc: 'çœ‹é 200 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 200 },
        { id: 'view_300', category: 'learn', tier: 'epic', icon: 'ğŸ”®', title: 'å–®å­—ç‹è€…', desc: 'çœ‹é 300 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 300 },
        { id: 'view_500', category: 'learn', tier: 'epic', icon: 'ğŸ§™â€â™‚ï¸', title: 'å¤§è³¢è€…', desc: 'çœ‹é 500 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 500 },
        { id: 'view_all', category: 'learn', tier: 'legendary', icon: 'ğŸª', title: 'å…¨çŸ¥å…¨èƒ½', desc: 'çœ‹éæ‰€æœ‰å–®å­—', check: (s) => s.wordsViewedCount >= 800 },
        { id: 'unit_1', category: 'unit', tier: 'common', icon: 'ğŸš©', title: 'åˆæˆ°å‘Šæ·', desc: 'å®Œæˆ 1 å€‹å–®å…ƒ', check: () => checkUnitsCompleted(1) },
        { id: 'unit_3', category: 'unit', tier: 'rare', icon: 'â›º', title: 'ä¸‰å…ƒåŠç¬¬', desc: 'å®Œæˆ 3 å€‹å–®å…ƒ', check: () => checkUnitsCompleted(3) },
        { id: 'unit_5', category: 'unit', tier: 'rare', icon: 'ğŸ›–', title: 'äº”æ˜Ÿä¸Šå°‡', desc: 'å®Œæˆ 5 å€‹å–®å…ƒ', check: () => checkUnitsCompleted(5) },
        { id: 'unit_10', category: 'unit', tier: 'epic', icon: 'ğŸ°', title: 'åå…¨åç¾', desc: 'å®Œæˆ 10 å€‹å–®å…ƒ', check: () => checkUnitsCompleted(10) },
        { id: 'unit_all', category: 'unit', tier: 'legendary', icon: 'ğŸ‘‘', title: 'åˆ¶éœ¸å…¨åœ‹', desc: 'å®Œæˆæ‰€æœ‰å–®å…ƒ', check: () => checkUnitsCompleted(sessions.length) },
        { id: 'alpha_1', category: 'alpha', tier: 'common', icon: 'ğŸ§©', title: 'å­—æ¯æœé›†', desc: 'å®Œæˆ 1 å€‹å­—æ¯', check: () => checkLettersCompleted(1) },
        { id: 'alpha_3', category: 'alpha', tier: 'rare', icon: 'ğŸ§±', title: 'æ‹¼å­—æ‹¼åœ–', desc: 'å®Œæˆ 3 å€‹å­—æ¯', check: () => checkLettersCompleted(3) },
        { id: 'alpha_5', category: 'alpha', tier: 'rare', icon: 'ğŸ—ï¸', title: 'èªå½™çµäºº', desc: 'å®Œæˆ 5 å€‹å­—æ¯', check: () => checkLettersCompleted(5) },
        { id: 'alpha_10', category: 'alpha', tier: 'epic', icon: 'ğŸ›ï¸', title: 'å­—æ¯å¤§äº¨', desc: 'å®Œæˆ 10 å€‹å­—æ¯', check: () => checkLettersCompleted(10) },
        { id: 'quiz_1', category: 'quiz', tier: 'common', icon: 'ğŸ—¡ï¸', title: 'å‹‡æ–¼æŒ‘æˆ°', desc: 'å®Œæˆ 1 æ¬¡æ¸¬é©—', check: (s) => s.quizCount >= 1 },
        { id: 'quiz_10', category: 'quiz', tier: 'rare', icon: 'âš”ï¸', title: 'æ¸¬é©—å¸¸å®¢', desc: 'å®Œæˆ 10 æ¬¡æ¸¬é©—', check: (s) => s.quizCount >= 10 },
        { id: 'quiz_50', category: 'quiz', tier: 'epic', icon: 'ğŸ›¡ï¸', title: 'èº«ç¶“ç™¾æˆ°', desc: 'å®Œæˆ 50 æ¬¡æ¸¬é©—', check: (s) => s.quizCount >= 50 },
        { id: 'correct_10', category: 'milestone', tier: 'common', icon: 'ğŸ’°', title: 'ç­”é¡Œæ–°æ‰‹', desc: 'ç´¯ç©ç­”å° 10 é¡Œ', check: (s) => s.totalCorrect >= 10 },
        { id: 'correct_100', category: 'milestone', tier: 'rare', icon: 'ğŸ’', title: 'æ™ºæ…§ä¹‹æ˜Ÿ', desc: 'ç´¯ç©ç­”å° 100 é¡Œ', check: (s) => s.totalCorrect >= 100 },
        { id: 'correct_500', category: 'milestone', tier: 'epic', icon: 'ğŸ†', title: 'ç¥æº–å°„æ‰‹', desc: 'ç´¯ç©ç­”å° 500 é¡Œ', check: (s) => s.totalCorrect >= 500 },
        { id: 'correct_1000', category: 'milestone', tier: 'legendary', icon: 'ğŸ‰', title: 'å‚³èªªå­¸éœ¸', desc: 'ç´¯ç©ç­”å° 1000 é¡Œ', check: (s) => s.totalCorrect >= 1000 },
        { id: 'secret_night', category: 'secret', tier: 'rare', icon: 'ğŸ§›', title: 'å¤œè²“å­', desc: 'æ™šä¸Š 8 é»å¾ŒèƒŒå–®å­—', secretDesc: 'æ·±å¤œå‡ºæ²’...', check: () => new Date().getHours() >= 20 },
        { id: 'secret_early', category: 'secret', tier: 'rare', icon: 'ğŸ”', title: 'æ—©èµ·çš„é³¥å…’', desc: 'æ—©ä¸Š 8 é»å‰èƒŒå–®å­—', secretDesc: 'æ—©èµ·çš„é³¥å…’...', check: () => new Date().getHours() < 8 },
        { id: 'secret_fail', category: 'secret', tier: 'epic', icon: 'ğŸ’€', title: 'æ„ˆæŒ«æ„ˆå‹‡', desc: 'ç´¯ç©ç­”éŒ¯ 50 æ¬¡', secretDesc: 'å¤±æ•—ç‚ºæˆåŠŸä¹‹æ¯...', check: (s) => s.totalMistakes >= 50 }
    ];

    window.onload = function() {
        if (typeof masterWordList === 'undefined') { alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è³‡æ–™åº« words.js"); return; }
        sessions = [...new Set(masterWordList.map(item => item.session))].sort();
        loadUserData();
        goHome();
    };
    
    // --- In-Game Toggle Functions ---
    function toggleAutoNext(checked) { quizConfig.autoNext = checked; }
    function toggleTimer(checked) { 
        quizConfig.timer = checked; 
        document.getElementById('timerBadge').style.display = checked ? 'inline-block' : 'none';
        if(checked) startTimer(); else clearInterval(quizData.timerId);
    }

    function loadUserData() {
        const savedViewed = localStorage.getItem('viewedWords');
        if (savedViewed) viewedWords = new Set(JSON.parse(savedViewed));
        const savedStats = localStorage.getItem('userStats');
        if (savedStats) {
            const parsed = JSON.parse(savedStats);
            userStats.quizCount = parsed.quizCount || 0;
            userStats.totalCorrect = parsed.totalCorrect || 0;
            userStats.totalMistakes = parsed.totalMistakes || 0;
            userStats.wordsViewedCount = viewedWords.size;
        }
        const savedTitles = localStorage.getItem('unlockedTitles');
        if (savedTitles) unlockedTitles = new Set(JSON.parse(savedTitles));
    }
    function saveUserData() { localStorage.setItem('viewedWords', JSON.stringify([...viewedWords])); localStorage.setItem('userStats', JSON.stringify(userStats)); localStorage.setItem('unlockedTitles', JSON.stringify([...unlockedTitles])); }
    function checkUnitsCompleted(t){ let c=0; sessions.forEach(s=>{ if(masterWordList.filter(w=>w.session===s).every(w=>viewedWords.has(w.word)))c++; }); return c>=t; }
    function checkLettersCompleted(t){ const l="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""); let c=0; l.forEach(char=>{ const ws=masterWordList.filter(w=>w.word.toUpperCase().startsWith(char)); if(ws.length>0&&ws.every(w=>viewedWords.has(w.word)))c++; }); return c>=t; }
    function checkAchievements(){ let n=false; userStats.wordsViewedCount=viewedWords.size; achievements.forEach(a=>{ if(!unlockedTitles.has(a.id)&&a.check(userStats)){ unlockedTitles.add(a.id); showToast(a.title,a.icon); n=true; } }); if(n)saveUserData(); }
    function showToast(t,i){ const toast=document.getElementById('toastNotification'); toast.querySelector('div').innerText=i||'ğŸ'; document.getElementById('toastMsg').innerText=t; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),3000); }
    function goHome(){ showScreen('homeScreen'); }
    function showScreen(id){ document.querySelectorAll('.screen').forEach(el=>el.classList.remove('active')); document.getElementById(id).classList.add('active'); window.scrollTo(0,0); clearInterval(quizData.timerId); window.speechSynthesis.cancel(); }
    
    // Enhanced Speak Function (Apple Fix)
    function getBestVoice() {
         // Priority: Google US -> Samantha (Mac) -> Daniel (iOS) -> Any US English -> Default
         return availableVoices.find(v => v.name === "Google US English") || 
                availableVoices.find(v => v.name === "Samantha") || 
                availableVoices.find(v => v.name === "Daniel") || 
                availableVoices.find(v => v.lang === 'en-US') ||
                availableVoices[0];
    }
    
    function speak(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        // iOS requires rate 1.0 or slightly less to sound natural with Daniel/Samantha
        u.rate = 1.0; 
        
        // Ensure voice loading
        if (availableVoices.length === 0) initVoices();
        
        const v = getBestVoice();
        if(v) u.voice = v;
        
        window.speechSynthesis.speak(u);
    }
    
    function openAchievementScreen(){
        const grid=document.getElementById('badgeGrid'); grid.innerHTML=""; const cats={ 'learn':'ğŸ“š å‹¤å­¸ä¹‹è·¯','unit':'ğŸ« Unit åˆ¶éœ¸','alpha':'ğŸ”¡ å­—æ¯è’é›†','quiz':'âš”ï¸ è©¦ç…‰æˆ°å ´','milestone':'ğŸ’ å‚³å¥‡é‡Œç¨‹ç¢‘','secret':'âœ¨ ç¥ç§˜å½©è›‹' };
        for(let c in cats){
            const h=document.createElement('div'); h.className=`category-header cat-${c}`; h.innerText=cats[c]; grid.appendChild(h);
            achievements.filter(a=>a.category===c).forEach(ach=>{
                const u=unlockedTitles.has(ach.id); const d=document.createElement('div'); d.className=`badge-card ${u?'unlocked':''} ${ach.tier}`;
                let i='ğŸ”’',t=ach.title,l="ğŸ¯ ç›®æ¨™ï¼š",de=ach.desc; if(u){i=ach.icon||'ğŸ†';}else{if(ach.category==='secret'){t='ï¼Ÿï¼Ÿï¼Ÿ';l="ğŸ•µï¸ ç·šç´¢ï¼š";de=ach.secretDesc;}}
                d.innerHTML=`<div class="badge-icon">${i}</div><div class="badge-title">${t}</div>${!u?`<div class="badge-hint-box">${l}${de}</div>`:`<div class="badge-desc">${de}</div>`}`; grid.appendChild(d);
            });
        } showScreen('achievementScreen');
    }

    function openAnalysisScreen(){
        const m=JSON.parse(localStorage.getItem('myMistakes'))||{}; const top=document.getElementById('topWeakList'), full=document.getElementById('fullMistakeList');
        let s=Object.keys(m).map(k=>({w:k,c:m[k]})).sort((a,b)=>b.c-a.c);
        if(s.length===0){ top.innerHTML="ç„¡éŒ¯é¡Œç´€éŒ„"; full.innerHTML=""; }else{
            top.innerHTML=""; s.slice(0,3).forEach((i,x)=>{ top.innerHTML+=`<div class="weak-item-card"><div style="font-size:1.5rem;">${x===0?'ğŸ¥‡':(x===1?'ğŸ¥ˆ':'ğŸ¥‰')}</div><span class="weak-word">${i.w}</span><span class="weak-count">éŒ¯ ${i.c} æ¬¡</span></div>`; });
            let h=""; s.forEach((i,x)=>{ h+=`<div class="mistake-row"><span class="rank-num">#${x+1}</span><span class="mistake-word">${i.w}</span><span class="mistake-val">éŒ¯ ${i.c} æ¬¡</span></div>`; }); full.innerHTML=h;
        } showScreen('analysisScreen');
    }

    function startTop30WeaknessQuiz(){
        const m=JSON.parse(localStorage.getItem('myMistakes'))||{}; const s=Object.keys(m).map(k=>({w:k,c:m[k]})).sort((a,b)=>b.c-a.c);
        if(s.length===0){alert("æ²’æœ‰éŒ¯é¡Œï¼");return;} const top=s.slice(0,30).map(i=>i.w);
        quizConfig.selectedWords=new Set(top); quizConfig.mode='choice'; quizConfig.timer=false; quizConfig.autoNext=true;
        document.getElementById('ingameTimer').checked=false; document.getElementById('ingameAutoNext').checked=true; startConfiguredQuiz();
    }

    function openUnitSelector(m){ currentMode=m; const g=document.getElementById('unitGridContainer'); g.innerHTML=""; sessions.forEach(s=>{ const c=masterWordList.filter(w=>w.session===s).length; const b=document.createElement('div'); b.className='unit-card'; b.innerHTML=`<h3>Unit ${s}</h3><span class="action-hint">${c} words â–¶</span>`; b.onclick=()=>loadStudyOverview(s); g.appendChild(b); }); showScreen('unitSelectScreen'); }
    function loadStudyOverview(s){ studyData.sid=s; studyData.list=masterWordList.filter(w=>w.session===s); document.getElementById('overviewTitle').innerText=`Unit ${s}`; renderOverviewGrid(); showScreen('studyOverviewScreen'); }
    function renderOverviewGrid(){ const g=document.getElementById('overviewGrid'); g.innerHTML=""; studyData.list.forEach((i,x)=>{ const c=document.createElement('div'); c.className='word-overview-card'; if(viewedWords.has(i.word))c.classList.add('read'); c.innerHTML=`<h4>${i.word}</h4>`; c.onclick=()=>openFlashcard(x); g.appendChild(c); }); }
    function openFlashcard(x){ studyData.currentIndex=x; updateFlashcardUI(); showScreen('studyDetailScreen'); }
    function updateFlashcardUI(){ const i=studyData.list[studyData.currentIndex]; if(!viewedWords.has(i.word)){ viewedWords.add(i.word); saveUserData(); checkAchievements(); } document.getElementById('detailIdx').innerText=studyData.currentIndex+1; document.getElementById('detailTotal').innerText=studyData.list.length; document.getElementById('cardWord').innerText=i.word; document.getElementById('cardZh').innerText=i.word_zh||''; document.getElementById('cardSentEn').innerText=i.sentence; document.getElementById('cardSentZh').innerText=i.sentence_zh||''; window.speechSynthesis.cancel(); setTimeout(()=>speak(i.word),300); }
    function prevCard(){ if(studyData.currentIndex>0){ studyData.currentIndex--; updateFlashcardUI(); } }
    function nextCard(){ if(studyData.currentIndex<studyData.list.length-1){ studyData.currentIndex++; updateFlashcardUI(); } }
    function backToOverview(){ renderOverviewGrid(); showScreen('studyOverviewScreen'); }
    function playCurrentCardAudio(){ window.speechSynthesis.cancel(); speak(studyData.list[studyData.currentIndex].word); }
    function playCurrentCardSent(){ window.speechSynthesis.cancel(); speak(studyData.list[studyData.currentIndex].sentence); }
    
    function quickQuizFromStudy(){ openQuickQuizPicker(); }
    function openQuickQuizPicker(){ isQuickQuizPicker=true; openWordPicker(studyData.sid); }
    function startQuickQuizDirect(m){ 
        quizConfig.mode=m; quizConfig.timer=false; quizConfig.autoNext=false; 
        document.getElementById('ingameTimer').checked=false; document.getElementById('ingameAutoNext').checked=false;
        closeWordPicker_Confirm(); startConfiguredQuiz(); 
    }

    function openQuizSetup(){
        quizConfig.mode='choice'; quizConfig.timer=false; quizConfig.autoNext=true; quizConfig.selectedWords=new Set();
        updateModeUI(); document.getElementById('setupTimer').checked=false; document.getElementById('setupAutoNext').checked=true;
        renderQuizRangeGrid(); updateTotalCount(); showScreen('quizSetupScreen');
    }
    function renderQuizRangeGrid(){ const g=document.getElementById('quizRangeGrid'); g.innerHTML=""; sessions.forEach(s=>{ const b=document.createElement('div'); b.className='range-btn'; const u=masterWordList.filter(w=>w.session===s); let c=0; u.forEach(w=>{if(quizConfig.selectedWords.has(w.word))c++;}); if(c>0)b.classList.add('has-data'); b.innerHTML=`Unit ${s} ${c>0?`<span class="badge-count">${c}</span>`:''}`; b.onclick=()=>{isQuickQuizPicker=false;openWordPicker(s);}; g.appendChild(b); }); }
    function setQuizMode(m){ quizConfig.mode=m; updateModeUI(); }
    function updateModeUI(){ document.getElementById('modeChoice').classList.toggle('active',quizConfig.mode==='choice'); document.getElementById('modeSpelling').classList.toggle('active',quizConfig.mode==='spelling'); }
    function clearAllSelectedWords(){ if(confirm("æ¸…é™¤æ‰€æœ‰ï¼Ÿ")){ quizConfig.selectedWords.clear(); renderQuizRangeGrid(); updateTotalCount(); } }
    function updateTotalCount(){ document.getElementById('totalSelectedCount').innerText=quizConfig.selectedWords.size; }

    function openWordPicker(sid){ currentPickerSid=sid; document.getElementById('pickerTitle').innerText=`æŒ‘é¸ (Unit ${sid})`; tempSelectedWords=new Set(); if(isQuickQuizPicker){ const u=masterWordList.filter(w=>w.session===sid); u.forEach(w=>{if(viewedWords.has(w.word))tempSelectedWords.add(w.word);}); document.getElementById('btnPickerSave').style.display='none'; document.getElementById('btnPickerQuickStart').style.display='flex'; }else{ const u=masterWordList.filter(w=>w.session===sid); u.forEach(w=>{if(quizConfig.selectedWords.has(w.word))tempSelectedWords.add(w.word);}); document.getElementById('btnPickerSave').style.display='flex'; document.getElementById('btnPickerQuickStart').style.display='none'; } document.getElementById('wordPickerModal').style.display='block'; renderPickerGrid(); }
    function closeWordPicker_Cancel(){ document.getElementById('wordPickerModal').style.display='none'; }
    function closeWordPicker_Confirm(){ document.getElementById('wordPickerModal').style.display='none'; const u=masterWordList.filter(w=>w.session===currentPickerSid); u.forEach(w=>quizConfig.selectedWords.delete(w.word)); tempSelectedWords.forEach(w=>quizConfig.selectedWords.add(w)); if(!isQuickQuizPicker){renderQuizRangeGrid(); updateTotalCount();} }
    function renderPickerGrid(){ const c=document.getElementById('pickerGrid'); c.innerHTML=""; const u=masterWordList.filter(w=>w.session===currentPickerSid); u.forEach(i=>{ const d=document.createElement('div'); d.className='picker-item'; if(tempSelectedWords.has(i.word))d.classList.add('picked'); d.innerText=i.word; d.onclick=()=>{ if(tempSelectedWords.has(i.word)){tempSelectedWords.delete(i.word);d.classList.remove('picked');}else{tempSelectedWords.add(i.word);d.classList.add('picked');} }; c.appendChild(d); }); }
    function pickerSelectAll(){ masterWordList.filter(w=>w.session===currentPickerSid).forEach(w=>tempSelectedWords.add(w.word)); renderPickerGrid(); }
    function pickerSelectNone(){ masterWordList.filter(w=>w.session===currentPickerSid).forEach(w=>tempSelectedWords.delete(w.word)); renderPickerGrid(); }
    function pickerSelectViewed(){ masterWordList.filter(w=>w.session===currentPickerSid).forEach(w=>{ if(viewedWords.has(w.word))tempSelectedWords.add(w.word); else tempSelectedWords.delete(w.word); }); renderPickerGrid(); }

    function startConfiguredQuiz(){
        if(quizConfig.selectedWords.size===0){alert("è«‹è‡³å°‘é¸1å€‹å­—ï¼");return;}
        if(document.getElementById('quizSetupScreen').classList.contains('active')){
            quizConfig.timer=document.getElementById('setupTimer').checked;
            quizConfig.autoNext=document.getElementById('setupAutoNext').checked;
            document.getElementById('ingameTimer').checked=quizConfig.timer;
            document.getElementById('ingameAutoNext').checked=quizConfig.autoNext;
        }
        let q=masterWordList.filter(w=>quizConfig.selectedWords.has(w.word));
        q.sort(()=>0.5-Math.random()); quizData.list=q; quizData.index=0; quizData.score=0; quizData.results=[];
        document.getElementById('choiceArea').style.display=(quizConfig.mode==='choice')?'grid':'none';
        document.getElementById('spellingArea').style.display=(quizConfig.mode==='spelling')?'block':'none';
        document.getElementById('timerBadge').style.display=quizConfig.timer?'inline-block':'none';
        document.getElementById('btnNextQ').style.display='none';
        showScreen('quizScreen'); loadQuestion();
    }

    function loadQuestion(){
        clearInterval(quizData.timerId); document.getElementById('btnNextQ').style.display='none';
        document.getElementById('qHint').style.display='none'; document.getElementById('btnShowHint').style.display='inline-block';
        const i=quizData.list[quizData.index]; document.getElementById('qIdx').innerText=quizData.index+1; document.getElementById('qTotal').innerText=quizData.list.length; document.getElementById('qHint').innerText=i.word_zh||"(ç„¡ä¸­æ–‡)";
        if(quizConfig.mode==='choice')renderChoices(i); else renderSpelling(); playQuizSequence();
    }
    function showHint(){ document.getElementById('qHint').style.display='block'; document.getElementById('btnShowHint').style.display='none'; }
    function playQuizSequence(){ const i=quizData.list[quizData.index]; window.speechSynthesis.cancel(); const u1=new SpeechSynthesisUtterance(i.word); u1.rate=0.9; const u2=new SpeechSynthesisUtterance(i.sentence); u2.rate=0.9; const u3=new SpeechSynthesisUtterance(i.word); u3.rate=0.9; 
    // Apple Fix
    const v=getBestVoice(); if(v){u1.voice=v;u2.voice=v;u3.voice=v;u1.rate=1.0;u2.rate=1.0;u3.rate=1.0;}
    u3.onend=function(){if(quizConfig.timer)startTimer();}; window.speechSynthesis.speak(u1); window.speechSynthesis.speak(u2); window.speechSynthesis.speak(u3); }
    
    function startTimer(){ clearInterval(quizData.timerId); let t=8; document.getElementById('timeLeft').innerText=t; document.getElementById('timerBadge').style.display='inline-block'; quizData.timerId=setInterval(()=>{ t--; document.getElementById('timeLeft').innerText=t; if(t<=0){clearInterval(quizData.timerId); handleTimeUp();} },1000); }
    
    function handleTimeUp(){
        speak("Time's up!"); const i=quizData.list[quizData.index]; saveMistake(i.word); userStats.totalMistakes++; quizData.results.push({word:i.word, correct:false, userAns:"(é€¾æ™‚)"});
        if(quizConfig.mode==='choice'){ const b=document.querySelectorAll('.btn-choice'); b.forEach(btn=>{ if(btn.innerText===i.word)btn.classList.add('correct'); btn.disabled=true; }); }
        else{ document.getElementById('spellingInput').value=i.word; document.getElementById('spellingInput').style.borderColor="var(--danger)"; }
        handleNextStep();
    }

    function handleNextStep(){ if(quizConfig.autoNext)setTimeout(nextQuestion,2000); else document.getElementById('btnNextQ').style.display='block'; }
    function nextQuestion(){ quizData.index++; if(quizData.index<quizData.list.length)loadQuestion(); else showResult(); }

    function renderChoices(item){
        const c=document.getElementById('choiceArea'); c.innerHTML=""; let o=[item]; let p=quizData.list.length>=4?quizData.list:masterWordList;
        while(o.length<4){ const r=p[Math.floor(Math.random()*p.length)]; if(!o.some(x=>x.word===r.word))o.push(r); }
        o.sort(()=>0.5-Math.random());
        o.forEach(opt=>{ const b=document.createElement('button'); b.className='btn-choice'; b.innerText=opt.word; b.onclick=()=>checkChoice(b,opt.word===item.word); c.appendChild(b); });
    }
    function checkChoice(btn,isCorrect){
        clearInterval(quizData.timerId); window.speechSynthesis.cancel();
        const all=document.querySelectorAll('.btn-choice'); all.forEach(b=>b.disabled=true); const cur=quizData.list[quizData.index];
        if(isCorrect){ btn.classList.add('correct'); quizData.score++; speak("Correct"); userStats.totalCorrect++; quizData.results.push({word:cur.word, correct:true}); }
        else{ btn.classList.add('wrong'); saveMistake(cur.word); speak("Wrong"); userStats.totalMistakes++; quizData.results.push({word:cur.word, correct:false, userAns:btn.innerText}); all.forEach(b=>{if(b.innerText===cur.word)b.classList.add('correct');}); }
        handleNextStep();
    }

    function renderSpelling(){ const i=document.getElementById('spellingInput'); i.value=""; i.disabled=false; i.style.borderColor="#000"; document.getElementById('spellingFeedback').innerText=""; i.focus(); }
    function checkSpelling(){
        clearInterval(quizData.timerId); window.speechSynthesis.cancel();
        const i=document.getElementById('spellingInput'); const cur=quizData.list[quizData.index]; const cor=cur.word.trim().toLowerCase(); const val=i.value.trim().toLowerCase(); i.disabled=true;
        if(val===cor||(cor.includes('(')&&cor.startsWith(val))){ i.style.borderColor="var(--success)"; quizData.score++; speak("Correct"); userStats.totalCorrect++; quizData.results.push({word:cur.word, correct:true}); }
        else{ i.style.borderColor="var(--danger)"; document.getElementById('spellingFeedback').innerText=`Ans: ${cur.word}`; document.getElementById('spellingFeedback').style.color="var(--danger)"; saveMistake(cur.word); speak("Wrong"); userStats.totalMistakes++; quizData.results.push({word:cur.word, correct:false, userAns:val}); }
        handleNextStep();
    }
    document.getElementById('spellingInput').addEventListener('keyup',function(e){if(e.key==='Enter'&&!this.disabled)checkSpelling();});

    function showResult(){
        userStats.quizCount++; saveUserData(); checkAchievements(); showScreen('resultScreen');
        const s=Math.round((quizData.score/quizData.list.length)*100); document.getElementById('finalScore').innerText=s;
        const l=document.getElementById('quizReviewList'); l.innerHTML="";
        quizData.results.forEach(r=>{ const d=document.createElement('div'); d.className='result-row'; d.innerHTML=`<div class="res-icon">${r.correct?'<span class="res-correct">â­•</span>':'<span class="res-wrong">âŒ</span>'}</div><div style="flex:1;"><div>${r.word}</div>${!r.correct?`<div style="font-size:0.8rem; color:#666;">ä½ ç­”: ${r.userAns}</div>`:''}</div>`; l.appendChild(d); });
    }

    function quitQuiz(){ if(confirm("ç¢ºå®šæ”¾æ£„ï¼Ÿ"))goHome(); }
    function retryQuiz(){ startConfiguredQuiz(); }
    function saveMistake(w){ let m=JSON.parse(localStorage.getItem('myMistakes'))||{}; m[w]=(m[w]||0)+1; localStorage.setItem('myMistakes',JSON.stringify(m)); }
</script>
</body>
</html>