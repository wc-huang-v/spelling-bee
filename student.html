<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¸ç”Ÿè‡ªä¸»ç·´ç¿’ v2.0</title>
    <style>
        /* --- ğŸ¨ 1. å­¸ç”Ÿç‰ˆå°ˆå±¬é…è‰² (é­”æ³•ç´«é¢¨æ ¼) --- */
        :root {
            --bg-color: #f4ecf7; /* æ·ºç´«è‰²èƒŒæ™¯ */
            --card-bg: #ffffff;
            --primary: #af7ac5;  /* æŸ”å’Œç´«ä¸»è‰² */
            --primary-dark: #884ea0;
            --accent: #f1c40f;   /* é»ƒè‰²é»ç¶´ */
            --success: #58d68d;  /* è–„è·ç¶  (å®Œæˆè‰²) */
            --success-bg: #e9f7ef;
            --danger: #ec7063;
            --text-main: #4a235a; /* æ·±ç´«è‰²æ–‡å­— */
            --radius-box: 20px;
            --radius-btn: 50px;
            --shadow: 0 8px 20px rgba(0,0,0,0.08);
        }

        body {
            font-family: 'Microsoft JhengHei', 'Varela Round', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 15px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
        }

        .app-container {
            width: 100%; max-width: 600px;
            background: var(--card-bg); border-radius: var(--radius-box);
            box-shadow: var(--shadow); overflow: hidden;
            border: 4px solid #fff; min-height: 85vh; position: relative;
        }

        header {
            background: var(--primary); color: white; padding: 15px;
            text-align: center; font-size: 1.2rem; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .home-btn {
            background: rgba(255,255,255,0.3); border: none; color: white;
            padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; font-weight:bold;
        }

        .screen { padding: 25px; display: none; animation: fadeIn 0.3s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* é¦–é é¸å–® */
        .menu-grid { display: grid; gap: 15px; margin-top: 30px; }
        .mode-card {
            background: white; border: 2px solid #e8e8e8; border-radius: 15px;
            padding: 25px; text-align: center; cursor: pointer; transition: 0.2s;
            box-shadow: 0 4px 0 #e8e8e8;
        }
        .mode-card:hover { transform: translateY(-3px); border-color: var(--primary); }
        .mode-card:active { transform: translateY(2px); box-shadow: none; }
        .mode-icon { font-size: 3rem; margin-bottom: 10px; display: block; }
        .mode-title { font-weight: 900; font-size: 1.4rem; color: var(--text-main); }
        .mode-desc { font-size: 1rem; color: #888; margin-top: 5px; }

        /* å–®å…ƒé¸æ“‡ */
        .session-select-area { margin-top: 20px; background: #fff; padding:15px; border-radius:15px; border:1px solid #eee; }
        select {
            width: 100%; padding: 12px; border-radius: 12px;
            border: 2px solid #d2b4de; font-size: 1.1rem; background: white; color: var(--text-main);
            outline: none;
        }

        /* --- ğŸ†• å–®å­—ç¸½è¡¨ (Grid) --- */
        .word-grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* å…©æ¬„ */
            gap: 15px;
            margin-top: 10px;
        }
        
        .grid-item {
            background: #fff;
            border: 2px solid #eee;
            border-radius: 15px;
            padding: 20px 10px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #555;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
            box-shadow: 0 4px 0 #eee;
        }
        .grid-item:active { transform: translateY(3px); box-shadow: none; }

        /* å·²è®€éçš„å–®å­—æ¨£å¼ */
        .grid-item.viewed {
            background-color: var(--success-bg);
            border-color: var(--success);
            color: #1d8348;
            box-shadow: 0 4px 0 #abebc6;
        }
        .grid-item.viewed::after {
            content: "âœ…";
            position: absolute; top: 5px; right: 5px; font-size: 0.8rem;
        }

        /* é ç¿’å¡ç‰‡ */
        .word-card {
            background: #fff; border: 3px dashed var(--primary); border-radius: 20px;
            padding: 40px 20px; text-align: center; margin-bottom: 20px; position: relative;
        }
        .wc-word { font-size: 3.5rem; font-weight: 900; color: var(--primary-dark); margin-bottom: 10px; word-break: break-word;}
        .wc-sentence { font-size: 1.2rem; color: #555; background: #fbfcfc; padding: 15px; border-radius: 10px; text-align: left; }
        
        /* æ¸¬é©—å€ */
        .quiz-status { text-align: right; color: #999; margin-bottom: 10px; }
        .quiz-input {
            width: 100%; padding: 15px; font-size: 1.5rem; text-align: center;
            border: 2px solid #d2b4de; border-radius: 12px; outline: none;
            margin-bottom: 15px; letter-spacing: 1px; color: var(--text-main);
        }
        .quiz-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(175, 122, 197, 0.2); }
        
        .feedback-area {
            min-height: 40px; text-align: center; font-weight: bold; margin-bottom: 15px; font-size: 1.2rem;
        }
        .correct { color: var(--success); }
        .wrong { color: var(--danger); }

        /* æŒ‰éˆ•ç¾¤ */
        .btn-main {
            width: 100%; padding: 15px; background: var(--primary); color: white;
            border: none; border-radius: 50px; font-size: 1.2rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 5px 0 var(--primary-dark); transition: 0.1s;
            margin-bottom: 10px;
        }
        .btn-main:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-audio {
            width: 60px; height: 60px; border-radius: 50%; background: var(--accent);
            border: none; font-size: 1.5rem; cursor: pointer; color: #fff;
            box-shadow: 0 4px 0 #d4ac0d; margin: 0 auto 20px; display: block;
        }
        .btn-audio:active { transform: translateY(3px); box-shadow: none; }

        .btn-nav-group { display: flex; gap: 10px; justify-content: center; }
        .btn-small {
            padding: 10px 20px; background: #ecf0f1; border: none; border-radius: 30px;
            color: #7f8c8d; cursor: pointer; font-weight: bold; font-size: 1rem;
        }

    </style>
</head>
<body>

<div class="app-container">
    <header>
        <span>ğŸ”® å­¸ç”Ÿç·´ç¿’å€</span>
        <button class="home-btn" onclick="goHome()">ğŸ  å›é¦–é </button>
    </header>

    <div id="homeScreen" class="screen active">
        <div style="text-align:center; margin-bottom:10px; margin-top:20px;">
            <h2 style="color:var(--primary-dark);">Ready to learn?</h2>
            <p style="color:#888;">é¸æ“‡å–®å…ƒï¼Œé–‹å§‹ä½ çš„é­”æ³•ç·´ç¿’å§ï¼</p>
        </div>

        <div class="session-select-area">
            <label style="display:block; margin-bottom:8px; color:var(--text-main); font-weight:bold;">ğŸ“ è«‹é¸æ“‡å–®å…ƒï¼š</label>
            <select id="sessionSelect"></select>
        </div>

        <div class="menu-grid">
            <div class="mode-card" onclick="startReviewGrid()">
                <span class="mode-icon">ğŸ“–</span>
                <div class="mode-title">å–®å­—é ç¿’</div>
                <div class="mode-desc">ç€è¦½å–®å­—å¡ï¼Œç´¯ç©ç¶“é©—å€¼</div>
            </div>
            <div class="mode-card" onclick="startQuiz()">
                <span class="mode-icon">âœï¸</span>
                <div class="mode-title">è½å¯«æŒ‘æˆ°</div>
                <div class="mode-desc">è½é¡Œç›®æ‹¼å–®å­—</div>
            </div>
        </div>
        <div id="loadStatus" style="text-align:center; margin-top:20px; color:#aaa; font-size:0.8rem;"></div>
    </div>

    <div id="gridScreen" class="screen">
        <h3 style="text-align:center; color:var(--primary-dark); margin-bottom:15px;">é€™å€‹å–®å…ƒæœ‰é€™äº›å­—...</h3>
        <p style="text-align:center; color:#888; font-size:0.9rem;">é»æ“Šå–®å­—é€²å…¥å¡ç‰‡ï¼Œçœ‹éçš„æœƒè®Šç¶ è‰²å–”ï¼</p>
        
        <div id="wordGrid" class="word-grid-container">
            </div>

        <button class="btn-main" onclick="goHome()" style="margin-top:30px; background:#bdc3c7; box-shadow:0 5px 0 #95a5a6;">å›ä¸Šä¸€é </button>
    </div>

    <div id="flashcardScreen" class="screen">
        <div class="word-card">
            <div class="wc-word" id="revWord">...</div>
            <button class="btn-audio" onclick="playWord()">ğŸ”Š</button>
            <div class="wc-sentence" id="revSentence">...</div>
        </div>

        <button class="btn-main" onclick="backToGrid()">ğŸ†— çœ‹å®Œäº†ï¼Œå›ç¸½è¡¨</button>
        
        <div style="display:flex; justify-content:space-between; margin-top:15px;">
            <button class="btn-small" onclick="prevReview()">â¬… ä¸Šä¸€å€‹</button>
            <button class="btn-small" onclick="nextReview()">ä¸‹ä¸€å€‹ â¡</button>
        </div>
    </div>

    <div id="quizScreen" class="screen">
        <div class="quiz-status">é€²åº¦ <span id="quizIndex">1</span> / <span id="quizTotal">10</span></div>
        
        <div style="text-align:center; margin-bottom:20px;">
            <div style="font-size:1rem; color:#888; margin-bottom:10px;">é»æ“Šè½é¡Œç›®</div>
            <button class="btn-audio" onclick="playQuestionSequence()" style="width:80px; height:80px; font-size:2rem;">ğŸ”Š</button>
            <div style="font-size:0.8rem; color:#aaa;">(é †åºï¼šå­— â¡ å¥ â¡ å­—)</div>
        </div>

        <input type="text" id="userSpelling" class="quiz-input" placeholder="è¼¸å…¥å–®å­—..." autocomplete="off" autocapitalize="off">
        
        <div id="quizFeedback" class="feedback-area"></div>

        <button class="btn-main" onclick="checkAnswer()">é€å‡ºæª¢æŸ¥</button>
        <button class="btn-small" onclick="showAnswer()" style="width:100%; margin-top:10px; background:transparent; border:1px solid #ccc;">ğŸ™ˆ æˆ‘ä¸æœƒï¼Œå·çœ‹ç­”æ¡ˆ</button>
        <button class="btn-small" id="nextQuizBtn" onclick="nextQuiz()" style="width:100%; margin-top:10px; display:none; background:var(--primary); color:white;">ä¸‹ä¸€é¡Œ â¡</button>
    </div>

    <div id="finishScreen" class="screen" style="text-align:center;">
        <div style="font-size:5rem; margin-top:30px;">ğŸ†</div>
        <h2 style="color:var(--text-main);">æŒ‘æˆ°æˆåŠŸï¼</h2>
        <p style="color:#555;">ä½ å®Œæˆç·´ç¿’äº†ï¼ŒçœŸå²å®³ï¼</p>
        <button class="btn-main" onclick="goHome()">å›é¦–é é¸å–®</button>
    </div>

</div>

<script src="words.js"></script>

<script>
    let db = [];
    let currentList = [];
    let currentIndex = 0;
    
    // ç”¨ä¾†è¨˜éŒ„å“ªäº›å–®å­—å·²ç¶“çœ‹éäº† (å­˜ index)
    let viewedIndices = new Set();

    // åˆå§‹åŒ–
    window.onload = function() {
        if (typeof masterWordList !== 'undefined') {
            db = masterWordList;
            initSessions();
            document.getElementById('loadStatus').innerText = "âœ… é­”æ³•æ›¸è¼‰å…¥å®Œç•¢";
        } else {
            document.getElementById('loadStatus').innerHTML = "<span style='color:red'>âš ï¸ æ‰¾ä¸åˆ° words.js æª”æ¡ˆ</span>";
        }
    };

    function initSessions() {
        const sessions = [...new Set(db.map(x => x.session))].sort((a,b)=>a-b);
        const sel = document.getElementById('sessionSelect');
        sessions.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s;
            opt.innerText = `ç¬¬ ${s} å–®å…ƒ`;
            sel.appendChild(opt);
        });
    }

    function goHome() { showScreen('homeScreen'); }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function prepareList() {
        const session = parseInt(document.getElementById('sessionSelect').value);
        currentList = db.filter(x => x.session === session);
        currentIndex = 0;
    }

    // --- ğŸ†• ç¸½è¡¨æ¨¡å¼é‚è¼¯ (Grid Mode) ---
    function startReviewGrid() {
        prepareList();
        if(currentList.length === 0) { alert("æ­¤å–®å…ƒæ²’æœ‰å–®å­—å–”ï¼"); return; }
        
        // å¦‚æœæ›äº†å–®å…ƒï¼Œé‡ç½®é–±è®€ç´€éŒ„ (ç°¡å–®èµ·è¦‹ï¼Œæ¯æ¬¡å›é¦–é é‡ç½®ï¼Œæˆ–ä¿ç•™çš†å¯ã€‚é€™è£¡åšã€Œç•¶æ¬¡ç·´ç¿’ä¿ç•™ã€)
        // è‹¥å¸Œæœ›åˆ‡æ›å–®å…ƒæ¸…ç©ºç´€éŒ„ï¼š viewedIndices.clear(); 
        // é€™è£¡æˆ‘å€‘åªåœ¨ç¬¬ä¸€æ¬¡é€²å…¥è©²sessionæ™‚æ¸…ç©ºï¼Œæˆ–æ˜¯ç°¡å–®é»ï¼Œæ¯æ¬¡æŒ‰é ç¿’éƒ½é‡ç½®ï¼Ÿ
        // ç‚ºäº†è®“å­¸ç”Ÿæœ‰æˆå°±æ„Ÿï¼Œæˆ‘å€‘é€™è£¡ä¸å¼·åˆ¶æ¸…ç©ºï¼Œé™¤éé‡æ–°æ•´ç†ç¶²é ã€‚

        renderGrid();
        showScreen('gridScreen');
    }

    function renderGrid() {
        const container = document.getElementById('wordGrid');
        container.innerHTML = ""; // æ¸…ç©º

        currentList.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'grid-item';
            div.innerText = item.word;
            
            // æª¢æŸ¥æ˜¯å¦çœ‹é
            if (viewedIndices.has(item.word)) { // ç”¨å–®å­—ç•¶ key æ¯”è¼ƒä¿éšªï¼Œè·¨å–®å…ƒä¸æœƒéŒ¯äº‚
                div.classList.add('viewed');
            }

            div.onclick = () => {
                jumpToCard(index);
            };
            container.appendChild(div);
        });
    }

    function jumpToCard(index) {
        currentIndex = index;
        showScreen('flashcardScreen');
        updateReviewCard();
        
        // æ¨™è¨˜ç‚ºå·²è®€
        markAsViewed();
    }

    function backToGrid() {
        renderGrid(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é¡è‰²
        showScreen('gridScreen');
    }

    function markAsViewed() {
        const item = currentList[currentIndex];
        viewedIndices.add(item.word);
    }

    // --- å–®å­—å¡é‚è¼¯ ---
    function updateReviewCard() {
        const item = currentList[currentIndex];
        document.getElementById('revWord').innerText = item.word;
        document.getElementById('revSentence').innerText = item.sentence;
        
        // è‡ªå‹•ç™¼éŸ³ (é¸æ“‡æ€§ï¼Œæ€•å­¸ç”Ÿè¦ºå¾—åµå¯ä»¥æ‹¿æ‰)
        // playWord(); 

        markAsViewed(); // åªè¦ç¿»åˆ°é€™å¼µå¡ï¼Œå°±æ¨™è¨˜
    }

    function playWord() {
        const item = currentList[currentIndex];
        speak(item.word);
    }

    function prevReview() {
        if(currentIndex > 0) { currentIndex--; updateReviewCard(); }
    }
    function nextReview() {
        if(currentIndex < currentList.length - 1) { currentIndex++; updateReviewCard(); }
        else { 
            if(confirm("é€™æ˜¯æœ€å¾Œä¸€å€‹å­—äº†ï¼Œè¦å›ç¸½è¡¨å—ï¼Ÿ")) backToGrid();
        }
    }

    // --- æ¸¬é©—æ¨¡å¼é‚è¼¯ ---
    function startQuiz() {
        prepareList();
        currentList.sort(() => Math.random() - 0.5); // éš¨æ©Ÿ
        if(currentList.length === 0) { alert("ç„¡å–®å­—"); return; }
        showScreen('quizScreen');
        loadQuizQuestion();
    }

    function loadQuizQuestion() {
        document.getElementById('quizIndex').innerText = currentIndex + 1;
        document.getElementById('quizTotal').innerText = currentList.length;
        document.getElementById('userSpelling').value = "";
        document.getElementById('quizFeedback').innerText = "";
        document.getElementById('nextQuizBtn').style.display = 'none';
        
        setTimeout(playQuestionSequence, 500);
    }

    function playQuestionSequence() {
        const item = currentList[currentIndex];
        window.speechSynthesis.cancel();
        
        const u1 = new SpeechSynthesisUtterance(item.word); u1.lang = 'en-US'; u1.rate = 0.8;
        const u2 = new SpeechSynthesisUtterance(item.sentence); u2.lang = 'en-US'; u2.rate = 0.8;
        const u3 = new SpeechSynthesisUtterance(item.word); u3.lang = 'en-US'; u3.rate = 0.8;

        window.speechSynthesis.speak(u1);
        window.speechSynthesis.speak(u2);
        window.speechSynthesis.speak(u3);
    }

    function checkAnswer() {
        const userAns = document.getElementById('userSpelling').value.trim().toLowerCase();
        const correctAns = currentList[currentIndex].word.trim().toLowerCase();
        const feedback = document.getElementById('quizFeedback');

        if (userAns === correctAns) {
            feedback.innerHTML = "âœ… ç­”å°äº†ï¼å¤ªæ£’äº†ï¼";
            feedback.className = "feedback-area correct";
            playDing();
            document.getElementById('nextQuizBtn').style.display = 'block';
        } else {
            feedback.innerHTML = "âŒ å†è©¦ä¸€æ¬¡å–”ï¼";
            feedback.className = "feedback-area wrong";
            speak(currentList[currentIndex].word);
        }
    }

    function showAnswer() {
        const item = currentList[currentIndex];
        document.getElementById('userSpelling').value = item.word;
        document.getElementById('quizFeedback').innerHTML = `ğŸ’¡ ç­”æ¡ˆæ˜¯ï¼š<span style="color:blue">${item.word}</span>`;
        document.getElementById('nextQuizBtn').style.display = 'block';
    }

    function nextQuiz() {
        currentIndex++;
        if (currentIndex < currentList.length) { loadQuizQuestion(); } 
        else { showScreen('finishScreen'); }
    }

    function speak(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; u.rate = 0.8;
        window.speechSynthesis.speak(u);
    }

    function playDing() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.frequency.setValueAtTime(800, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(400, ctx.currentTime + 0.3);
        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        osc.start(); osc.stop(ctx.currentTime + 0.3);
    }
</script>
</body>
</html>