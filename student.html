<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¸ç”Ÿè‡ªä¸»å­¸ç¿’å¹³æ¿ v44.0 (Retro RPG)</title>
    <style>
        /* --- ğŸ¨ è¦–è¦ºé¢¨æ ¼ï¼šå¾©å¤ 8-bit RPG --- */
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap'); /* å˜—è©¦å¼•å…¥åƒç´ å­—é«”ï¼Œè‹¥ç„¡å‰‡é€€å› Monospace */

        :root {
            --bg-color: #5c94fc; /* ç¶“å…¸é¦¬åŠ›æ­è—å¤© */
            --panel-bg: #fceabb;
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --accent: #f59e0b;
            
            /* ç¨€æœ‰åº¦é¡è‰² (RPG ç­‰ç´š) */
            --tier-common: #cd7f32;  /* éŠ… (Bronze) */
            --tier-rare: #c0c0c0;    /* éŠ€ (Silver) */
            --tier-epic: #ffd700;    /* é‡‘ (Gold) */
            --tier-legend: #e0b0ff;  /* å‚³èªª (Purple) */
            
            /* å¾©å¤é‚Šæ¡†è‰² */
            --border-light: #ffffff;
            --border-dark: #000000;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'VT323', 'Courier New', monospace; /* å¾©å¤å­—é«” */ }
        
        body { 
            background-color: var(--bg-color); 
            /* é»é™£åœ–èƒŒæ™¯ç´‹ç† */
            background-image: radial-gradient(#ffffff 20%, transparent 20%), radial-gradient(#ffffff 20%, transparent 20%);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
            color: #333; margin: 0; padding: 20px; 
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; 
        }

        /* --- é é¢åˆ‡æ›ç‰¹æ•ˆ --- */
        .screen { display: none; width: 100%; max-width: 700px; animation: popIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        .screen.active { display: block; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* --- å¾©å¤æŒ‰éˆ•èˆ‡æ¡† --- */
        .pixel-box {
            background: #fff;
            border: 4px solid var(--border-dark);
            box-shadow: 6px 6px 0px rgba(0,0,0,0.3);
            border-radius: 4px; /* å¾®åœ“è§’ï¼Œä¿æŒåƒç´ æ„Ÿ */
            padding: 20px;
            position: relative;
        }

        .btn-pixel {
            background: #fff; border: 4px solid var(--border-dark);
            padding: 10px 20px; font-size: 1.2rem; font-weight: bold; cursor: pointer;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.3);
            text-transform: uppercase; transition: transform 0.1s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-pixel:active { transform: translate(4px, 4px); box-shadow: 0px 0px 0px; }
        
        .btn-back { background: #f0f0f0; color: #333; }
        .btn-action { background: #ffcc00; color: #000; }
        
        .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .page-title { font-size: 2rem; font-weight: 900; color: #fff; text-shadow: 4px 4px 0 #000; -webkit-text-stroke: 1.5px #000; margin: 0; }

        /* --- 1. é¦–é  (Dashboard) --- */
        .hero-banner { text-align: center; margin-bottom: 30px; margin-top: 20px; }
        .hero-title { 
            font-size: 3rem; color: #f1c40f; 
            text-shadow: 4px 4px 0 #d35400, -2px -2px 0 #000; 
            line-height: 1.1; margin-bottom: 10px;
        }
        .hero-sub { color: #fff; text-shadow: 2px 2px 0 #000; font-size: 1.2rem; background: rgba(0,0,0,0.5); display: inline-block; padding: 5px 10px; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .dash-btn {
            background: #fff; border: 4px solid #000;
            padding: 20px 10px; text-align: center; cursor: pointer;
            box-shadow: 6px 6px 0px rgba(0,0,0,0.4);
            transition: 0.1s; display: flex; flex-direction: column; align-items: center;
        }
        .dash-btn:active { transform: translate(4px, 4px); box-shadow: 0 0 0; }
        .dash-icon { font-size: 3rem; margin-bottom: 5px; }
        .dash-btn h2 { font-size: 1.5rem; margin: 5px 0; color: #000; }
        .dash-btn p { font-size: 0.9rem; color: #555; margin: 0; }

        .dash-btn.study-mode { background: #dff9fb; }
        .dash-btn.quiz-mode { background: #ffeaa7; }
        .dash-btn.achievement-mode { background: #a29bfe; grid-column: span 2; flex-direction: row; justify-content: center; gap: 20px; color: #fff; }
        .dash-btn.achievement-mode h2, .dash-btn.achievement-mode p { color: #000; text-align: left; }
        .dash-btn.analysis-mode { background: #ff7675; grid-column: span 2; flex-direction: row; justify-content: center; gap: 20px; }
        .dash-btn.analysis-mode h2, .dash-btn.analysis-mode p { color: #000; text-align: left; }

        /* --- ğŸ† ç¨±è™Ÿç³»çµ± (Retro Style) --- */
        .achievement-container { padding-bottom: 50px; }
        
        .category-header {
            font-size: 1.5rem; color: #fff; text-shadow: 3px 3px 0 #000;
            margin: 30px 0 15px 0; padding: 5px 10px; 
            background: #000; display: inline-block; transform: skew(-10deg);
        }
        
        .achievement-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
        
        /* é“å…·å¡ç‰‡è¨­è¨ˆ */
        .badge-card {
            background: #2d3436; /* é“å…·æ¬„æ·±è‰²åº• */
            border: 4px solid #b2bec3; /* éŠ€è‰²é‚Šæ¡† (é è¨­) */
            padding: 10px; text-align: center;
            opacity: 0.7; filter: grayscale(1); 
            transition: 0.3s; position: relative;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
        }
        
        /* è§£é–å¾Œ */
        .badge-card.unlocked { opacity: 1; filter: grayscale(0); background: #fff; color: #000; box-shadow: 4px 4px 0 rgba(0,0,0,0.4); }
        
        /* ç¨€æœ‰åº¦é‚Šæ¡† */
        .badge-card.unlocked.common { border-color: var(--tier-common); background: #fdf5e6; }
        .badge-card.unlocked.rare { border-color: var(--tier-rare); background: #f0f0f0; }
        .badge-card.unlocked.epic { border-color: var(--tier-epic); background: #fffbe6; }
        .badge-card.unlocked.legendary { border-color: var(--tier-legend); background: #f3e5f5; border-width: 6px; }

        .badge-icon-box {
            width: 60px; height: 60px; margin: 0 auto 10px;
            background: rgba(0,0,0,0.1); border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; border: 2px inset rgba(255,255,255,0.5);
        }
        .badge-card.unlocked .badge-icon-box { background: rgba(255,255,255,0.5); border: 2px solid rgba(0,0,0,0.1); }

        .badge-title { font-weight: 900; font-size: 1rem; margin-bottom: 4px; line-height: 1.2; }
        .badge-desc { font-size: 0.75rem; color: #555; line-height: 1.2; }
        
        /* ç²å¾—ç¨±è™Ÿæç¤º (Toast) - å‡ç´šç‰ˆæç¤ºæ¡† */
        .toast-notification {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background: #fff; padding: 10px; width: 90%; max-width: 350px;
            border: 4px solid #000; box-shadow: 8px 8px 0 rgba(0,0,0,0.5);
            z-index: 2000; display: flex; align-items: center; gap: 15px;
            transition: top 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .toast-icon { font-size: 2.5rem; animation: bounce 1s infinite; }
        .toast-text h4 { margin: 0; color: var(--accent); font-size: 1.2rem; text-transform: uppercase; }
        .toast-text p { margin: 0; color: #000; font-weight: bold; }
        .toast-notification.show { top: 20px; }

        /* --- å…¶ä»–ä»‹é¢å„ªåŒ– --- */
        /* èƒŒå–®å­—å¡ç‰‡ */
        .word-overview-card {
            background: #fff; border: 3px solid #000; box-shadow: 4px 4px 0 #ccc;
            padding: 15px; text-align: center; cursor: pointer; transition: 0.1s;
        }
        .word-overview-card:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 #ccc; }
        .word-overview-card.read { background: #e0f7fa; border-color: #00bcd4; }
        .word-overview-card.read::after { content: "âœ”"; position: absolute; top: 0; right: 2px; color: #00bcd4; font-weight: bold; }

        /* æ¸¬é©—å€ */
        .question-card { background: #fff; border: 4px solid #000; box-shadow: 6px 6px 0 rgba(0,0,0,0.2); padding: 30px; text-align: center; margin-bottom: 20px; }
        .choice-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-choice {
            background: #fff; border: 3px solid #000; padding: 15px; font-size: 1.1rem;
            box-shadow: 3px 3px 0 #999; cursor: pointer; transition: 0.1s;
        }
        .btn-choice:active { transform: translate(3px, 3px); box-shadow: 0 0 0; }
        .btn-choice.correct { background: #2ecc71; color: white; border-color: #27ae60; }
        .btn-choice.wrong { background: #e74c3c; color: white; border-color: #c0392b; }

        /* è¼¸å…¥æ¡† */
        .input-spelling {
            border: 4px solid #000; box-shadow: 4px 4px 0 #ccc;
            font-family: 'Courier New', monospace; font-weight: bold;
            width: 100%; padding: 15px; font-size: 1.5rem; text-align: center; margin-bottom: 10px;
        }

        /* å¼±é»åˆ†æ */
        .weak-item-card {
            background: #fff; border: 3px solid #e74c3c; box-shadow: 4px 4px 0 #ffcdd2;
            padding: 10px; min-width: 100px; text-align: center; margin-right: 10px;
        }

        /* ç¯„åœé¸æ“‡æŒ‰éˆ• */
        .range-btn {
            background: #fff; border: 2px solid #aaa; padding: 8px 12px; cursor: pointer;
            box-shadow: 2px 2px 0 #aaa; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .range-btn.has-data { border-color: #000; background: #ffeaa7; color: #000; box-shadow: 2px 2px 0 #000; }
        .badge-count { background: #000; color: #fff; font-size: 0.7rem; padding: 2px 5px; border-radius: 4px; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; animation: popIn 0.2s; }
        .modal-content { 
            background: #fff; margin: 10% auto; padding: 20px; width: 90%; max-width: 500px; 
            border: 6px solid #000; box-shadow: 10px 10px 0 rgba(0,0,0,0.5); 
            position: relative; max-height: 80vh; overflow-y: auto; 
        }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 2rem; cursor: pointer; color: #000; font-family: monospace; }

        .rank-num { font-family: 'Courier New', monospace; font-weight: bold; }

    </style>
</head>
<body>

    <div id="toastNotification" class="toast-notification">
        <div class="toast-icon">ğŸ</div>
        <div class="toast-text">
            <h4>LEVEL UP!</h4>
            <p id="toastMsg">ç²å¾—æ–°ç¨±è™Ÿ</p>
        </div>
    </div>

    <div id="homeScreen" class="screen active">
        <div class="hero-banner">
            <div class="hero-title">å–®å­—å¤§å†’éšª</div>
            <div class="hero-sub">READY PLAYER ONE?</div>
        </div>

        <div class="dashboard-grid">
            <button class="dash-btn study-mode" onclick="openUnitSelector('study')">
                <span class="dash-icon">ğŸ“–</span>
                <h2>ä¿®ç·´å ´ (èƒŒå–®å­—)</h2>
                <p>LEVEL UP YOUR VOCAB</p>
            </button>
            <button class="dash-btn quiz-mode" onclick="openQuizSetup()">
                <span class="dash-icon">âš”ï¸</span>
                <h2>ç«¶æŠ€å ´ (æ¸¬é©—)</h2>
                <p>FIGHT THE BOSS</p>
            </button>
            <button class="dash-btn achievement-mode" onclick="openAchievementScreen()">
                <span class="dash-icon">ğŸ°</span>
                <div>
                    <h2>æ¦®è­½æ®¿å ‚ (æˆå°±)</h2>
                    <p>VIEW YOUR TROPHIES</p>
                </div>
            </button>
            <button class="dash-btn analysis-mode" onclick="openAnalysisScreen()">
                <span class="dash-icon">ğŸ©¹</span>
                <div>
                    <h2>é†«ç™‚ä¸­å¿ƒ (å¼±é»)</h2>
                    <p>HEAL YOUR WEAKNESS</p>
                </div>
            </button>
        </div>
    </div>

    <div id="achievementScreen" class="screen">
        <div class="page-header">
            <button class="btn-pixel btn-back" onclick="goHome()">â¬… MENU</button>
            <h2 class="page-title">æ¦®è­½æ®¿å ‚</h2>
            <div style="width: 80px;"></div>
        </div>
        <div class="achievement-container">
            <div id="badgeGrid" class="achievement-grid"></div>
        </div>
    </div>

    <div id="analysisScreen" class="screen">
        <div class="page-header">
            <button class="btn-pixel btn-back" onclick="goHome()">â¬… MENU</button>
            <h2 class="page-title">é†«ç™‚ä¸­å¿ƒ</h2>
            <div style="width: 80px;"></div>
        </div>

        <div class="pixel-box" style="margin-bottom:20px;">
            <div style="font-weight:bold; color:var(--danger); margin-bottom:10px;">âš ï¸ ä½ çš„å¤§é­”ç‹ (Top 3)</div>
            <div id="topWeakList" style="display:flex; overflow-x:auto; padding-bottom:5px;">
                <div style="color:#999;">ç›®å‰éå¸¸å¥åº·ï¼</div>
            </div>
        </div>

        <div class="pixel-box">
            <div style="font-weight:bold; margin-bottom:10px;">ğŸ“ ç—…æ­·è¡¨ (éŒ¯é¡Œåˆ—è¡¨)</div>
            <div id="fullMistakeList" class="full-mistake-list" style="max-height:250px; overflow-y:auto;"></div>
        </div>

        <button class="btn-pixel btn-action" style="width:100%; margin-top:20px; background:#e74c3c; color:white; border-color:#c0392b;" onclick="startTop30WeaknessQuiz()">ğŸ”¥ è¨ä¼é­”ç‹ (Top 30)</button>
    </div>

    <div id="unitSelectScreen" class="screen">
        <div class="page-header">
            <button class="btn-pixel btn-back" onclick="goHome()">â¬… MENU</button>
            <h2 class="page-title">é¸æ“‡åœ°åœ–</h2>
            <div style="width: 80px;"></div>
        </div>
        <div id="unitGridContainer" class="unit-grid"></div>
    </div>

    <div id="studyOverviewScreen" class="screen">
        <div class="page-header">
            <button class="btn-pixel btn-back" onclick="openUnitSelector('study')">â¬… MAP</button>
            <h2 class="page-title" id="overviewTitle">Unit A</h2>
            <div style="width: 60px;"></div>
        </div>
        
        <div id="overviewGrid" class="word-overview-grid"></div>

        <div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px;">
            <button class="btn-pixel btn-action" style="width:100%; background:#2ecc71; color:white; border-color:#27ae60;" onclick="openQuickQuizPicker()">
                âš¡ ç«‹å³æˆ°é¬¥ (æ¸¬é©—)
            </button>
        </div>
    </div>

    <div id="studyDetailScreen" class="screen">
        <div class="page-header">
            <button class="btn-pixel btn-back" onclick="backToOverview()">â¬… LIST</button>
            <div style="font-weight:bold; color:#fff;">Word <span id="detailIdx">1</span> / <span id="detailTotal">20</span></div>
            <div style="width: 80px;"></div>
        </div>

        <div class="pixel-box" style="text-align:center; padding:40px 20px;">
            <div class="detail-word" id="cardWord" style="font-size:3rem; margin-bottom:10px;">Apple</div>
            <div class="detail-zh" id="cardZh" style="font-size:1.5rem; color:#666; margin-bottom:30px;">è˜‹æœ</div>
            
            <button class="btn-pixel" style="border-radius:50%; width:60px; height:60px; margin:0 auto 20px; padding:0;" onclick="playCurrentCardAudio()">ğŸ”Š</button>

            <div style="background:#eee; padding:15px; border:2px solid #ccc; text-align:left;">
                <div class="detail-sent-en" id="cardSentEn" style="font-size:1.2rem; margin-bottom:5px;">I eat an apple.</div>
                <div class="detail-sent-zh" id="cardSentZh" style="color:#666;">æˆ‘åƒä¸€é¡†è˜‹æœã€‚</div>
                <button style="float:right; margin-top:-20px; background:none; border:none; cursor:pointer;" onclick="playCurrentCardSent()">ğŸ”Š</button>
            </div>
        </div>

        <div class="nav-controls" style="margin-top:20px;">
            <button class="btn-pixel btn-back" onclick="prevCard()">â—€ PREV</button>
            <button class="btn-pixel btn-back" onclick="nextCard()">NEXT â–¶</button>
        </div>
    </div>

    <div id="quizSetupScreen" class="screen">
        <div class="page-header">
            <button class="btn-pixel btn-back" onclick="goHome()">â¬… MENU</button>
            <h2 class="page-title">æˆ°é¬¥æº–å‚™</h2>
            <div style="width: 80px;"></div>
        </div>

        <div class="pixel-box" style="margin-bottom:20px;">
            <span style="font-weight:bold; display:block; margin-bottom:10px;">1. é¸æ“‡æ­¦å™¨ (é¡Œå‹)</span>
            <div class="toggle-group" style="display:flex; gap:10px;">
                <button class="btn-pixel" style="flex:1;" id="modeChoice" onclick="setQuizMode('choice')">ğŸ‘† é¸æ“‡é¡Œ</button>
                <button class="btn-pixel" style="flex:1;" id="modeSpelling" onclick="setQuizMode('spelling')">âŒ¨ï¸ æ‹¼å­—é¡Œ</button>
            </div>
        </div>

        <div class="pixel-box" style="margin-bottom:20px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="font-weight:bold;">2. é¸æ“‡æˆ°å ´ (å–®å…ƒ)</span>
                <button style="border:none; background:none; color:red; cursor:pointer;" onclick="clearAllSelectedWords()">[æ¸…ç©º]</button>
            </div>
            <div style="margin-bottom:10px;">å·²é¸ï¼š<b id="totalSelectedCount" style="color:var(--primary);">0</b></div>
            <div id="quizRangeGrid" class="range-selector"></div>
        </div>

        <div class="pixel-box" style="margin-bottom:20px;">
            <span style="font-weight:bold; display:block; margin-bottom:10px;">3. é›£åº¦è¨­å®š</span>
            <div class="setting-row">
                <span>è‡ªå‹•ä¸‹ä¸€é—œ</span>
                <input type="checkbox" id="autoNextSwitch" checked style="transform:scale(1.5);">
            </div>
            <div class="setting-row">
                <span>8ç§’é™æ™‚</span>
                <input type="checkbox" id="timerSwitch" style="transform:scale(1.5);">
            </div>
        </div>

        <button class="btn-pixel btn-action" style="width:100%;" onclick="startConfiguredQuiz()">âš”ï¸ é–‹å§‹æˆ°é¬¥</button>
    </div>

    <div id="wordPickerModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeWordPicker()">Ã—</span>
            <h3 id="pickerTitle" style="margin-top:0;">æŒ‘é¸æ•µäºº</h3>
            <div class="picker-actions">
                <button class="btn-pixel" style="font-size:0.8rem; padding:5px;" onclick="pickerSelectViewed()">åƒ…å·²è®€</button>
                <button class="btn-pixel" style="font-size:0.8rem; padding:5px;" onclick="pickerSelectAll()">å…¨é¸</button>
                <button class="btn-pixel" style="font-size:0.8rem; padding:5px;" onclick="pickerSelectNone()">å…¨æ¶ˆ</button>
            </div>
            <div id="pickerGrid" class="word-picker-container"></div>
            <div id="btnPickerSave" style="display:block; margin-top:15px;">
                <button class="btn-pixel btn-action" style="width:100%;" onclick="closeWordPicker()">ç¢ºå®š</button>
            </div>
            <div id="btnPickerQuickStart" style="display:none; gap:10px; margin-top:15px;">
                <button class="btn-pixel btn-action" style="flex:1;" onclick="startQuickQuizDirect('choice')">é¸</button>
                <button class="btn-pixel btn-action" style="flex:1;" onclick="startQuickQuizDirect('spelling')">æ‹¼</button>
            </div>
        </div>
    </div>

    <div id="quizScreen" class="screen">
        <div class="quiz-header">
            <span>Q: <span id="qIdx">1</span>/<span id="qTotal">10</span></span>
            <span id="timerBadge" style="display:none; color:red;">â±ï¸ <span id="timeLeft">8</span></span>
            <button style="background:none; border:none; font-size:1.5rem;" onclick="quitQuiz()">ğŸ³ï¸</button>
        </div>

        <div class="question-card">
            <div class="q-icon" onclick="playQuizSequence()">ğŸ”Š</div>
            <div class="q-hint" id="qHint" style="display:none; margin-top:15px;"></div>
            <button id="btnShowHint" style="margin-top:15px; background:#ddd; border:none; padding:5px 10px; cursor:pointer;" onclick="showHint()">ğŸ’¡ æç¤º</button>
        </div>

        <div id="choiceArea" class="choice-container" style="display:none;"></div>

        <div id="spellingArea" class="spelling-container" style="display:none;">
            <input type="text" id="spellingInput" class="input-spelling" placeholder="è¼¸å…¥å–®å­—..." autocomplete="off">
            <div id="spellingFeedback" style="height: 20px; font-weight:bold; margin-bottom:10px;"></div>
            <button class="btn-pixel btn-action" style="width:100%;" onclick="checkSpelling()">æ”»æ“Š (é€å‡º)</button>
        </div>
        <button id="btnNextQ" class="btn-pixel" style="width:100%; margin-top:20px; display:none;" onclick="nextQuestion()">â¡ NEXT</button>
    </div>

    <div id="resultScreen" class="screen">
        <div class="result-box">
            <div style="font-size:4rem;">ğŸ†</div>
            <h2>æˆ°é¬¥çµæŸï¼</h2>
            <div class="score-display" id="finalScore">100</div>
            <p id="finalMsg">å¤ªå²å®³äº†ï¼</p>
            <button class="btn-pixel btn-action" style="width:100%; margin-bottom:15px;" onclick="goHome()">ğŸ  å›å¤§å»³</button>
            <button class="btn-pixel btn-back" style="width:100%;" onclick="retryQuiz()">ğŸ”„ å†æˆ°ä¸€æ¬¡</button>
        </div>
    </div>

<script src="words.js"></script>
<script>
    let sessions = [];
    let viewedWords = new Set(); 
    let studyData = { sid: null, list: [], currentIndex: 0 };
    let quizConfig = { mode: 'choice', selectedWords: new Set(), timer: false, autoNext: true };
    let quizData = { list: [], index: 0, score: 0, timerId: null };
    let currentPickerSid = null;
    let isQuickQuizPicker = false; 
    
    let userStats = {
        wordsViewedCount: 0,
        quizCount: 0,
        totalCorrect: 0,
        totalMistakes: 0 
    };
    let unlockedTitles = new Set();

    // ğŸ† v44.0 ç¨±è™Ÿè³‡æ–™åº« (RPG Icons)
    const achievements = [
        // ğŸ“š å‹¤å­¸ä¹‹è·¯ (Learning)
        { id: 'view_5', category: 'learn', tier: 'common', icon: 'ğŸªµ', title: 'æ’¿æœ¨æŸ´', desc: 'çœ‹é 5 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 5 },
        { id: 'view_20', category: 'learn', tier: 'common', icon: 'ğŸ•¯ï¸', title: 'é»äº®ç‡­å…‰', desc: 'çœ‹é 20 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 20 },
        { id: 'view_50', category: 'learn', tier: 'common', icon: 'ğŸ“œ', title: 'æ–°æ‰‹å·è»¸', desc: 'çœ‹é 50 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 50 },
        { id: 'view_80', category: 'learn', tier: 'rare', icon: 'ğŸ““', title: 'å†’éšªç­†è¨˜', desc: 'çœ‹é 80 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 80 },
        { id: 'view_100', category: 'learn', tier: 'rare', icon: 'ğŸ“˜', title: 'åˆç´šé­”æ³•æ›¸', desc: 'çœ‹é 100 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 100 },
        { id: 'view_200', category: 'learn', tier: 'rare', icon: 'ğŸ“', title: 'å­¸è€…å¸½', desc: 'çœ‹é 200 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 200 },
        { id: 'view_300', category: 'learn', tier: 'epic', icon: 'ğŸ”®', title: 'å…ˆçŸ¥æ°´æ™¶', desc: 'çœ‹é 300 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 300 },
        { id: 'view_500', category: 'learn', tier: 'epic', icon: 'ğŸ§™â€â™‚ï¸', title: 'å¤§è³¢è€…', desc: 'çœ‹é 500 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 500 },
        { id: 'view_all', category: 'learn', tier: 'legendary', icon: 'ğŸª', title: 'å…¨çŸ¥ä¹‹çœ¼', desc: 'çœ‹éæ‰€æœ‰å–®å­— (800+)', check: (s) => s.wordsViewedCount >= 800 },

        // ğŸ« Unit åˆ¶éœ¸
        { id: 'unit_1', category: 'unit', tier: 'common', icon: 'ğŸš©', title: 'ä½”é ˜æ“šé»', desc: 'å®Œæˆ 1 å€‹å–®å…ƒ', check: () => checkUnitsCompleted(1) },
        { id: 'unit_3', category: 'unit', tier: 'rare', icon: 'â›º', title: 'å»ºç«‹ç‡Ÿåœ°', desc: 'å®Œæˆ 3 å€‹å–®å…ƒ', check: () => checkUnitsCompleted(3) },
        { id: 'unit_5', category: 'unit', tier: 'rare', icon: 'ğŸ›–', title: 'æ“´å¼µé ˜åœŸ', desc: 'å®Œæˆ 5 å€‹å–®å…ƒ', check: () => checkUnitsCompleted(5) },
        { id: 'unit_10', category: 'unit', tier: 'epic', icon: 'ğŸ°', title: 'å»ºç«‹ç‹åœ‹', desc: 'å®Œæˆ 10 å€‹å–®å…ƒ', check: () => checkUnitsCompleted(10) },
        { id: 'unit_all', category: 'unit', tier: 'legendary', icon: 'ğŸ‘‘', title: 'çµ±æ²»ä¸–ç•Œ', desc: 'å®Œæˆæ‰€æœ‰å–®å…ƒ', check: () => checkUnitsCompleted(sessions.length) },

        // ğŸ”¡ å­—æ¯è’é›†
        { id: 'alpha_1', category: 'alpha', tier: 'common', icon: 'ğŸ§©', title: 'æ‹¼åœ–ç¢ç‰‡', desc: 'å®Œæˆ 1 å€‹å­—æ¯', check: () => checkLettersCompleted(1) },
        { id: 'alpha_3', category: 'alpha', tier: 'rare', icon: 'ğŸ§±', title: 'å¥ åŸºçŸ³', desc: 'å®Œæˆ 3 å€‹å­—æ¯', check: () => checkLettersCompleted(3) },
        { id: 'alpha_5', category: 'alpha', tier: 'rare', icon: 'ğŸ—ï¸', title: 'å»ºç¯‰å¸«', desc: 'å®Œæˆ 5 å€‹å­—æ¯', check: () => checkLettersCompleted(5) },
        { id: 'alpha_10', category: 'alpha', tier: 'epic', icon: 'ğŸ›ï¸', title: 'ç¥æ®¿å®ˆè­·', desc: 'å®Œæˆ 10 å€‹å­—æ¯', check: () => checkLettersCompleted(10) },
        { id: 'alpha_all', category: 'alpha', tier: 'legendary', icon: 'ğŸ—¿', title: 'å¤æ–‡æ˜', desc: 'å®Œæˆ A-Z æ‰€æœ‰å­—æ¯', check: () => checkLettersCompleted(26) },

        // âš”ï¸ è©¦ç…‰æˆ°å ´
        { id: 'quiz_1', category: 'quiz', tier: 'common', icon: 'ğŸ—¡ï¸', title: 'æœ¨åŠ', desc: 'å®Œæˆ 1 æ¬¡æ¸¬é©—', check: (s) => s.quizCount >= 1 },
        { id: 'quiz_10', category: 'quiz', tier: 'rare', icon: 'âš”ï¸', title: 'é¨å£«åŠ', desc: 'å®Œæˆ 10 æ¬¡æ¸¬é©—', check: (s) => s.quizCount >= 10 },
        { id: 'quiz_50', category: 'quiz', tier: 'epic', icon: 'ğŸ›¡ï¸', title: 'è‹±é›„ä¹‹ç›¾', desc: 'å®Œæˆ 50 æ¬¡æ¸¬é©—', check: (s) => s.quizCount >= 50 },
        
        // ğŸ’ å‚³å¥‡é‡Œç¨‹ç¢‘ (Correct)
        { id: 'correct_10', category: 'milestone', tier: 'common', icon: 'ğŸ’°', title: 'ç¬¬ä¸€æ¡¶é‡‘', desc: 'ç´¯ç©ç­”å° 10 é¡Œ', check: (s) => s.totalCorrect >= 10 },
        { id: 'correct_100', category: 'milestone', tier: 'rare', icon: 'ğŸ’', title: 'å¯¶çŸ³çµäºº', desc: 'ç´¯ç©ç­”å° 100 é¡Œ', check: (s) => s.totalCorrect >= 100 },
        { id: 'correct_500', category: 'milestone', tier: 'epic', icon: 'ğŸ†', title: 'å† è»çç›ƒ', desc: 'ç´¯ç©ç­”å° 500 é¡Œ', check: (s) => s.totalCorrect >= 500 },
        { id: 'correct_1000', category: 'milestone', tier: 'legendary', icon: 'ğŸ‰', title: 'å± é¾è€…', desc: 'ç´¯ç©ç­”å° 1000 é¡Œ', check: (s) => s.totalCorrect >= 1000 },

        // âœ¨ ç¥ç§˜å½©è›‹
        { id: 'secret_night', category: 'secret', tier: 'rare', icon: 'ğŸ§›', title: 'å¸è¡€é¬¼', desc: 'æ™šä¸Š 10 é»å¾ŒèƒŒå–®å­—', secretDesc: 'æ·±å¤œå‡ºæ²’...', check: () => new Date().getHours() >= 22 },
        { id: 'secret_early', category: 'secret', tier: 'rare', icon: 'ğŸ”', title: 'å…¬é›', desc: 'æ—©ä¸Š 7 é»å‰èƒŒå–®å­—', secretDesc: 'æ—©èµ·çš„é³¥å…’...', check: () => new Date().getHours() < 7 },
        { id: 'secret_fail', category: 'secret', tier: 'epic', icon: 'ğŸ’€', title: 'ä¸å±ˆä¸æ’“', desc: 'ç´¯ç©ç­”éŒ¯ 50 æ¬¡', secretDesc: 'å¤±æ•—ç‚ºæˆåŠŸä¹‹æ¯...', check: (s) => s.totalMistakes >= 50 }
    ];

    window.onload = function() {
        if (typeof masterWordList === 'undefined') {
            alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è³‡æ–™åº« words.js"); return;
        }
        sessions = [...new Set(masterWordList.map(item => item.session))].sort();
        loadUserData();
        goHome();
    };

    function loadUserData() {
        const savedViewed = localStorage.getItem('viewedWords');
        if (savedViewed) viewedWords = new Set(JSON.parse(savedViewed));
        const savedStats = localStorage.getItem('userStats');
        if (savedStats) {
            const parsed = JSON.parse(savedStats);
            userStats.quizCount = parsed.quizCount || 0;
            userStats.totalCorrect = parsed.totalCorrect || 0;
            userStats.totalMistakes = parsed.totalMistakes || 0;
            userStats.wordsViewedCount = viewedWords.size;
        }
        const savedTitles = localStorage.getItem('unlockedTitles');
        if (savedTitles) unlockedTitles = new Set(JSON.parse(savedTitles));
    }

    function saveUserData() {
        localStorage.setItem('viewedWords', JSON.stringify([...viewedWords]));
        localStorage.setItem('userStats', JSON.stringify(userStats));
        localStorage.setItem('unlockedTitles', JSON.stringify([...unlockedTitles]));
    }

    // Helper
    function checkUnitsCompleted(targetCount) {
        let completed = 0;
        sessions.forEach(sid => {
            const words = masterWordList.filter(w => w.session === sid);
            if (words.every(w => viewedWords.has(w.word))) completed++;
        });
        return completed >= targetCount;
    }

    function checkLettersCompleted(targetCount) {
        const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
        let completed = 0;
        letters.forEach(char => {
            const words = masterWordList.filter(w => w.word.toUpperCase().startsWith(char));
            if (words.length > 0 && words.every(w => viewedWords.has(w.word))) completed++;
        });
        return completed >= targetCount;
    }

    function checkAchievements() {
        let newUnlock = false;
        userStats.wordsViewedCount = viewedWords.size;
        achievements.forEach(ach => {
            if (!unlockedTitles.has(ach.id) && ach.check(userStats)) {
                unlockedTitles.add(ach.id);
                showToast(ach.title, ach.icon);
                newUnlock = true;
            }
        });
        if (newUnlock) saveUserData();
    }

    function showToast(title, icon) {
        const toast = document.getElementById('toastNotification');
        toast.querySelector('.toast-icon').innerText = icon || 'ğŸ';
        document.getElementById('toastMsg').innerText = title;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Navigation
    function goHome() { showScreen('homeScreen'); }
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
        clearInterval(quizData.timerId); 
        window.speechSynthesis.cancel(); 
    }

    function speak(text) {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        u.rate = 0.9; 
        const voices = window.speechSynthesis.getVoices();
        const preferred = voices.find(v => v.name.includes("Google US English") || v.name.includes("Samantha"));
        if (preferred) u.voice = preferred;
        window.speechSynthesis.speak(u);
    }

    // ğŸ† Achievement UI (Retro)
    function openAchievementScreen() {
        const grid = document.getElementById('badgeGrid');
        grid.innerHTML = "";
        const categories = { 'learn': 'ğŸ“š å‹¤å­¸ä¹‹è·¯', 'unit': 'ğŸ« Unit åˆ¶éœ¸', 'alpha': 'ğŸ”¡ å­—æ¯è’é›†', 'quiz': 'âš”ï¸ è©¦ç…‰æˆ°å ´', 'milestone': 'ğŸ’ å‚³å¥‡é‡Œç¨‹ç¢‘', 'secret': 'âœ¨ ç¥ç§˜å½©è›‹' };
        for (let cat in categories) {
            const header = document.createElement('div');
            header.className = `category-header cat-${cat}`;
            header.style.gridColumn = "1 / -1";
            header.innerText = categories[cat];
            grid.appendChild(header);
            achievements.filter(a => a.category === cat).forEach(ach => {
                const isUnlocked = unlockedTitles.has(ach.id);
                const div = document.createElement('div');
                div.className = `badge-card ${isUnlocked ? 'unlocked' : ''} ${ach.tier}`;
                let icon = 'ğŸ”’'; let title = 'ï¼Ÿï¼Ÿï¼Ÿ'; let desc = ach.secretDesc || 'é”æˆæ¢ä»¶è§£é–';
                
                if (isUnlocked) {
                    icon = ach.icon || 'ğŸ†'; // Use custom icon
                    title = ach.title; desc = ach.desc;
                } else if (!ach.secretDesc) { title = ach.title; desc = ach.desc; }
                
                div.innerHTML = `<div class="badge-icon-box">${icon}</div><div class="badge-title">${title}</div><div class="badge-desc">${desc}</div>`;
                grid.appendChild(div);
            });
        }
        showScreen('achievementScreen');
    }

    // --- Core Logic (Copied from previous stable version) ---
    function openAnalysisScreen() {
        const m = JSON.parse(localStorage.getItem('myMistakes')) || {};
        const topList = document.getElementById('topWeakList');
        const fullList = document.getElementById('fullMistakeList');
        let sorted = Object.keys(m).map(k => ({ word: k, count: m[k] })).sort((a,b) => b.count - a.count);
        if (sorted.length === 0) { topList.innerHTML = "ç„¡éŒ¯é¡Œç´€éŒ„"; fullList.innerHTML = ""; } 
        else {
            topList.innerHTML = "";
            sorted.slice(0, 3).forEach((item, idx) => {
                let medal = idx===0?'ğŸ¥‡':(idx===1?'ğŸ¥ˆ':'ğŸ¥‰');
                topList.innerHTML += `<div class="weak-item-card"><div style="font-size:1.5rem;">${medal}</div><span class="weak-word">${item.word}</span><span class="weak-count">éŒ¯ ${item.count} æ¬¡</span></div>`;
            });
            let html = "";
            sorted.forEach((item, idx) => {
                let rankClass = idx < 3 ? `top${idx+1}` : '';
                html += `<div class="mistake-row"><span class="rank-num ${rankClass}">#${idx+1}</span><span class="mistake-word">${item.word}</span><span class="mistake-val">éŒ¯ ${item.count} æ¬¡</span></div>`;
            });
            fullList.innerHTML = html;
        }
        showScreen('analysisScreen');
    }

    function startTop30WeaknessQuiz() {
        const m = JSON.parse(localStorage.getItem('myMistakes')) || {};
        const sorted = Object.keys(m).map(k => ({ word: k, count: m[k] })).sort((a,b) => b.count - a.count);
        if (sorted.length === 0) { alert("æ²’æœ‰éŒ¯é¡Œï¼"); return; }
        const top30 = sorted.slice(0, 30).map(i => i.word);
        quizConfig.selectedWords = new Set(top30);
        quizConfig.mode = 'choice'; quizConfig.timer = false; quizConfig.autoNext = true;
        startConfiguredQuiz();
    }

    function openUnitSelector(targetMode) {
        currentMode = targetMode; 
        const grid = document.getElementById('unitGridContainer');
        grid.innerHTML = "";
        sessions.forEach(sid => {
            const count = masterWordList.filter(w => w.session === sid).length;
            const btn = document.createElement('div');
            btn.className = 'unit-card';
            btn.innerHTML = `<h3>Unit ${sid}</h3><span>${count} words</span>`;
            btn.onclick = () => loadStudyOverview(sid);
            grid.appendChild(btn);
        });
        showScreen('unitSelectScreen');
    }

    function loadStudyOverview(sid) {
        studyData.sid = sid;
        studyData.list = masterWordList.filter(w => w.session === sid);
        document.getElementById('overviewTitle').innerText = `Unit ${sid}`;
        renderOverviewGrid();
        showScreen('studyOverviewScreen');
    }

    function renderOverviewGrid() {
        const grid = document.getElementById('overviewGrid');
        grid.innerHTML = "";
        studyData.list.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'word-overview-card';
            if (viewedWords.has(item.word)) card.classList.add('read');
            card.innerHTML = `<h4>${item.word}</h4>`;
            card.onclick = () => openFlashcard(index);
            grid.appendChild(card);
        });
    }

    function openFlashcard(index) {
        studyData.currentIndex = index;
        updateFlashcardUI();
        showScreen('studyDetailScreen');
    }

    function updateFlashcardUI() {
        const item = studyData.list[studyData.currentIndex];
        if (!viewedWords.has(item.word)) {
            viewedWords.add(item.word);
            saveUserData();
            checkAchievements(); 
        }
        document.getElementById('detailIdx').innerText = studyData.currentIndex + 1;
        document.getElementById('detailTotal').innerText = studyData.list.length;
        document.getElementById('cardWord').innerText = item.word;
        document.getElementById('cardZh').innerText = item.word_zh || '';
        document.getElementById('cardSentEn').innerText = item.sentence;
        document.getElementById('cardSentZh').innerText = item.sentence_zh || '';
        window.speechSynthesis.cancel();
        setTimeout(() => speak(item.word), 300);
    }

    function prevCard() { if (studyData.currentIndex > 0) { studyData.currentIndex--; updateFlashcardUI(); } }
    function nextCard() { if (studyData.currentIndex < studyData.list.length - 1) { studyData.currentIndex++; updateFlashcardUI(); } }
    function backToOverview() { renderOverviewGrid(); showScreen('studyOverviewScreen'); }
    function playCurrentCardAudio() { window.speechSynthesis.cancel(); speak(studyData.list[studyData.currentIndex].word); }
    function playCurrentCardSent() { window.speechSynthesis.cancel(); speak(studyData.list[studyData.currentIndex].sentence); }

    function quickQuizFromStudy() { openQuickQuizPicker(); }
    function openQuickQuizPicker() { isQuickQuizPicker = true; openWordPicker(studyData.sid); }
    function startQuickQuizDirect(mode) { quizConfig.mode = mode; quizConfig.timer = false; quizConfig.autoNext = true; closeWordPicker(); startConfiguredQuiz(); }

    function openQuizSetup() {
        quizConfig.mode = 'choice'; quizConfig.timer = false; quizConfig.autoNext = true;
        updateModeUI();
        document.getElementById('timerSwitch').checked = false;
        document.getElementById('autoNextSwitch').checked = true;
        renderQuizRangeGrid();
        updateTotalCount();
        showScreen('quizSetupScreen');
    }

    function renderQuizRangeGrid() {
        const grid = document.getElementById('quizRangeGrid');
        grid.innerHTML = "";
        sessions.forEach(sid => {
            const btn = document.createElement('div');
            btn.className = 'range-btn';
            const unitWords = masterWordList.filter(w => w.session === sid);
            let pickedCount = 0;
            unitWords.forEach(w => { if (quizConfig.selectedWords.has(w.word)) pickedCount++; });
            if (pickedCount > 0) btn.classList.add('has-data');
            btn.innerHTML = `Unit ${sid} ${pickedCount > 0 ? `<span class="badge-count">${pickedCount}</span>` : ''}`;
            btn.onclick = () => { isQuickQuizPicker = false; openWordPicker(sid); };
            grid.appendChild(btn);
        });
    }

    function setQuizMode(mode) { quizConfig.mode = mode; updateModeUI(); }
    function updateModeUI() {
        document.getElementById('modeChoice').classList.toggle('active', quizConfig.mode === 'choice');
        document.getElementById('modeSpelling').classList.toggle('active', quizConfig.mode === 'spelling');
    }
    function clearAllSelectedWords() { if(confirm("æ¸…é™¤æ‰€æœ‰ï¼Ÿ")) { quizConfig.selectedWords.clear(); renderQuizRangeGrid(); updateTotalCount(); } }
    function updateTotalCount() { document.getElementById('totalSelectedCount').innerText = quizConfig.selectedWords.size; }

    function openWordPicker(sid) {
        currentPickerSid = sid;
        document.getElementById('pickerTitle').innerText = `æŒ‘é¸å–®å­— (Unit ${sid})`;
        if (isQuickQuizPicker) {
            quizConfig.selectedWords.clear();
            const unitWords = masterWordList.filter(w => w.session === sid);
            unitWords.forEach(w => { if (viewedWords.has(w.word)) quizConfig.selectedWords.add(w.word); });
            document.getElementById('btnPickerSave').style.display = 'none';
            document.getElementById('btnPickerQuickStart').style.display = 'flex';
        } else {
            document.getElementById('btnPickerSave').style.display = 'block';
            document.getElementById('btnPickerQuickStart').style.display = 'none';
        }
        document.getElementById('wordPickerModal').style.display = 'block';
        renderPickerGrid();
    }
    function closeWordPicker() { document.getElementById('wordPickerModal').style.display = 'none'; if (!isQuickQuizPicker) { renderQuizRangeGrid(); updateTotalCount(); } }
    function renderPickerGrid() {
        const container = document.getElementById('pickerGrid'); container.innerHTML = "";
        const unitWords = masterWordList.filter(w => w.session === currentPickerSid);
        unitWords.forEach(item => {
            const div = document.createElement('div'); div.className = 'picker-item';
            if (quizConfig.selectedWords.has(item.word)) div.classList.add('picked');
            div.innerText = item.word;
            div.onclick = () => {
                if (quizConfig.selectedWords.has(item.word)) { quizConfig.selectedWords.delete(item.word); div.classList.remove('picked'); }
                else { quizConfig.selectedWords.add(item.word); div.classList.add('picked'); }
            };
            container.appendChild(div);
        });
    }
    function pickerSelectAll() { masterWordList.filter(w => w.session === currentPickerSid).forEach(w => quizConfig.selectedWords.add(w.word)); renderPickerGrid(); }
    function pickerSelectNone() { masterWordList.filter(w => w.session === currentPickerSid).forEach(w => quizConfig.selectedWords.delete(w.word)); renderPickerGrid(); }
    function pickerSelectViewed() {
        masterWordList.filter(w => w.session === currentPickerSid).forEach(w => {
            if (viewedWords.has(w.word)) quizConfig.selectedWords.add(w.word); else quizConfig.selectedWords.delete(w.word);
        }); renderPickerGrid();
    }

    function startConfiguredQuiz() {
        if (quizConfig.selectedWords.size === 0) { alert("è«‹è‡³å°‘é¸æ“‡ 1 å€‹å–®å­—ï¼"); return; }
        if (document.getElementById('quizSetupScreen').classList.contains('active')) {
            quizConfig.timer = document.getElementById('timerSwitch').checked;
            quizConfig.autoNext = document.getElementById('autoNextSwitch').checked;
        }
        let questions = masterWordList.filter(w => quizConfig.selectedWords.has(w.word));
        questions.sort(() => 0.5 - Math.random());
        quizData.list = questions; quizData.index = 0; quizData.score = 0;
        document.getElementById('choiceArea').style.display = (quizConfig.mode === 'choice') ? 'grid' : 'none';
        document.getElementById('spellingArea').style.display = (quizConfig.mode === 'spelling') ? 'block' : 'none';
        document.getElementById('timerBadge').style.display = quizConfig.timer ? 'inline-block' : 'none';
        document.getElementById('btnNextQ').style.display = 'none';
        showScreen('quizScreen');
        loadQuestion();
    }

    function loadQuestion() {
        clearInterval(quizData.timerId);
        document.getElementById('btnNextQ').style.display = 'none';
        document.getElementById('qHint').style.display = 'none';
        document.getElementById('btnShowHint').style.display = 'inline-block';

        const item = quizData.list[quizData.index];
        document.getElementById('qIdx').innerText = quizData.index + 1;
        document.getElementById('qTotal').innerText = quizData.list.length;
        document.getElementById('qHint').innerText = item.word_zh || "(ç„¡ä¸­æ–‡)";
        if (quizConfig.mode === 'choice') renderChoices(item); else renderSpelling();
        playQuizSequence();
    }

    function showHint() {
        document.getElementById('qHint').style.display = 'block';
        document.getElementById('btnShowHint').style.display = 'none';
    }

    function playQuizSequence() {
        const item = quizData.list[quizData.index];
        window.speechSynthesis.cancel();
        const u1 = new SpeechSynthesisUtterance(item.word); u1.rate = 0.9; u1.lang = 'en-US';
        const u2 = new SpeechSynthesisUtterance(item.sentence); u2.rate = 0.9; u2.lang = 'en-US';
        const u3 = new SpeechSynthesisUtterance(item.word); u3.rate = 0.9; u3.lang = 'en-US';
        u3.onend = function() { if (quizConfig.timer) startTimer(); };
        window.speechSynthesis.speak(u1); window.speechSynthesis.speak(u2); window.speechSynthesis.speak(u3);
    }

    function startTimer() {
        clearInterval(quizData.timerId); let timeLeft = 8;
        document.getElementById('timeLeft').innerText = timeLeft;
        quizData.timerId = setInterval(() => {
            timeLeft--; document.getElementById('timeLeft').innerText = timeLeft;
            if (timeLeft <= 0) { clearInterval(quizData.timerId); handleTimeUp(); }
        }, 1000);
    }

    function handleTimeUp() {
        speak("Time's up!");
        saveMistake(quizData.list[quizData.index].word);
        userStats.totalMistakes++;
        if (quizConfig.mode === 'choice') {
            const btns = document.querySelectorAll('.btn-choice');
            btns.forEach(b => { if (b.innerText === quizData.list[quizData.index].word) b.classList.add('correct'); b.disabled = true; });
        } else {
            document.getElementById('spellingInput').value = quizData.list[quizData.index].word;
            document.getElementById('spellingInput').style.borderColor = "var(--danger)";
        }
        handleNextStep();
    }

    function handleNextStep() {
        if (quizConfig.autoNext) setTimeout(nextQuestion, 1500); else document.getElementById('btnNextQ').style.display = 'block';
    }

    function nextQuestion() {
        quizData.index++;
        if (quizData.index < quizData.list.length) loadQuestion(); else showResult();
    }

    function renderChoices(correctItem) {
        const container = document.getElementById('choiceArea'); container.innerHTML = "";
        let opts = [correctItem];
        let pool = quizData.list.length >= 4 ? quizData.list : masterWordList;
        while(opts.length < 4) { const rand = pool[Math.floor(Math.random() * pool.length)]; if (!opts.some(o => o.word === rand.word)) opts.push(rand); }
        opts.sort(() => 0.5 - Math.random());
        opts.forEach(opt => {
            const btn = document.createElement('button'); btn.className = 'btn-choice'; btn.innerText = opt.word;
            btn.onclick = () => checkChoice(btn, opt.word === correctItem.word);
            container.appendChild(btn);
        });
    }

    function checkChoice(btn, isCorrect) {
        clearInterval(quizData.timerId); window.speechSynthesis.cancel();
        const allBtns = document.querySelectorAll('.btn-choice'); allBtns.forEach(b => b.disabled = true);
        if (isCorrect) { btn.classList.add('correct'); quizData.score++; speak("Correct"); userStats.totalCorrect++; } 
        else { btn.classList.add('wrong'); saveMistake(quizData.list[quizData.index].word); speak("Wrong"); userStats.totalMistakes++;
               allBtns.forEach(b => { if (b.innerText === quizData.list[quizData.index].word) b.classList.add('correct'); }); }
        handleNextStep();
    }

    function renderSpelling() {
        const input = document.getElementById('spellingInput'); input.value = ""; input.disabled = false; input.style.borderColor = "#000"; document.getElementById('spellingFeedback').innerText = ""; input.focus();
    }

    function checkSpelling() {
        clearInterval(quizData.timerId); window.speechSynthesis.cancel();
        const input = document.getElementById('spellingInput');
        const correct = quizData.list[quizData.index].word.trim().toLowerCase();
        const userVal = input.value.trim().toLowerCase();
        input.disabled = true;
        if (userVal === correct || (correct.includes('(') && correct.startsWith(userVal))) {
            input.style.borderColor = "var(--success)"; quizData.score++; speak("Correct"); userStats.totalCorrect++;
        } else {
            input.style.borderColor = "var(--danger)";
            document.getElementById('spellingFeedback').innerText = `Ans: ${quizData.list[quizData.index].word}`;
            document.getElementById('spellingFeedback').style.color = "var(--danger)";
            saveMistake(quizData.list[quizData.index].word); speak("Wrong"); userStats.totalMistakes++;
        }
        handleNextStep();
    }
    document.getElementById('spellingInput').addEventListener('keyup', function(e) { if (e.key === 'Enter' && !this.disabled) checkSpelling(); });

    function showResult() {
        userStats.quizCount++;
        saveUserData();
        checkAchievements(); 
        showScreen('resultScreen');
        const finalScore = Math.round((quizData.score / quizData.list.length) * 100);
        document.getElementById('finalScore').innerText = finalScore;
    }

    function quitQuiz() { if (confirm("ç¢ºå®šæ”¾æ£„ï¼Ÿ")) goHome(); }
    function retryQuiz() { startConfiguredQuiz(); }

    function saveMistake(word) { let m = JSON.parse(localStorage.getItem('myMistakes')) || {}; m[word] = (m[word] || 0) + 1; localStorage.setItem('myMistakes', JSON.stringify(m)); }
    function openMistakes() { openAnalysisScreen(); }
    function clearMistakes() { if (confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) { localStorage.removeItem('myMistakes'); openAnalysisScreen(); } }

</script>
</body>
</html>