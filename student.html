<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¸ç”Ÿå–®å­—ç‰¹è¨“ç­ v33.0</title>
    <style>
        /* --- ğŸ¨ è¦–è¦ºé¢¨æ ¼ï¼šæ¸…çˆ½å­¸ç¿’é¢¨ --- */
        :root {
            --bg-color: #f0f4f8;
            --primary: #4a90e2;
            --primary-dark: #357abd;
            --accent: #f5a623;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --card-radius: 16px;
            --success: #2ecc71;
            --danger: #e74c3c;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Microsoft JhengHei', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }

        /* --- é€šç”¨å…ƒä»¶ --- */
        .screen { display: none; width: 100%; max-width: 600px; animation: fadeIn 0.3s ease-out; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 5px; transition: 0.2s; }
        .btn-icon:active { transform: scale(0.9); }
        .btn-back { background: #e0e0e0; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; color: #555; cursor: pointer; }

        /* --- 1. é¦–é ä¸»é¸å–® --- */
        .home-header { text-align: center; margin-bottom: 30px; }
        .app-title { font-size: 1.8rem; font-weight: 900; color: var(--primary); margin: 0; }
        .app-subtitle { color: var(--text-sub); font-size: 1rem; margin-top: 5px; }

        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .menu-card {
            background: white; border-radius: var(--card-radius); padding: 20px;
            text-align: center; cursor: pointer; transition: 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 2px solid transparent;
        }
        .menu-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .menu-card h3 { margin: 0 0 5px 0; color: var(--primary-dark); font-size: 1.4rem; }
        .menu-card p { margin: 0; font-size: 0.85rem; color: #999; }

        /* --- 2. èƒŒå–®å­—å€ (ç€è¦½) --- */
        .study-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: 0; background: var(--bg-color); z-index: 10; padding: 10px 0; }
        .flashcard-container { display: flex; flex-direction: column; gap: 15px; padding-bottom: 120px; }
        .word-card {
            background: white; border-radius: var(--card-radius); padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid var(--primary);
        }
        .wc-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .wc-word { font-size: 1.5rem; font-weight: 800; color: var(--text-main); }
        .wc-zh { font-size: 1rem; color: #666; font-weight: normal; margin-left: 8px; }
        
        .wc-sentence-box { background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 5px; display: flex; align-items: flex-start; gap: 10px; }
        .wc-sent-text { font-size: 0.95rem; color: #444; line-height: 1.4; flex: 1; }
        .wc-sent-zh { display: block; font-size: 0.85rem; color: #888; margin-top: 4px; }
        .btn-speak { background: var(--primary); color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; flex-shrink: 0; }
        
        /* åº•éƒ¨æ¸¬é©—è§¸ç™¼å€ */
        .quiz-launcher {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 550px; background: rgba(255,255,255,0.95);
            padding: 15px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            backdrop-filter: blur(5px); text-align: center; border: 1px solid #ddd;
        }
        .launcher-title { font-size: 0.9rem; color: var(--primary); font-weight: bold; margin-bottom: 10px; }
        .launcher-btns { display: flex; gap: 10px; }
        .btn-mode { flex: 1; padding: 12px; border: none; border-radius: 30px; font-weight: bold; cursor: pointer; font-size: 0.95rem; transition: 0.2s; color: white; }
        .btn-mode.choice { background: linear-gradient(135deg, #4facfe, #00f2fe); box-shadow: 0 4px 10px rgba(79, 172, 254, 0.4); }
        .btn-mode.spelling { background: linear-gradient(135deg, #f093fb, #f5576c); box-shadow: 0 4px 10px rgba(240, 147, 251, 0.4); }
        .btn-mode:active { transform: translateY(2px); }

        /* --- 3. æ¸¬é©—å€ --- */
        .quiz-top-bar { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        .progress-pill { background: #e0e0e0; padding: 5px 12px; border-radius: 15px; font-size: 0.9rem; font-weight: bold; color: #555; }
        
        .quiz-question-card {
            background: white; padding: 30px; border-radius: 20px; text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08); margin-bottom: 25px;
        }
        .q-icon { font-size: 3rem; margin-bottom: 15px; cursor: pointer; transition: 0.2s; }
        .q-icon:active { transform: scale(1.1); }
        .q-hint { font-size: 1.2rem; font-weight: bold; color: var(--text-main); min-height: 1.5em; }
        
        /* é¸æ“‡é¡Œæ¨£å¼ */
        .choice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-option {
            background: white; border: 2px solid #e0e0e0; border-radius: 12px;
            padding: 15px; font-size: 1.1rem; font-weight: bold; color: var(--text-main);
            cursor: pointer; transition: 0.2s;
        }
        .btn-option:hover { border-color: var(--primary); background: #f0f8ff; }
        .btn-option.correct { background: var(--success); color: white; border-color: var(--success); }
        .btn-option.wrong { background: var(--danger); color: white; border-color: var(--danger); }

        /* æ‹¼å­—é¡Œæ¨£å¼ */
        .spelling-area { display: flex; flex-direction: column; gap: 15px; }
        .input-spelling {
            width: 100%; padding: 15px; font-size: 1.5rem; text-align: center;
            border: 3px solid #e0e0e0; border-radius: 12px; outline: none;
            text-transform: lowercase; font-weight: bold; letter-spacing: 2px;
        }
        .input-spelling:focus { border-color: var(--primary); }
        .btn-submit { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        .feedback-msg { text-align: center; font-weight: bold; margin-top: 10px; height: 1.2em; }

        /* çµæœé  */
        .result-box { text-align: center; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .score-big { font-size: 4rem; font-weight: 900; color: var(--primary); margin: 10px 0; }

    </style>
</head>
<body>

    <div id="homeScreen" class="screen active">
        <div class="home-header">
            <h1 class="app-title">å­¸ç”Ÿå–®å­—ç‰¹è¨“ç­</h1>
            <p class="app-subtitle">Choose a unit to start!</p>
        </div>
        
        <div id="menuContainer" class="menu-grid">
            </div>

        <div style="margin-top:30px; border-top: 1px dashed #ccc; padding-top:20px;">
            <button class="menu-card" style="width:100%; background:#fff8e1; border-color:#ffe0b2;" onclick="startSmartReview()">
                <span style="font-size:2rem;">ğŸ¤–</span>
                <h3>æ™ºèƒ½ç¸½è¤‡ç¿’</h3>
                <p>éš¨æ©Ÿå¾æ‰€æœ‰å–®å­—ä¸­æŠ½è€ƒ 20 é¡Œ</p>
            </button>
        </div>
    </div>

    <div id="studyScreen" class="screen">
        <div class="study-header">
            <button class="btn-back" onclick="showScreen('homeScreen')">â¬… å›é¸å–®</button>
            <h2 id="studyTitle" style="margin:0; color:var(--primary);">Unit 1</h2>
            <div style="width:60px;"></div>
        </div>

        <div id="flashcardList" class="flashcard-container">
            </div>

        <div class="quiz-launcher">
            <div class="launcher-title">ğŸ”¥ è®€å®Œäº†å—ï¼Ÿç«‹å³æ¸¬é©—çœ‹çœ‹ï¼</div>
            <div class="launcher-btns">
                <button class="btn-mode choice" onclick="startQuiz('choice')">ğŸ‘† é¸æ“‡é¡Œ</button>
                <button class="btn-mode spelling" onclick="startQuiz('spelling')">âŒ¨ï¸ æ‹¼å­—é¡Œ</button>
            </div>
        </div>
    </div>

    <div id="quizScreen" class="screen">
        <div class="quiz-top-bar">
            <button class="btn-back" onclick="quitQuiz()">âŒ æ”¾æ£„</button>
            <div class="progress-pill"><span id="qIdx">1</span> / <span id="qTotal">10</span></div>
        </div>

        <div class="quiz-question-card">
            <div class="q-icon" onclick="playQuestionAudio()">ğŸ”Š</div>
            <div class="q-hint" id="qHint">é€™è£¡æœƒé¡¯ç¤ºä¸­æ–‡æç¤º</div>
        </div>

        <div id="choiceArea" class="choice-grid" style="display:none;">
            </div>

        <div id="spellingArea" class="spelling-area" style="display:none;">
            <input type="text" id="spellingInput" class="input-spelling" placeholder="type here..." autocomplete="off">
            <div id="spellingFeedback" class="feedback-msg"></div>
            <button class="btn-submit" onclick="checkSpelling()">é€å‡ºç­”æ¡ˆ</button>
        </div>
    </div>

    <div id="resultScreen" class="screen">
        <div class="result-box">
            <div style="font-size:3rem;">ğŸ†</div>
            <h2>æ¸¬é©—å®Œæˆï¼</h2>
            <div class="score-big" id="finalScore">100</div>
            <p id="finalMsg" style="color:#777;">å¤ªæ£’äº†ï¼</p>
            <button class="btn-submit" onclick="showScreen('homeScreen')">ğŸ  å›é¦–é </button>
            <br><br>
            <button class="btn-back" onclick="restartQuiz()">ğŸ”„ å†æ¸¬ä¸€æ¬¡</button>
        </div>
    </div>

<script src="words.js"></script>
<script>
    // --- å…¨åŸŸè®Šæ•¸ ---
    let sessions = [];
    let currentStudyList = []; // ç•¶å‰æ­£åœ¨å­¸ç¿’çš„å–®å­—è¡¨ (ç€è¦½éçš„)
    let quizList = [];         // æ¸¬é©—é¡Œåº«
    let currentQIndex = 0;
    let score = 0;
    let quizMode = 'choice';   // 'choice' or 'spelling'

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        if (typeof masterWordList === 'undefined') {
            alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è³‡æ–™åº« words.js");
            return;
        }
        // å–å¾—ä¸¦æ’åºæ‰€æœ‰ Session (Unit)
        sessions = [...new Set(masterWordList.map(item => item.session))].sort();
        renderMenu();
    };

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
    }

    // ğŸ”Š èªéŸ³æ’­æ”¾åŠŸèƒ½ (æ”¯æ´ Word å’Œ Sentence)
    function speak(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        u.rate = 0.8; // ç¨å¾®æ”¾æ…¢èªé€Ÿé©åˆå­¸ç”Ÿ
        window.speechSynthesis.speak(u);
    }

    // --- 1. é¸å–®æ¸²æŸ“ ---
    function renderMenu() {
        const container = document.getElementById('menuContainer');
        container.innerHTML = "";
        
        sessions.forEach(sid => {
            const count = masterWordList.filter(w => w.session === sid).length;
            const btn = document.createElement('div');
            btn.className = 'menu-card';
            btn.innerHTML = `<h3>Unit ${sid}</h3><p>${count} Words</p>`;
            btn.onclick = () => loadStudyMode(sid);
            container.appendChild(btn);
        });
    }

    // --- 2. è¼‰å…¥èƒŒå–®å­—æ¨¡å¼ ---
    function loadStudyMode(sid) {
        // è¨­å®šç•¶å‰ç¯„åœ
        currentStudyList = masterWordList.filter(w => w.session === sid);
        
        document.getElementById('studyTitle').innerText = `Unit ${sid}`;
        const listDiv = document.getElementById('flashcardList');
        listDiv.innerHTML = "";

        currentStudyList.forEach(item => {
            // è™•ç†å¼•è™Ÿä»¥å… HTML å±¬æ€§å‡ºéŒ¯
            const safeWord = item.word.replace(/'/g, "\\'");
            const safeSent = item.sentence.replace(/'/g, "\\'");

            const card = document.createElement('div');
            card.className = 'word-card';
            card.innerHTML = `
                <div class="wc-header">
                    <div>
                        <span class="wc-word">${item.word}</span>
                        ${item.word_zh ? `<span class="wc-zh">${item.word_zh}</span>` : ''}
                    </div>
                    <button class="btn-speak" onclick="speak('${safeWord}')">ğŸ”Š</button>
                </div>
                <div class="wc-sentence-box">
                    <div class="wc-sent-text">
                        ${item.sentence}
                        ${item.sentence_zh ? `<span class="wc-sent-zh">${item.sentence_zh}</span>` : ''}
                    </div>
                    <button class="btn-icon" style="color:var(--primary);" onclick="speak('${safeSent}')">ğŸ”Š</button>
                </div>
            `;
            listDiv.appendChild(card);
        });

        showScreen('studyScreen');
    }

    // --- 3. æ¸¬é©—é‚è¼¯ ---

    // å¾å­¸ç¿’é é¢å•Ÿå‹•æ¸¬é©— (æ¸¬é©—å‰›èƒŒéçš„)
    function startQuiz(mode) {
        if(currentStudyList.length === 0) return;
        quizMode = mode;
        // è¤‡è£½ä¸¦æ´—ç‰Œ
        let list = [...currentStudyList].sort(() => 0.5 - Math.random());
        // å¦‚æœé¡Œç›®å¤ªå¤šï¼Œå¯ä»¥é™åˆ¶æ•¸é‡ (ä¾‹å¦‚æœ€å¤š 20 é¡Œ)ï¼Œé€™è£¡å…ˆå…¨æ¸¬
        initQuizEngine(list);
    }

    // æ™ºèƒ½ç¸½è¤‡ç¿’ (å¾é¦–é å•Ÿå‹•)
    function startSmartReview() {
        // éš¨æ©ŸæŠ½ 20 é¡Œ
        let list = [...masterWordList].sort(() => 0.5 - Math.random()).slice(0, 20);
        // é è¨­å…ˆå•æ¨¡å¼ï¼Œé€™è£¡ç°¡åŒ–ç‚ºå½ˆçª—è©¢å•ï¼Œæˆ–é è¨­é¸æ“‡é¡Œ
        const userMode = confirm("æŒ‰ã€Œç¢ºå®šã€é€²è¡Œé¸æ“‡é¡Œï¼ŒæŒ‰ã€Œå–æ¶ˆã€é€²è¡Œæ‹¼å­—é¡Œ") ? 'choice' : 'spelling';
        quizMode = userMode;
        initQuizEngine(list);
    }

    function initQuizEngine(list) {
        quizList = list;
        currentQIndex = 0;
        score = 0;
        
        // åˆ‡æ› UI
        document.getElementById('choiceArea').style.display = (quizMode === 'choice') ? 'grid' : 'none';
        document.getElementById('spellingArea').style.display = (quizMode === 'spelling') ? 'flex' : 'none';
        
        showScreen('quizScreen');
        loadQuestion();
    }

    function loadQuestion() {
        const item = quizList[currentQIndex];
        document.getElementById('qIdx').innerText = currentQIndex + 1;
        document.getElementById('qTotal').innerText = quizList.length;
        
        // é¡¯ç¤ºæç¤º (ä¸­æ–‡)
        document.getElementById('qHint').innerText = item.word_zh || "(è½éŸ³è¾¨å­—)";
        
        // è‡ªå‹•æ’­æ”¾è²éŸ³
        setTimeout(() => speak(item.word), 300);

        if (quizMode === 'choice') {
            setupChoiceOptions(item);
        } else {
            setupSpellingInput();
        }
    }

    function playQuestionAudio() {
        const item = quizList[currentQIndex];
        speak(item.word);
    }

    // --- é¸æ“‡é¡Œè™•ç† ---
    function setupChoiceOptions(correctItem) {
        const container = document.getElementById('choiceArea');
        container.innerHTML = "";
        
        // ç”¢ç”Ÿ 3 å€‹å¹²æ“¾é …
        let options = [correctItem];
        while (options.length < 4) {
            const rand = masterWordList[Math.floor(Math.random() * masterWordList.length)];
            if (!options.includes(rand)) options.push(rand);
        }
        // æ´—ç‰Œé¸é …
        options.sort(() => 0.5 - Math.random());

        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'btn-option';
            btn.innerText = opt.word;
            btn.onclick = () => checkChoice(btn, opt.word === correctItem.word);
            container.appendChild(btn);
        });
    }

    function checkChoice(btn, isCorrect) {
        // é–å®šæ‰€æœ‰æŒ‰éˆ•é˜²æ­¢é€£é»
        const allBtns = document.querySelectorAll('.btn-option');
        allBtns.forEach(b => b.disabled = true);

        if (isCorrect) {
            btn.classList.add('correct');
            score++;
            speak("Correct!");
        } else {
            btn.classList.add('wrong');
            // æ¨™ç¤ºå‡ºæ­£ç¢ºç­”æ¡ˆ
            allBtns.forEach(b => {
                if(b.innerText === quizList[currentQIndex].word) b.classList.add('correct');
            });
            speak("Wrong");
        }

        setTimeout(nextQuestion, 1200);
    }

    // --- æ‹¼å­—é¡Œè™•ç† ---
    function setupSpellingInput() {
        const input = document.getElementById('spellingInput');
        input.value = "";
        input.disabled = false;
        document.getElementById('spellingFeedback').innerText = "";
        document.getElementById('spellingFeedback').style.color = "transparent";
        input.focus();
    }

    function checkSpelling() {
        const input = document.getElementById('spellingInput');
        const feedback = document.getElementById('spellingFeedback');
        const correctWord = quizList[currentQIndex].word.trim();
        const userAns = input.value.trim().toLowerCase();

        // ç§»é™¤æ‹¬è™Ÿå…§å®¹æ¯”å° (ä¾‹å¦‚ "a (an)" åªæ¯”å° "a")
        // ç°¡å–®è™•ç†ï¼šå¦‚æœä½¿ç”¨è€…è¼¸å…¥å®Œå…¨æ­£ç¢ºï¼Œæˆ–è¼¸å…¥æ­£ç¢ºéƒ¨åˆ†
        const cleanCorrect = correctWord.toLowerCase();

        if (userAns === cleanCorrect || (cleanCorrect.includes('(') && cleanCorrect.startsWith(userAns))) {
            input.style.borderColor = "var(--success)";
            feedback.innerText = "Correct! âœ…";
            feedback.style.color = "var(--success)";
            score++;
            speak("Correct!");
        } else {
            input.style.borderColor = "var(--danger)";
            feedback.innerText = `Answer: ${correctWord}`;
            feedback.style.color = "var(--danger)";
            speak(`The answer is ${correctWord}`);
        }

        input.disabled = true;
        setTimeout(nextQuestion, 2000); // æ‹¼å­—é¡Œçµ¦å¤šä¸€é»æ™‚é–“çœ‹æ­£ç¢ºç­”æ¡ˆ
    }

    // æ”¯æ´æŒ‰ Enter é€å‡º
    document.getElementById('spellingInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter' && !this.disabled) {
            checkSpelling();
        }
    });

    // --- ä¸‹ä¸€é¡Œ & çµç®— ---
    function nextQuestion() {
        currentQIndex++;
        if (currentQIndex < quizList.length) {
            loadQuestion();
        } else {
            showResult();
        }
    }

    function showResult() {
        showScreen('resultScreen');
        const finalScore = Math.round((score / quizList.length) * 100);
        document.getElementById('finalScore').innerText = finalScore;
        
        const msg = document.getElementById('finalMsg');
        if(finalScore === 100) msg.innerText = "å¤ªç¥å•¦ï¼å…¨éƒ¨ç­”å°ï¼ğŸ‰";
        else if(finalScore >= 80) msg.innerText = "å¾ˆæ£’å–”ï¼ç¹¼çºŒä¿æŒï¼ğŸ’ª";
        else if(finalScore >= 60) msg.innerText = "åŠæ ¼äº†ï¼Œå†å¤šç·´ç¿’ä¸€ä¸‹ï¼ğŸ“š";
        else msg.innerText = "åŠ æ²¹ï¼å¤šèƒŒå¹¾æ¬¡å°±æœƒäº†ï¼ğŸ”¥";
    }

    function quitQuiz() {
        if(confirm("ç¢ºå®šè¦æ”¾æ£„æ¸¬é©—å—ï¼Ÿ")) {
            showScreen('homeScreen');
        }
    }

    function restartQuiz() {
        // ä½¿ç”¨åŒä¸€çµ„åˆ—è¡¨é‡æ–°æ¸¬é©—
        startQuiz(quizMode); 
    }

</script>
</body>
</html>