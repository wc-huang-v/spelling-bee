<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¸ç”Ÿè‡ªä¸»å­¸ç¿’å¹³æ¿ v42.1 (No Hint Default)</title>
    <style>
        /* --- ğŸ¨ è¦–è¦ºé¢¨æ ¼ --- */
        :root {
            --bg-color: #eef2f5;
            --primary: #4a90e2;
            --primary-dark: #2c6eb5;
            --accent: #ffb74d;
            --gold: #f1c40f;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --card-radius: 20px;
            --success: #66bb6a;
            --danger: #ef5350;
            
            /* ç¨€æœ‰åº¦é¡è‰² */
            --tier-common: #cd7f32; 
            --tier-rare: #95a5a6;   
            --tier-epic: #ffb300;   
            --tier-legend: #9b59b6; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Microsoft JhengHei', 'Varela Round', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }

        /* --- é é¢åˆ‡æ› --- */
        .screen { display: none; width: 100%; max-width: 700px; animation: fadeIn 0.3s ease-out; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* --- é€šç”¨å…ƒä»¶ --- */
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 5px; }
        .btn-back { background: #fff; border: 1px solid #ccc; padding: 8px 20px; border-radius: 30px; font-weight: bold; color: #555; cursor: pointer; display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .page-title { font-size: 1.5rem; font-weight: 900; color: var(--text-main); margin: 0; }

        /* --- 1. åŠŸèƒ½ç¸½è¦½ (Dashboard) --- */
        .hero-banner { text-align: center; margin-bottom: 30px; margin-top: 10px; }
        .hero-title { font-size: 2rem; font-weight: 900; color: var(--primary); margin-bottom: 5px; text-shadow: 2px 2px 0 white; }
        .hero-sub { color: var(--text-sub); }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .dash-btn {
            background: white; border-radius: 25px; padding: 25px 15px;
            text-align: center; cursor: pointer; transition: 0.2s; border: none;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08); position: relative; overflow: hidden;
        }
        .dash-btn:active { transform: scale(0.98); }
        .dash-btn h2 { font-size: 1.4rem; margin: 10px 0 5px; color: var(--text-main); }
        .dash-btn p { color: var(--text-sub); margin: 0; font-size: 0.9rem; }
        .dash-icon { font-size: 3rem; display: block; margin-bottom: 5px; }
        .dash-btn.study-mode { border-bottom: 6px solid var(--success); }
        .dash-btn.quiz-mode { border-bottom: 6px solid var(--accent); }
        .dash-btn.achievement-mode { border-bottom: 6px solid var(--gold); grid-column: span 2; display: flex; align-items: center; justify-content: center; gap: 20px; padding: 20px; }
        .dash-btn.analysis-mode { border-bottom: 6px solid var(--danger); grid-column: span 2; display: flex; align-items: center; justify-content: center; gap: 20px; padding: 20px; }

        /* --- ğŸ† ç¨±è™Ÿç³»çµ± --- */
        .achievement-container { padding-bottom: 50px; }
        .category-header { font-size: 1.2rem; font-weight: 900; margin: 25px 0 15px 0; padding-left: 10px; border-left: 5px solid #ccc; display: flex; align-items: center; gap: 8px; }
        .cat-learn { border-color: var(--primary); color: var(--primary-dark); }
        .cat-quiz { border-color: var(--danger); color: #c0392b; }
        .cat-milestone { border-color: var(--gold); color: #d35400; }
        .cat-secret { border-color: var(--tier-legend); color: #8e44ad; background: linear-gradient(90deg, #f3e5f5, transparent); padding: 5px 10px; border-radius: 0 10px 10px 0; }

        .achievement-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .badge-card { background: #f0f0f0; border-radius: 16px; padding: 20px 10px; text-align: center; opacity: 0.6; filter: grayscale(1); transition: 0.3s; position: relative; border: 2px solid transparent; overflow: hidden; }
        .badge-card.unlocked { background: white; opacity: 1; filter: grayscale(0); box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .badge-card.unlocked.common { border-color: var(--tier-common); }
        .badge-card.unlocked.rare { border-color: var(--tier-rare); background: #fdfdfd; }
        .badge-card.unlocked.epic { border-color: var(--tier-epic); background: #fffbe6; box-shadow: 0 0 10px rgba(255, 179, 0, 0.2); }
        .badge-card.unlocked.legendary { border-color: var(--tier-legend); background: linear-gradient(135deg, #fff, #f8e1ff); box-shadow: 0 0 15px rgba(155, 89, 182, 0.3); }
        .badge-icon { font-size: 3rem; margin-bottom: 10px; display: block; transform: scale(0.9); transition: 0.3s; }
        .badge-card.unlocked:hover .badge-icon { transform: scale(1.1) rotate(5deg); }
        .badge-title { font-weight: 900; color: var(--text-main); font-size: 1rem; margin-bottom: 5px; line-height: 1.2; }
        .badge-desc { font-size: 0.75rem; color: #777; line-height: 1.3; }
        
        .toast-notification { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.95); padding: 15px 25px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); z-index: 2000; display: flex; align-items: center; gap: 15px; border: 2px solid var(--gold); backdrop-filter: blur(5px); transition: top 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .toast-icon { font-size: 2rem; animation: bounce 1s infinite; }
        .toast-text h4 { margin: 0; color: var(--text-main); font-weight: 900; }
        .toast-text p { margin: 0; color: var(--primary); font-size: 0.9rem; font-weight: bold; }
        .toast-notification.show { top: 30px; }
        @keyframes bounce { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-5px);} }

        /* --- å¼±é»åˆ†æ --- */
        .weak-stats-card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .weak-header { font-size: 1.2rem; font-weight: bold; color: var(--danger); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .top-weak-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
        .weak-item-card { background: #fff5f5; border: 1px solid #ffcdd2; border-radius: 12px; padding: 15px; min-width: 100px; text-align: center; flex-shrink: 0; }
        .weak-word { font-size: 1.2rem; font-weight: 900; color: var(--danger); display: block; }
        .weak-count { font-size: 0.8rem; color: #888; margin-top: 5px; }
        .full-mistake-list { max-height: 300px; overflow-y: auto; }
        .mistake-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px dashed #eee; }
        .rank-num { font-weight: 900; color: #ccc; width: 30px; font-style: italic; }
        .rank-num.top1 { color: #f1c40f; font-size: 1.2rem; }
        .rank-num.top2 { color: #95a5a6; font-size: 1.1rem; }
        .rank-num.top3 { color: #d35400; font-size: 1.1rem; }
        .mistake-word { font-weight: bold; font-size: 1.1rem; flex: 1; text-align: left; }
        .mistake-val { color: var(--danger); font-weight: bold; background: #ffebee; padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; }
        .btn-action-group { display: flex; gap: 10px; margin-top: 15px; }

        /* --- å…¶ä»–åŸæœ‰æ¨£å¼ --- */
        .unit-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; }
        .unit-card { background: white; border: 2px solid transparent; border-radius: 15px; padding: 15px; text-align: center; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .unit-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .unit-card h3 { margin: 0; font-size: 1.2rem; }
        .unit-card span { font-size: 0.8rem; opacity: 0.8; }
        .word-overview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; padding-bottom: 100px; }
        .word-overview-card { background: white; border-radius: 15px; padding: 20px 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; border: 2px solid transparent; position: relative; }
        .word-overview-card h4 { margin: 0; font-size: 1.1rem; color: var(--text-main); }
        .word-overview-card.read { background-color: var(--read-color); border-color: var(--success); }
        .word-overview-card.read::after { content: "âœ“"; position: absolute; top: 5px; right: 5px; color: var(--success); font-weight: bold; font-size: 0.9rem; }
        .detail-container { background: white; border-radius: 25px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; text-align: center; min-height: 400px; justify-content: center; position: relative; }
        .detail-word { font-size: 3rem; font-weight: 900; color: var(--text-main); margin-bottom: 10px; }
        .detail-zh { font-size: 1.5rem; color: #888; font-weight: normal; margin-bottom: 30px; }
        .detail-sent-box { background: #f8f9fa; padding: 20px; border-radius: 15px; width: 100%; margin-bottom: 20px; text-align: left; border-left: 5px solid var(--primary); }
        .detail-sent-en { font-size: 1.2rem; color: #444; line-height: 1.4; margin-bottom: 8px; }
        .detail-sent-zh { font-size: 1rem; color: #888; }
        .audio-btn-big { background: var(--primary); color: white; width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 10px rgba(74, 144, 226, 0.4); display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; }
        .audio-btn-big:active { transform: scale(0.95); }
        .nav-controls { display: flex; justify-content: space-between; width: 100%; margin-top: auto; }
        .nav-arrow { background: #f0f0f0; border: none; padding: 15px 25px; border-radius: 30px; font-weight: bold; cursor: pointer; font-size: 1rem; color: #555; }
        .setup-section { background: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .setup-title { font-weight: bold; margin-bottom: 15px; display: block; color: var(--primary-dark); }
        .toggle-group { display: flex; background: #f0f0f0; border-radius: 30px; padding: 5px; overflow: hidden; }
        .toggle-btn { flex: 1; border: none; background: transparent; padding: 12px; font-weight: bold; color: #777; cursor: pointer; border-radius: 30px; transition: 0.2s; }
        .toggle-btn.active { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .range-selector { display: flex; flex-wrap: wrap; gap: 8px; max-height: 250px; overflow-y: auto; }
        .range-btn { padding: 10px 15px; border-radius: 12px; border: 1px solid #ddd; background: white; cursor: pointer; font-size: 0.95rem; transition: 0.2s; display: flex; align-items: center; gap: 5px; flex-grow: 1; justify-content: center; }
        .range-btn.has-data { border-color: var(--accent); background: #fff8e1; color: #d35400; font-weight: bold; }
        .badge-count { background: var(--accent); color: white; font-size: 0.75rem; padding: 2px 6px; border-radius: 10px; margin-left: 5px; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(22px); }
        .btn-start-quiz { width: 100%; background: linear-gradient(to right, #f5a623, #f76b1c); color: white; padding: 18px; border: none; border-radius: 15px; font-size: 1.3rem; font-weight: 900; cursor: pointer; box-shadow: 0 5px 15px rgba(245, 166, 35, 0.4); margin-top: 10px; }
        .word-picker-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; max-height: 300px; overflow-y: auto; margin-top: 10px; }
        .picker-item { background: #f9f9f9; border: 1px solid #eee; padding: 10px; border-radius: 8px; text-align: center; cursor: pointer; font-size: 0.9rem; position: relative; overflow: hidden; }
        .picker-item.picked { background: #e3f2fd; border-color: var(--primary); color: var(--primary-dark); font-weight: bold; }
        .picker-item.picked::after { content: "âœ“"; position: absolute; top: 2px; right: 4px; font-size: 0.8rem; }
        .picker-actions { display: flex; gap: 8px; margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; }
        .btn-picker-action { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #ddd; background: white; cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: 0.2s; }
        .btn-picker-action:active { background: #f0f0f0; }
        .btn-picker-action.accent { color: var(--primary); border-color: var(--primary); background: #e3f2fd; }
        .quick-quiz-actions { display: flex; gap: 10px; margin-top: 15px; }
        .btn-quick-start { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: bold; color: white; cursor: pointer; font-size: 1rem; }
        .btn-quick-start.choice { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .btn-quick-start.spelling { background: linear-gradient(135deg, #f093fb, #f5576c); }
        
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 10px 20px; border-radius: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .timer-badge { background: #ffebee; color: var(--danger); padding: 5px 12px; border-radius: 15px; font-weight: bold; display: none; }
        
        /* Quiz Question Card */
        .question-card { background: white; padding: 40px 20px; border-radius: 20px; text-align: center; margin-bottom: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
        .q-icon { font-size: 4rem; cursor: pointer; transition: 0.2s; }
        .q-icon:active { transform: scale(0.9); }
        .q-hint { margin-top: 15px; font-size: 1.2rem; font-weight: bold; color: var(--text-main); min-height: 1.5em; }
        .btn-text-action { background: transparent; border: none; color: #aaa; text-decoration: underline; cursor: pointer; margin-top: 10px; font-size: 0.9rem; }
        .btn-text-action:hover { color: var(--primary); }

        .choice-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-choice { background: white; border: 2px solid #eee; padding: 20px; border-radius: 15px; font-size: 1.1rem; font-weight: bold; color: var(--text-main); cursor: pointer; transition: 0.1s; }
        .btn-choice:active { transform: scale(0.98); background: #f0f8ff; }
        .btn-choice.correct { background: var(--success); color: white; border-color: var(--success); }
        .btn-choice.wrong { background: var(--danger); color: white; border-color: var(--danger); }
        .spelling-container { text-align: center; }
        .input-spelling { width: 100%; padding: 15px; font-size: 1.8rem; text-align: center; border: 3px solid #ddd; border-radius: 15px; letter-spacing: 2px; outline: none; margin-bottom: 15px; text-transform: lowercase; }
        .input-spelling:focus { border-color: var(--primary); }
        .btn-submit-spelling { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 15px; font-size: 1.2rem; font-weight: bold; cursor: pointer; }
        .btn-next-manual { display: none; width: 100%; padding: 15px; background: linear-gradient(to right, #4facfe, #00f2fe); color: white; border: none; border-radius: 30px; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin-top: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .result-box { background: white; border-radius: 20px; padding: 40px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .score-display { font-size: 5rem; font-weight: 900; color: var(--primary); margin: 10px 0; text-shadow: 3px 3px 0 #eee; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; animation: fadeIn 0.2s; }
        .modal-content { background: white; margin: 10% auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 20px; position: relative; max-height: 80vh; overflow-y: auto; }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; color: #aaa; }

    </style>
</head>
<body>

    <div id="toastNotification" class="toast-notification">
        <div class="toast-icon">ğŸ†</div>
        <div class="toast-text">
            <h4>ç²å¾—æ–°ç¨±è™Ÿï¼</h4>
            <p id="toastMsg">å–®å­—å°å­¸å¾’</p>
        </div>
    </div>

    <div id="homeScreen" class="screen active">
        <div class="hero-banner">
            <div class="hero-title">å­¸ç”Ÿå–®å­—ç‰¹è¨“ç­</div>
            <div class="hero-sub">Welcome! What do you want to do?</div>
        </div>

        <div class="dashboard-grid">
            <button class="dash-btn study-mode" onclick="openUnitSelector('study')">
                <span class="dash-icon">ğŸ“–</span>
                <h2>èƒŒå–®å­—</h2>
                <p>å…ˆçœ‹ç¸½è¡¨ï¼Œå†é»é€²å»èƒŒ</p>
            </button>
            <button class="dash-btn quiz-mode" onclick="openQuizSetup()">
                <span class="dash-icon">ğŸ“</span>
                <h2>è‡ªæˆ‘æ¸¬é©—</h2>
                <p>æŒ‘é¸å–®å­—ï¼Œé™æ™‚æŒ‘æˆ°</p>
            </button>
            <button class="dash-btn achievement-mode" onclick="openAchievementScreen()">
                <span class="dash-icon">ğŸ†</span>
                <div>
                    <h2 style="text-align:left;">ç¨±è™Ÿè’é›†</h2>
                    <p style="text-align:left;">æŸ¥çœ‹ä½ çš„å­¸ç¿’æˆå°±</p>
                </div>
            </button>
            <button class="dash-btn analysis-mode" onclick="openAnalysisScreen()">
                <span class="dash-icon">ğŸ“Š</span>
                <div>
                    <h2 style="text-align:left;">å¼±é»åˆ†æ</h2>
                    <p style="text-align:left;">å°ˆæ”»å¸¸éŒ¯å–®å­—</p>
                </div>
            </button>
        </div>
    </div>

    <div id="achievementScreen" class="screen">
        <div class="page-header">
            <button class="btn-back" onclick="goHome()">â¬… å›é¦–é </button>
            <h2 class="page-title">ç¨±è™Ÿè’é›†</h2>
            <div style="width: 80px;"></div>
        </div>
        <div class="achievement-container">
            <div id="badgeGrid" class="achievement-grid"></div>
        </div>
    </div>

    <div id="analysisScreen" class="screen">
        <div class="page-header">
            <button class="btn-back" onclick="goHome()">â¬… å›é¦–é </button>
            <h2 class="page-title">å¼±é»åˆ†æ</h2>
            <div style="width: 80px;"></div>
        </div>

        <div class="weak-stats-card">
            <div class="weak-header">âš ï¸ æœ€å¸¸éŒ¯çš„å–®å­— (Top 3)</div>
            <div id="topWeakList" class="top-weak-list">
                <div style="color:#999;">ç›®å‰æ²’æœ‰è³‡æ–™</div>
            </div>
        </div>

        <div class="setup-section">
            <span class="setup-title">ğŸ“ è©³ç´°éŒ¯é¡Œåˆ—è¡¨</span>
            <div id="fullMistakeList" class="full-mistake-list"></div>
        </div>

        <div class="btn-action-group">
            <button class="btn-start-quiz" style="background: var(--danger); box-shadow: 0 5px 15px rgba(239, 83, 80, 0.4);" onclick="startTop30WeaknessQuiz()">ğŸ”¥ æŒ‘æˆ° Top 30 å¸¸éŒ¯å­—</button>
        </div>
    </div>

    <div id="unitSelectScreen" class="screen">
        <div class="page-header">
            <button class="btn-back" onclick="goHome()">â¬… å›é¦–é </button>
            <h2 class="page-title">é¸æ“‡å–®å…ƒ</h2>
            <div style="width: 80px;"></div>
        </div>
        <div id="unitGridContainer" class="unit-grid"></div>
    </div>

    <div id="studyOverviewScreen" class="screen">
        <div class="page-header">
            <button class="btn-back" onclick="openUnitSelector('study')">â¬… å›å–®å…ƒ</button>
            <h2 class="page-title" id="overviewTitle">Unit A</h2>
            <div style="width: 60px;"></div>
        </div>
        <div id="overviewGrid" class="word-overview-grid"></div>
        <div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px;">
            <button class="btn-start-quiz" style="background: linear-gradient(to right, #4caf50, #2e7d32); box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);" onclick="openQuickQuizPicker()">
                âš¡ èƒŒå®Œäº†ï¼é¦¬ä¸Šæ¸¬é©—
            </button>
        </div>
    </div>

    <div id="studyDetailScreen" class="screen">
        <div class="page-header">
            <button class="btn-back" onclick="backToOverview()">â¬… å›ç¸½è¡¨</button>
            <div style="font-weight:bold; color:#aaa;">Word <span id="detailIdx">1</span> / <span id="detailTotal">20</span></div>
            <div style="width: 80px;"></div>
        </div>
        <div class="detail-container">
            <div class="detail-word" id="cardWord">Apple</div>
            <div class="detail-zh" id="cardZh">è˜‹æœ</div>
            <button class="audio-btn-big" onclick="playCurrentCardAudio()">ğŸ”Š</button>
            <div class="detail-sent-box">
                <div class="detail-sent-en" id="cardSentEn">I eat an apple.</div>
                <div class="detail-sent-zh" id="cardSentZh">æˆ‘åƒä¸€é¡†è˜‹æœã€‚</div>
                <button class="btn-icon" style="color:var(--primary); float:right; margin-top:-20px;" onclick="playCurrentCardSent()">ğŸ”Š</button>
            </div>
            <div class="nav-controls">
                <button class="nav-arrow" onclick="prevCard()">â—€ ä¸Šä¸€å€‹</button>
                <button class="nav-arrow" onclick="nextCard()">ä¸‹ä¸€å€‹ â–¶</button>
            </div>
        </div>
    </div>

    <div id="quizSetupScreen" class="screen">
        <div class="page-header">
            <button class="btn-back" onclick="goHome()">â¬… å›é¦–é </button>
            <h2 class="page-title">æ¸¬é©—è¨­å®š</h2>
            <div style="width: 80px;"></div>
        </div>
        <div class="setup-section">
            <span class="setup-title">1. é¸æ“‡é¡Œå‹</span>
            <div class="toggle-group">
                <button class="toggle-btn active" id="modeChoice" onclick="setQuizMode('choice')">ğŸ‘† é¸æ“‡é¡Œ (å››é¸ä¸€)</button>
                <button class="toggle-btn" id="modeSpelling" onclick="setQuizMode('spelling')">âŒ¨ï¸ æ‹¼å­—é¡Œ (è¼¸å…¥)</button>
            </div>
        </div>
        <div class="setup-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span class="setup-title" style="margin:0;">2. é¸æ“‡å–®å­— (é»æ“Šå–®å…ƒå‹¾é¸)</span>
                <button class="btn-icon" style="font-size:0.9rem; color:var(--danger);" onclick="clearAllSelectedWords()">æ¸…ç©º</button>
            </div>
            <div style="margin-bottom:10px; font-size:0.9rem; color:#666;">
                ç›®å‰å·²é¸ï¼š<b id="totalSelectedCount" style="color:var(--primary); font-size:1.2rem;">0</b> å€‹å­—
            </div>
            <div id="quizRangeGrid" class="range-selector"></div>
        </div>
        <div class="setup-section">
            <span class="setup-title">3. é€²éšè¨­å®š</span>
            <div class="setting-row">
                <span>è‡ªå‹•æ›é¡Œ (ç­”å°å¾Œè‡ªå‹•è·³è½‰)</span>
                <label class="switch">
                    <input type="checkbox" id="autoNextSwitch" checked>
                    <span class="slider round"></span>
                </label>
            </div>
            <div style="height:10px;"></div>
            <div class="setting-row">
                <span>é™æ™‚æŒ‘æˆ° (æ¯é¡Œ8ç§’)</span>
                <label class="switch">
                    <input type="checkbox" id="timerSwitch">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
        <button class="btn-start-quiz" onclick="startConfiguredQuiz()">ğŸš€ é–‹å§‹æ¸¬é©—</button>
    </div>

    <div id="wordPickerModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeWordPicker()">&times;</span>
            <h3 id="pickerTitle" style="margin-top:0; color:var(--text-main);">æŒ‘é¸å–®å­—</h3>
            <div class="picker-actions">
                <button class="btn-picker-action accent" onclick="pickerSelectViewed()">åƒ…é¸å·²è®€</button>
                <button class="btn-picker-action" onclick="pickerSelectAll()">å…¨é¸</button>
                <button class="btn-picker-action" onclick="pickerSelectNone()">å…¨å–æ¶ˆ</button>
            </div>
            <div id="pickerGrid" class="word-picker-container"></div>
            <div id="btnPickerSave" style="display:block;">
                <button class="btn-start-quiz" style="margin-top:15px;" onclick="closeWordPicker()">å®Œæˆé¸å–</button>
            </div>
            <div id="btnPickerQuickStart" class="quick-quiz-actions" style="display:none;">
                <button class="btn-quick-start choice" onclick="startQuickQuizDirect('choice')">é–‹å§‹é¸æ“‡é¡Œ</button>
                <button class="btn-quick-start spelling" onclick="startQuickQuizDirect('spelling')">é–‹å§‹æ‹¼å­—é¡Œ</button>
            </div>
        </div>
    </div>

    <div id="quizScreen" class="screen">
        <div class="quiz-header">
            <span style="font-weight:bold; color:#777;">Q: <span id="qIdx">1</span> / <span id="qTotal">10</span></span>
            <span id="timerBadge" class="timer-badge">â±ï¸ <span id="timeLeft">8</span>s</span>
            <button class="btn-icon" onclick="quitQuiz()">âŒ</button>
        </div>
        <div class="question-card">
            <div class="q-icon" onclick="playQuizSequence()">ğŸ”Š</div>
            <div class="q-hint" id="qHint" style="display:none;"></div>
            <button id="btnShowHint" class="btn-text-action" onclick="showHint()">ğŸ’¡ é¡¯ç¤ºä¸­æ–‡æ„æ€</button>
        </div>
        <div id="choiceArea" class="choice-container" style="display:none;"></div>
        <div id="spellingArea" class="spelling-container" style="display:none;">
            <input type="text" id="spellingInput" class="input-spelling" placeholder="è¼¸å…¥å–®å­—..." autocomplete="off">
            <div id="spellingFeedback" style="height: 20px; font-weight:bold; margin-bottom:10px;"></div>
            <button class="btn-submit-spelling" onclick="checkSpelling()">é€å‡º</button>
        </div>
        <button id="btnNextQ" class="btn-next-manual" onclick="nextQuestion()">â¡ ä¸‹ä¸€é¡Œ</button>
    </div>

    <div id="resultScreen" class="screen">
        <div class="result-box">
            <div style="font-size:4rem;">ğŸ†</div>
            <h2 style="color:var(--text-main);">æ¸¬é©—å®Œæˆï¼</h2>
            <div class="score-display" id="finalScore">100</div>
            <p id="finalMsg" style="color:#777; font-size:1.2rem; margin-bottom:30px;">å¤ªå²å®³äº†ï¼</p>
            <button class="btn-start-quiz" style="margin-bottom:15px;" onclick="goHome()">ğŸ  å›é¦–é </button>
            <button class="btn-back" style="width:100%; justify-content:center;" onclick="retryQuiz()">ğŸ”„ å†æ¸¬ä¸€æ¬¡ (éŒ¯é¡Œå„ªå…ˆ)</button>
        </div>
    </div>

<script src="words.js"></script>
<script>
    let sessions = [];
    let viewedWords = new Set(); 
    let studyData = { sid: null, list: [], currentIndex: 0 };
    let quizConfig = { mode: 'choice', selectedWords: new Set(), timer: false, autoNext: true };
    let quizData = { list: [], index: 0, score: 0, timerId: null };
    let currentPickerSid = null;
    let isQuickQuizPicker = false; 
    
    let userStats = {
        wordsViewedCount: 0,
        quizCount: 0,
        totalCorrect: 0,
        totalMistakes: 0 
    };
    let unlockedTitles = new Set();

    const achievements = [
        { id: 'view_10', category: 'learn', tier: 'common', title: 'å–®å­—åˆå­¸è€…', desc: 'çœ‹é 10 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 10 },
        { id: 'view_50', category: 'learn', tier: 'common', title: 'å–®å­—å°å­¸å¾’', desc: 'çœ‹é 50 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 50 },
        { id: 'view_100', category: 'learn', tier: 'rare', title: 'å–®å­—æ¢ç´¢è€…', desc: 'çœ‹é 100 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 100 },
        { id: 'view_300', category: 'learn', tier: 'rare', title: 'åšå­¸å¤šè', desc: 'çœ‹é 300 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 300 },
        { id: 'view_500', category: 'learn', tier: 'epic', title: 'å–®å­—å¤§å¸«', desc: 'çœ‹é 500 å€‹å–®å­—', check: (s) => s.wordsViewedCount >= 500 },
        { id: 'view_all', category: 'learn', tier: 'legendary', title: 'å…¨çŸ¥å…¨èƒ½', desc: 'çœ‹éæ‰€æœ‰å–®å­— (800+)', check: (s) => s.wordsViewedCount >= 800 },
        { id: 'quiz_1', category: 'quiz', tier: 'common', title: 'å‹‡æ–¼æŒ‘æˆ°', desc: 'å®Œæˆ 1 æ¬¡æ¸¬é©—', check: (s) => s.quizCount >= 1 },
        { id: 'quiz_10', category: 'quiz', tier: 'rare', title: 'æ¸¬é©—å¸¸å®¢', desc: 'å®Œæˆ 10 æ¬¡æ¸¬é©—', check: (s) => s.quizCount >= 10 },
        { id: 'quiz_50', category: 'quiz', tier: 'epic', title: 'èº«ç¶“ç™¾æˆ°', desc: 'å®Œæˆ 50 æ¬¡æ¸¬é©—', check: (s) => s.quizCount >= 50 },
        { id: 'correct_10', category: 'milestone', tier: 'common', title: 'ç­”é¡Œæ–°æ‰‹', desc: 'ç´¯ç©ç­”å° 10 é¡Œ', check: (s) => s.totalCorrect >= 10 },
        { id: 'correct_100', category: 'milestone', tier: 'rare', title: 'æ™ºæ…§ä¹‹æ˜Ÿ', desc: 'ç´¯ç©ç­”å° 100 é¡Œ', check: (s) => s.totalCorrect >= 100 },
        { id: 'correct_500', category: 'milestone', tier: 'epic', title: 'ç¥æº–å°„æ‰‹', desc: 'ç´¯ç©ç­”å° 500 é¡Œ', check: (s) => s.totalCorrect >= 500 },
        { id: 'correct_1000', category: 'milestone', tier: 'legendary', title: 'å‚³èªªä¸­çš„å­¸éœ¸', desc: 'ç´¯ç©ç­”å° 1000 é¡Œ', check: (s) => s.totalCorrect >= 1000 },
        { id: 'secret_night', category: 'secret', tier: 'rare', title: 'å¤œè²“å­', desc: 'åœ¨æ™šä¸Š 10 é»å¾ŒèƒŒå–®å­—', secretDesc: 'åœ¨æ·±å¤œæ™‚åˆ»å­¸ç¿’...', check: () => new Date().getHours() >= 22 },
        { id: 'secret_early', category: 'secret', tier: 'rare', title: 'æ—©èµ·çš„é³¥å…’', desc: 'åœ¨æ—©ä¸Š 7 é»å‰èƒŒå–®å­—', secretDesc: 'åœ¨æ¸…æ™¨æ™‚åˆ»å­¸ç¿’...', check: () => new Date().getHours() < 7 },
        { id: 'secret_fail', category: 'secret', tier: 'epic', title: 'æ„ˆæŒ«æ„ˆå‹‡', desc: 'ç´¯ç©ç­”éŒ¯ 50 æ¬¡', secretDesc: 'å¤±æ•—ç‚ºæˆåŠŸä¹‹æ¯...', check: (s) => s.totalMistakes >= 50 }
    ];

    window.onload = function() {
        if (typeof masterWordList === 'undefined') {
            alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è³‡æ–™åº« words.js"); return;
        }
        sessions = [...new Set(masterWordList.map(item => item.session))].sort();
        loadUserData();
        goHome();
    };

    function loadUserData() {
        const savedViewed = localStorage.getItem('viewedWords');
        if (savedViewed) viewedWords = new Set(JSON.parse(savedViewed));
        const savedStats = localStorage.getItem('userStats');
        if (savedStats) {
            const parsed = JSON.parse(savedStats);
            userStats.quizCount = parsed.quizCount || 0;
            userStats.totalCorrect = parsed.totalCorrect || 0;
            userStats.totalMistakes = parsed.totalMistakes || 0;
            userStats.wordsViewedCount = viewedWords.size;
        }
        const savedTitles = localStorage.getItem('unlockedTitles');
        if (savedTitles) unlockedTitles = new Set(JSON.parse(savedTitles));
    }

    function saveUserData() {
        localStorage.setItem('viewedWords', JSON.stringify([...viewedWords]));
        localStorage.setItem('userStats', JSON.stringify(userStats));
        localStorage.setItem('unlockedTitles', JSON.stringify([...unlockedTitles]));
    }

    function checkAchievements() {
        let newUnlock = false;
        userStats.wordsViewedCount = viewedWords.size;
        achievements.forEach(ach => {
            if (!unlockedTitles.has(ach.id) && ach.check(userStats)) {
                unlockedTitles.add(ach.id);
                showToast(ach.title);
                newUnlock = true;
            }
        });
        if (newUnlock) saveUserData();
    }

    function showToast(title) {
        const toast = document.getElementById('toastNotification');
        document.getElementById('toastMsg').innerText = title;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function goHome() { showScreen('homeScreen'); }
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
        clearInterval(quizData.timerId); 
        window.speechSynthesis.cancel(); 
    }

    function speak(text) {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        u.rate = 0.9; 
        const voices = window.speechSynthesis.getVoices();
        const preferred = voices.find(v => v.name.includes("Google US English") || v.name.includes("Samantha"));
        if (preferred) u.voice = preferred;
        window.speechSynthesis.speak(u);
    }

    function openAchievementScreen() {
        const grid = document.getElementById('badgeGrid');
        grid.innerHTML = "";
        const categories = { 'learn': 'ğŸ“š å‹¤å­¸ä¹‹è·¯', 'quiz': 'âš”ï¸ è©¦ç…‰æˆ°å ´', 'milestone': 'ğŸ’ å‚³å¥‡é‡Œç¨‹ç¢‘', 'secret': 'âœ¨ ç¥ç§˜å½©è›‹' };
        for (let cat in categories) {
            const header = document.createElement('div');
            header.className = `category-header cat-${cat}`;
            header.style.gridColumn = "1 / -1";
            header.innerText = categories[cat];
            grid.appendChild(header);
            achievements.filter(a => a.category === cat).forEach(ach => {
                const isUnlocked = unlockedTitles.has(ach.id);
                const div = document.createElement('div');
                div.className = `badge-card ${isUnlocked ? 'unlocked' : ''} ${ach.tier}`;
                let icon = 'ğŸ”’'; let title = 'ï¼Ÿï¼Ÿï¼Ÿ'; let desc = ach.secretDesc || 'é”æˆæ¢ä»¶è§£é–';
                if (isUnlocked) {
                    icon = 'ğŸ†'; 
                    if(ach.tier === 'legendary') icon = 'ğŸ‘‘'; else if(ach.tier === 'epic') icon = 'ğŸŒŸ'; else if(ach.tier === 'rare') icon = 'â­';
                    title = ach.title; desc = ach.desc;
                } else if (!ach.secretDesc) { title = ach.title; desc = ach.desc; }
                div.innerHTML = `<span class="badge-icon">${icon}</span><div class="badge-title">${title}</div><div class="badge-desc">${desc}</div>`;
                grid.appendChild(div);
            });
        }
        showScreen('achievementScreen');
    }

    function openAnalysisScreen() {
        const m = JSON.parse(localStorage.getItem('myMistakes')) || {};
        const topList = document.getElementById('topWeakList');
        const fullList = document.getElementById('fullMistakeList');
        let sorted = Object.keys(m).map(k => ({ word: k, count: m[k] })).sort((a,b) => b.count - a.count);
        if (sorted.length === 0) {
            topList.innerHTML = "<div style='color:#999;'>ç›®å‰æ²’æœ‰éŒ¯é¡Œç´€éŒ„ï¼Œå¤ªæ£’äº†ï¼</div>";
            fullList.innerHTML = "";
        } else {
            topList.innerHTML = "";
            sorted.slice(0, 3).forEach((item, idx) => {
                let medal = idx===0?'ğŸ¥‡':(idx===1?'ğŸ¥ˆ':'ğŸ¥‰');
                topList.innerHTML += `<div class="weak-item-card"><div style="font-size:1.5rem;">${medal}</div><span class="weak-word">${item.word}</span><span class="weak-count">éŒ¯ ${item.count} æ¬¡</span></div>`;
            });
            let html = "";
            sorted.forEach((item, idx) => {
                let rankClass = idx < 3 ? `top${idx+1}` : '';
                html += `<div class="mistake-row"><span class="rank-num ${rankClass}">#${idx+1}</span><span class="mistake-word">${item.word}</span><span class="mistake-val">éŒ¯ ${item.count} æ¬¡</span></div>`;
            });
            fullList.innerHTML = html;
        }
        showScreen('analysisScreen');
    }

    function startTop30WeaknessQuiz() {
        const m = JSON.parse(localStorage.getItem('myMistakes')) || {};
        const sorted = Object.keys(m).map(k => ({ word: k, count: m[k] })).sort((a,b) => b.count - a.count);
        if (sorted.length === 0) { alert("æ²’æœ‰éŒ¯é¡Œå¯ä»¥ç·´ç¿’ï¼"); return; }
        const top30 = sorted.slice(0, 30).map(i => i.word);
        quizConfig.selectedWords = new Set(top30);
        quizConfig.mode = 'choice'; quizConfig.timer = false; quizConfig.autoNext = true;
        startConfiguredQuiz();
    }

    function openUnitSelector(targetMode) {
        currentMode = targetMode; 
        const grid = document.getElementById('unitGridContainer');
        grid.innerHTML = "";
        sessions.forEach(sid => {
            const count = masterWordList.filter(w => w.session === sid).length;
            const btn = document.createElement('div');
            btn.className = 'unit-card';
            btn.innerHTML = `<h3>Unit ${sid}</h3><span>${count} words</span>`;
            btn.onclick = () => loadStudyOverview(sid);
            grid.appendChild(btn);
        });
        showScreen('unitSelectScreen');
    }

    function loadStudyOverview(sid) {
        studyData.sid = sid;
        studyData.list = masterWordList.filter(w => w.session === sid);
        document.getElementById('overviewTitle').innerText = `Unit ${sid}`;
        renderOverviewGrid();
        showScreen('studyOverviewScreen');
    }

    function renderOverviewGrid() {
        const grid = document.getElementById('overviewGrid');
        grid.innerHTML = "";
        studyData.list.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'word-overview-card';
            if (viewedWords.has(item.word)) card.classList.add('read');
            card.innerHTML = `<h4>${item.word}</h4>`;
            card.onclick = () => openFlashcard(index);
            grid.appendChild(card);
        });
    }

    function openFlashcard(index) {
        studyData.currentIndex = index;
        updateFlashcardUI();
        showScreen('studyDetailScreen');
    }

    function updateFlashcardUI() {
        const item = studyData.list[studyData.currentIndex];
        if (!viewedWords.has(item.word)) {
            viewedWords.add(item.word);
            saveUserData();
            checkAchievements(); 
        }
        document.getElementById('detailIdx').innerText = studyData.currentIndex + 1;
        document.getElementById('detailTotal').innerText = studyData.list.length;
        document.getElementById('cardWord').innerText = item.word;
        document.getElementById('cardZh').innerText = item.word_zh || '';
        document.getElementById('cardSentEn').innerText = item.sentence;
        document.getElementById('cardSentZh').innerText = item.sentence_zh || '';
        window.speechSynthesis.cancel();
        setTimeout(() => speak(item.word), 300);
    }

    function prevCard() { if (studyData.currentIndex > 0) { studyData.currentIndex--; updateFlashcardUI(); } }
    function nextCard() { if (studyData.currentIndex < studyData.list.length - 1) { studyData.currentIndex++; updateFlashcardUI(); } }
    function backToOverview() { renderOverviewGrid(); showScreen('studyOverviewScreen'); }
    function playCurrentCardAudio() { window.speechSynthesis.cancel(); speak(studyData.list[studyData.currentIndex].word); }
    function playCurrentCardSent() { window.speechSynthesis.cancel(); speak(studyData.list[studyData.currentIndex].sentence); }

    function quickQuizFromStudy() { openQuickQuizPicker(); }
    function openQuickQuizPicker() { isQuickQuizPicker = true; openWordPicker(studyData.sid); }
    function startQuickQuizDirect(mode) { quizConfig.mode = mode; quizConfig.timer = false; quizConfig.autoNext = true; closeWordPicker(); startConfiguredQuiz(); }

    function openQuizSetup() {
        quizConfig.mode = 'choice'; quizConfig.timer = false; quizConfig.autoNext = true;
        updateModeUI();
        document.getElementById('timerSwitch').checked = false;
        document.getElementById('autoNextSwitch').checked = true;
        renderQuizRangeGrid();
        updateTotalCount();
        showScreen('quizSetupScreen');
    }

    function renderQuizRangeGrid() {
        const grid = document.getElementById('quizRangeGrid');
        grid.innerHTML = "";
        sessions.forEach(sid => {
            const btn = document.createElement('div');
            btn.className = 'range-btn';
            const unitWords = masterWordList.filter(w => w.session === sid);
            let pickedCount = 0;
            unitWords.forEach(w => { if (quizConfig.selectedWords.has(w.word)) pickedCount++; });
            if (pickedCount > 0) btn.classList.add('has-data');
            btn.innerHTML = `Unit ${sid} ${pickedCount > 0 ? `<span class="badge-count">${pickedCount}</span>` : ''}`;
            btn.onclick = () => { isQuickQuizPicker = false; openWordPicker(sid); };
            grid.appendChild(btn);
        });
    }

    function setQuizMode(mode) { quizConfig.mode = mode; updateModeUI(); }
    function updateModeUI() {
        document.getElementById('modeChoice').classList.toggle('active', quizConfig.mode === 'choice');
        document.getElementById('modeSpelling').classList.toggle('active', quizConfig.mode === 'spelling');
    }
    function clearAllSelectedWords() { if(confirm("æ¸…é™¤æ‰€æœ‰é¸æ“‡ï¼Ÿ")) { quizConfig.selectedWords.clear(); renderQuizRangeGrid(); updateTotalCount(); } }
    function updateTotalCount() { document.getElementById('totalSelectedCount').innerText = quizConfig.selectedWords.size; }

    function openWordPicker(sid) {
        currentPickerSid = sid;
        document.getElementById('pickerTitle').innerText = `æŒ‘é¸å–®å­— (Unit ${sid})`;
        if (isQuickQuizPicker) {
            quizConfig.selectedWords.clear();
            const unitWords = masterWordList.filter(w => w.session === sid);
            unitWords.forEach(w => { if (viewedWords.has(w.word)) quizConfig.selectedWords.add(w.word); });
            document.getElementById('btnPickerSave').style.display = 'none';
            document.getElementById('btnPickerQuickStart').style.display = 'flex';
        } else {
            document.getElementById('btnPickerSave').style.display = 'block';
            document.getElementById('btnPickerQuickStart').style.display = 'none';
        }
        document.getElementById('wordPickerModal').style.display = 'block';
        renderPickerGrid();
    }
    function closeWordPicker() { document.getElementById('wordPickerModal').style.display = 'none'; if (!isQuickQuizPicker) { renderQuizRangeGrid(); updateTotalCount(); } }
    function renderPickerGrid() {
        const container = document.getElementById('pickerGrid'); container.innerHTML = "";
        const unitWords = masterWordList.filter(w => w.session === currentPickerSid);
        unitWords.forEach(item => {
            const div = document.createElement('div'); div.className = 'picker-item';
            if (quizConfig.selectedWords.has(item.word)) div.classList.add('picked');
            div.innerText = item.word;
            div.onclick = () => {
                if (quizConfig.selectedWords.has(item.word)) { quizConfig.selectedWords.delete(item.word); div.classList.remove('picked'); }
                else { quizConfig.selectedWords.add(item.word); div.classList.add('picked'); }
            };
            container.appendChild(div);
        });
    }
    function pickerSelectAll() { masterWordList.filter(w => w.session === currentPickerSid).forEach(w => quizConfig.selectedWords.add(w.word)); renderPickerGrid(); }
    function pickerSelectNone() { masterWordList.filter(w => w.session === currentPickerSid).forEach(w => quizConfig.selectedWords.delete(w.word)); renderPickerGrid(); }
    function pickerSelectViewed() {
        masterWordList.filter(w => w.session === currentPickerSid).forEach(w => {
            if (viewedWords.has(w.word)) quizConfig.selectedWords.add(w.word); else quizConfig.selectedWords.delete(w.word);
        }); renderPickerGrid();
    }

    function startConfiguredQuiz() {
        if (quizConfig.selectedWords.size === 0) { alert("è«‹è‡³å°‘é¸æ“‡ 1 å€‹å–®å­—ï¼"); return; }
        if (document.getElementById('quizSetupScreen').classList.contains('active')) {
            quizConfig.timer = document.getElementById('timerSwitch').checked;
            quizConfig.autoNext = document.getElementById('autoNextSwitch').checked;
        }
        let questions = masterWordList.filter(w => quizConfig.selectedWords.has(w.word));
        questions.sort(() => 0.5 - Math.random());
        quizData.list = questions; quizData.index = 0; quizData.score = 0;
        document.getElementById('choiceArea').style.display = (quizConfig.mode === 'choice') ? 'grid' : 'none';
        document.getElementById('spellingArea').style.display = (quizConfig.mode === 'spelling') ? 'block' : 'none';
        document.getElementById('timerBadge').style.display = quizConfig.timer ? 'inline-block' : 'none';
        document.getElementById('btnNextQ').style.display = 'none';
        showScreen('quizScreen');
        loadQuestion();
    }

    function loadQuestion() {
        clearInterval(quizData.timerId);
        document.getElementById('btnNextQ').style.display = 'none';
        
        // Hide hint initially
        document.getElementById('qHint').style.display = 'none';
        document.getElementById('btnShowHint').style.display = 'inline-block';

        const item = quizData.list[quizData.index];
        document.getElementById('qIdx').innerText = quizData.index + 1;
        document.getElementById('qTotal').innerText = quizData.list.length;
        document.getElementById('qHint').innerText = item.word_zh || "(ç„¡ä¸­æ–‡)";
        
        if (quizConfig.mode === 'choice') renderChoices(item); else renderSpelling();
        playQuizSequence();
    }

    function showHint() {
        document.getElementById('qHint').style.display = 'block';
        document.getElementById('btnShowHint').style.display = 'none';
    }

    function playQuizSequence() {
        const item = quizData.list[quizData.index];
        window.speechSynthesis.cancel();
        const u1 = new SpeechSynthesisUtterance(item.word); u1.rate = 0.9; u1.lang = 'en-US';
        const u2 = new SpeechSynthesisUtterance(item.sentence); u2.rate = 0.9; u2.lang = 'en-US';
        const u3 = new SpeechSynthesisUtterance(item.word); u3.rate = 0.9; u3.lang = 'en-US';
        u3.onend = function() { if (quizConfig.timer) startTimer(); };
        window.speechSynthesis.speak(u1); window.speechSynthesis.speak(u2); window.speechSynthesis.speak(u3);
    }

    function startTimer() {
        clearInterval(quizData.timerId); let timeLeft = 8;
        document.getElementById('timeLeft').innerText = timeLeft;
        quizData.timerId = setInterval(() => {
            timeLeft--; document.getElementById('timeLeft').innerText = timeLeft;
            if (timeLeft <= 0) { clearInterval(quizData.timerId); handleTimeUp(); }
        }, 1000);
    }

    function handleTimeUp() {
        speak("Time's up!");
        saveMistake(quizData.list[quizData.index].word);
        userStats.totalMistakes++;
        
        if (quizConfig.mode === 'choice') {
            const btns = document.querySelectorAll('.btn-choice');
            btns.forEach(b => {
                if (b.innerText === quizData.list[quizData.index].word) b.classList.add('correct');
                b.disabled = true;
            });
        } else {
            document.getElementById('spellingInput').value = quizData.list[quizData.index].word;
            document.getElementById('spellingInput').style.borderColor = "var(--danger)";
        }
        handleNextStep();
    }

    function handleNextStep() {
        if (quizConfig.autoNext) setTimeout(nextQuestion, 1500); else document.getElementById('btnNextQ').style.display = 'block';
    }

    function nextQuestion() {
        quizData.index++;
        if (quizData.index < quizData.list.length) loadQuestion(); else showResult();
    }

    function renderChoices(correctItem) {
        const container = document.getElementById('choiceArea'); container.innerHTML = "";
        let opts = [correctItem];
        let pool = quizData.list.length >= 4 ? quizData.list : masterWordList;
        while(opts.length < 4) { const rand = pool[Math.floor(Math.random() * pool.length)]; if (!opts.some(o => o.word === rand.word)) opts.push(rand); }
        opts.sort(() => 0.5 - Math.random());
        opts.forEach(opt => {
            const btn = document.createElement('button'); btn.className = 'btn-choice'; btn.innerText = opt.word;
            btn.onclick = () => checkChoice(btn, opt.word === correctItem.word);
            container.appendChild(btn);
        });
    }

    function checkChoice(btn, isCorrect) {
        clearInterval(quizData.timerId); window.speechSynthesis.cancel();
        const allBtns = document.querySelectorAll('.btn-choice'); allBtns.forEach(b => b.disabled = true);
        if (isCorrect) { btn.classList.add('correct'); quizData.score++; speak("Correct"); userStats.totalCorrect++; } 
        else { btn.classList.add('wrong'); saveMistake(quizData.list[quizData.index].word); speak("Wrong"); userStats.totalMistakes++;
               allBtns.forEach(b => { if (b.innerText === quizData.list[quizData.index].word) b.classList.add('correct'); }); }
        handleNextStep();
    }

    function renderSpelling() {
        const input = document.getElementById('spellingInput'); input.value = ""; input.disabled = false; input.style.borderColor = "#ddd"; document.getElementById('spellingFeedback').innerText = ""; input.focus();
    }

    function checkSpelling() {
        clearInterval(quizData.timerId); window.speechSynthesis.cancel();
        const input = document.getElementById('spellingInput');
        const correct = quizData.list[quizData.index].word.trim().toLowerCase();
        const userVal = input.value.trim().toLowerCase();
        input.disabled = true;
        if (userVal === correct || (correct.includes('(') && correct.startsWith(userVal))) {
            input.style.borderColor = "var(--success)"; quizData.score++; speak("Correct"); userStats.totalCorrect++;
        } else {
            input.style.borderColor = "var(--danger)";
            document.getElementById('spellingFeedback').innerText = `Ans: ${quizData.list[quizData.index].word}`;
            document.getElementById('spellingFeedback').style.color = "var(--danger)";
            saveMistake(quizData.list[quizData.index].word); speak("Wrong"); userStats.totalMistakes++;
        }
        handleNextStep();
    }
    document.getElementById('spellingInput').addEventListener('keyup', function(e) { if (e.key === 'Enter' && !this.disabled) checkSpelling(); });

    function showResult() {
        userStats.quizCount++;
        saveUserData();
        checkAchievements(); 
        showScreen('resultScreen');
        const finalScore = Math.round((quizData.score / quizData.list.length) * 100);
        document.getElementById('finalScore').innerText = finalScore;
    }

    function quitQuiz() { if (confirm("ç¢ºå®šæ”¾æ£„ï¼Ÿ")) goHome(); }
    function retryQuiz() { startConfiguredQuiz(); }

    function saveMistake(word) { let m = JSON.parse(localStorage.getItem('myMistakes')) || {}; m[word] = (m[word] || 0) + 1; localStorage.setItem('myMistakes', JSON.stringify(m)); }
    function openMistakes() { openAnalysisScreen(); }
    function clearMistakes() { if (confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) { localStorage.removeItem('myMistakes'); openAnalysisScreen(); } }

</script>
</body>
</html>