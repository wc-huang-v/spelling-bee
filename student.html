<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¸ç”Ÿç·´ç¿’å€ v31.0</title>
    <style>
        /* --- ğŸ¨ å­¸ç”Ÿç‰ˆé…è‰²ï¼šæ£®æ—æ¢éšªé¢¨æ ¼ --- */
        :root {
            --bg-color: #f9fbe7; 
            --primary: #27ae60;  
            --primary-light: #d5f5e3;
            --action: #f39c12;   
            --action-shadow: #d35400;
            --wrong: #e74c3c;
            --wrong-bg: #fadbd8;
            --text-main: #2c3e50; 
            --text-light: #7f8c8d;
            --radius-card: 24px;
            --radius-btn: 50px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Microsoft JhengHei', 'Varela Round', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 15px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
        }

        .app-container {
            width: 100%; max-width: 600px;
            background: #ffffff; 
            border-radius: var(--radius-card);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            overflow: hidden;
            border: 4px solid #fff; 
            min-height: 85vh; position: relative;
            display: flex; flex-direction: column;
        }

        /* Header */
        header {
            background: var(--primary); color: white; padding: 15px 20px;
            font-size: 1.3rem; font-weight: 900;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 5px solid rgba(0,0,0,0.1);
        }

        .header-right { display: flex; gap: 10px; }

        .nav-btn {
            background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5); 
            color: white; padding: 6px 14px; border-radius: 20px; cursor: pointer; 
            font-size: 0.9rem; font-weight:bold; transition: 0.2s;
            display: flex; align-items: center; gap: 5px;
        }
        .nav-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.4); }

        .screen { padding: 25px; display: none; flex: 1; overflow-y: auto; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .screen.active { display: block; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* 1. é¦–é  */
        .welcome-area { text-align: center; margin-bottom: 25px; margin-top: 15px; }
        .welcome-emoji { font-size: 4rem; margin-bottom: 10px; display: block; filter: drop-shadow(0 4px 0 #ddd); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        
        .session-select-area { 
            background: var(--primary-light); padding: 20px; border-radius: 20px; 
            border: 2px dashed var(--primary); margin-bottom: 25px; text-align: center;
        }
        select {
            width: 100%; padding: 15px; border-radius: 12px;
            border: 2px solid var(--primary); font-size: 1.2rem; 
            background: white; color: var(--text-main); font-weight: bold;
            outline: none; cursor: pointer; appearance: none;
            box-shadow: 0 4px 0 rgba(0,0,0,0.05); text-align: center;
        }

        .menu-grid { display: grid; gap: 20px; }
        
        .mode-card {
            background: white; border: 2px solid #eee; border-radius: 24px;
            padding: 20px; display: flex; align-items: center; gap: 20px;
            cursor: pointer; transition: 0.1s; box-shadow: 0 6px 0 #eee;
            position: relative; overflow: hidden;
        }
        .mode-card:active { transform: translateY(4px); box-shadow: 0 2px 0 #eee; }
        
        .mode-review:hover { border-color: var(--primary); }
        .mode-review .icon-box { background: var(--primary); color: white; }
        .mode-quiz:hover { border-color: var(--action); }
        .mode-quiz .icon-box { background: var(--action); color: white; }

        .icon-box {
            width: 65px; height: 65px; border-radius: 18px; display: flex; 
            justify-content: center; align-items: center; font-size: 2.2rem; flex-shrink: 0;
            box-shadow: inset 0 -4px 0 rgba(0,0,0,0.1);
        }
        .mode-info h3 { margin: 0; font-size: 1.4rem; color: var(--text-main); font-weight: 900; }
        .mode-info p { margin: 5px 0 0; color: var(--text-light); font-size: 0.95rem; font-weight: bold; }

        .btn-mistake {
            background: #fff; border: 2px solid var(--wrong); color: var(--wrong);
            width: 100%; padding: 15px; border-radius: 20px; margin-top: 25px;
            font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 #fadbd8; font-size: 1rem;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-mistake:active { transform: translateY(2px); box-shadow: none; }

        .safe-exit-area { margin-top: 40px; text-align: center; border-top: 2px dashed #eee; padding-top: 20px; }
        .btn-safe-exit {
            background: transparent; border: 1px solid #ccc; color: #999;
            padding: 10px 20px; border-radius: 30px; font-size: 0.9rem; cursor: pointer;
            display: inline-flex; align-items: center; gap: 5px; transition: 0.2s;
        }
        .btn-safe-exit:hover { border-color: var(--wrong); color: var(--wrong); background: #fff5f5; }

        /* 2. Grid */
        .grid-header { text-align: center; margin-bottom: 20px; }
        .word-grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .grid-item {
            background: #fff; border: 2px solid #eee; border-radius: 16px;
            padding: 25px 5px; text-align: center; font-size: 1.3rem; font-weight: 800;
            color: #bdc3c7; cursor: pointer; transition: 0.1s; box-shadow: 0 5px 0 #eee;
            position: relative;
        }
        .grid-item:active { transform: translateY(4px); box-shadow: 0 1px 0 #eee; }
        .grid-item.viewed {
            background-color: #fff; border-color: var(--primary); color: var(--primary);
            box-shadow: 0 5px 0 var(--primary-light);
        }
        .grid-item.viewed::after { content: "âœ”"; position: absolute; top: 5px; right: 8px; font-size: 0.9rem; color: var(--primary); }

        /* 3. Flashcard */
        .word-card {
            background: #fff; border: 3px solid var(--primary); border-radius: 30px;
            padding: 40px 20px; text-align: center; margin-bottom: 25px; 
            box-shadow: 0 10px 0 var(--primary-light); position: relative;
        }
        .wc-word { font-size: 3.5rem; font-weight: 900; color: var(--text-main); margin-bottom: 20px; word-break: break-word; line-height: 1.1; }
        .wc-sentence { 
            font-size: 1.4rem; color: #555; background: #f8f9fa; 
            padding: 20px; border-radius: 16px; text-align: left; 
            border-left: 6px solid var(--action); line-height: 1.5;
        }
        .btn-audio-small {
            width: 50px; height: 50px; border-radius: 50%; background: var(--action);
            border: none; font-size: 1.5rem; cursor: pointer; color: #fff;
            box-shadow: 0 4px 0 var(--action-shadow); margin: 0 auto 20px; display: block;
        }
        .btn-audio-small:active { transform: translateY(3px); box-shadow: none; }

        /* 4. Quiz */
        .quiz-status { 
            display: flex; justify-content: space-between; font-weight: bold; color: var(--primary); 
            background: var(--primary-light); padding: 12px 20px; border-radius: 30px; margin-bottom: 25px; font-size: 1.1rem;
        }
        .quiz-control-row { display: flex; align-items: center; justify-content: center; gap: 30px; margin-bottom: 25px; }
        
        .btn-audio-big {
            width: 90px; height: 90px; border-radius: 50%; background: var(--action);
            border: 5px solid #fff; font-size: 2.8rem; cursor: pointer; color: #fff;
            box-shadow: 0 8px 0 var(--action-shadow), 0 0 0 5px var(--action); 
            transition: 0.1s; animation: pulse 2s infinite; position: relative; z-index: 10;
        }
        .btn-audio-big:active { transform: translateY(4px); box-shadow: 0 4px 0 var(--action-shadow), 0 0 0 5px var(--action); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .timer-container { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .timer-btn { width: 70px; height: 70px; background: white; border: 4px solid #ccc; border-radius: 50%; color: #999; display: flex; justify-content: center; align-items: center; font-size: 2rem; font-weight: 900; cursor: pointer; box-shadow: 0 4px 0 #bbb; transition: 0.2s; }
        .timer-btn.active { border-color: var(--wrong); color: var(--wrong); box-shadow: 0 4px 0 #c0392b; }
        .timer-btn.ticking { animation: pulse 1s infinite; }
        
        .switch-wrapper { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-light); font-weight: bold;}
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }

        .quiz-input {
            width: 100%; padding: 18px; font-size: 2rem; text-align: center; font-weight: bold;
            border: 3px solid #e0e0e0; border-radius: 20px; outline: none;
            margin-bottom: 15px; color: var(--text-main); background: #fff; transition: 0.3s;
        }
        .quiz-input:focus { border-color: var(--action); box-shadow: 0 0 0 5px rgba(243, 156, 18, 0.2); }
        
        .feedback-area {
            min-height: 50px; text-align: center; font-weight: 800; margin-bottom: 15px; font-size: 1.4rem;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .correct { color: var(--primary); background: var(--primary-light); padding: 15px; border-radius: 15px; width: 100%; border: 2px solid var(--primary); }
        .wrong { color: var(--wrong); background: var(--wrong-bg); padding: 15px; border-radius: 15px; width: 100%; border: 2px solid var(--wrong); }

        /* æŒ‰éˆ• */
        .btn-main {
            width: 100%; padding: 18px; background: var(--primary); color: white;
            border: none; border-radius: 50px; font-size: 1.4rem; font-weight: 900;
            cursor: pointer; box-shadow: 0 6px 0 #1e8449; transition: 0.1s; margin-bottom: 15px;
        }
        .btn-main:active { transform: translateY(4px); box-shadow: 0 2px 0 #1e8449; }
        
        .btn-small {
            padding: 12px 20px; background: #fff; border: 2px solid #eee; border-radius: 30px;
            color: var(--text-light); cursor: pointer; font-weight: bold; font-size: 1rem;
            box-shadow: 0 4px 0 #eee; flex: 1; transition: 0.1s;
        }
        .btn-small:active { transform: translateY(4px); box-shadow: none; }

        /* ç¸½çµå€ */
        .summary-container { max-height: 50vh; overflow-y: auto; margin: 20px 0; border: 2px solid #eee; border-radius: 15px; }
        .summary-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; border-bottom: 1px solid #f0f0f0; background: #fff; }
        .summary-item:last-child { border-bottom: none; }
        .s-word { font-size: 1.3rem; font-weight: bold; color: #555; }
        .s-status { font-size: 1.3rem; margin-right: 10px; }
        .s-btn-audio { width: 40px; height: 40px; border-radius: 50%; background: #eafaf1; border: none; color: var(--primary); cursor: pointer; font-size: 1.1rem; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .modal-content { background-color: #fff; margin: 15% auto; padding: 25px; width: 90%; max-width: 500px; border-radius: 20px; max-height: 70vh; overflow-y: auto; position: relative; border: 4px solid var(--primary); }
        #mistakeModal .modal-content { border-color: var(--wrong); }
        .close-btn { float: right; font-size: 28px; cursor: pointer; color: #aaa; }
        .mistake-list { list-style: none; padding: 0; }
        .mistake-item { border-bottom: 1px dashed #eee; padding: 12px 0; display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold; color: #555; }
        .mistake-count { background: var(--wrong); color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.9rem; }
        .help-h3 { color: var(--primary); font-size: 1.2rem; display: flex; align-items: center; gap: 8px; margin-bottom: 5px; margin-top: 20px; }
        .help-p { color: #555; line-height: 1.6; font-size: 1rem; margin: 0; }

    </style>
</head>
<body>

<div class="app-container">
    <header>
        <span>ğŸŒ± å­¸ç”Ÿç·´ç¿’å€</span>
        <div class="header-right">
            <button class="nav-btn" onclick="openHelp()">â“ èªªæ˜</button>
            <button class="nav-btn" onclick="goHome()">ğŸ  é¸å–®</button>
        </div>
    </header>

    <div id="homeScreen" class="screen active">
        <div class="welcome-area">
            <span class="welcome-emoji">ğŸ’</span>
            <h2 style="color:var(--text-main); margin:0;">Happy Learning!</h2>
            <p style="color:#aaa; margin-top:5px; font-weight:bold;">ä»Šå¤©æƒ³æŒ‘æˆ°å“ªä¸€é—œï¼Ÿ</p>
        </div>

        <div class="session-select-area">
            <label style="display:block; margin-bottom:10px; color:var(--text-main); font-weight:bold; font-size:1.1rem;">ğŸ“ é¸æ“‡å–®å…ƒ</label>
            <select id="sessionSelect"></select>
        </div>

        <div class="menu-grid">
            <div class="mode-card mode-review" onclick="startReviewGrid()">
                <div class="icon-box">ğŸ“–</div>
                <div class="mode-info"><h3>å–®å­—é ç¿’</h3><p>ç€è¦½å–®å­—å¡</p></div>
            </div>
            <div class="mode-card mode-quiz" onclick="startQuiz()">
                <div class="icon-box">âœï¸</div>
                <div class="mode-info"><h3>è½å¯«æŒ‘æˆ°</h3><p>éš¨æ©Ÿ 5 é¡Œæ¸¬é©—</p></div>
            </div>
        </div>

        <button class="btn-mistake" onclick="openMistakes()">
            <span style="font-size:1.5rem;">ğŸ“Š</span> æˆ‘çš„éŒ¯é¡Œæœ¬ (Top 5)
        </button>
        
        <div class="safe-exit-area">
            <button class="btn-safe-exit" onclick="confirmExit()">ğŸšª çµæŸç·´ç¿’ (å›åˆ°ç¸½å…¥å£)</button>
        </div>

        <div id="loadStatus" style="text-align:center; margin-top:20px; color:#ccc; font-size:0.8rem;"></div>
    </div>

    <div id="gridScreen" class="screen">
        <div class="grid-header">
            <h3 style="color:var(--text-main); margin:0;">å–®å…ƒå–®å­—è¡¨</h3>
            <p style="color:#999; font-size:0.9rem; margin-top:5px; font-weight:bold;">é»æ“Šè®Šè‰²ä»£è¡¨çœ‹éå›‰ï¼</p>
        </div>
        <div id="wordGrid" class="word-grid-container"></div>
        <button class="btn-small" onclick="goHome()" style="width:100%; margin-top:30px;">â¬… å›é¸å–®</button>
    </div>

    <div id="flashcardScreen" class="screen">
        <div class="word-card">
            <div class="wc-word" id="revWord">...</div>
            <button class="btn-audio-small" onclick="playWord()">ğŸ”Š</button>
            <div class="wc-sentence" id="revSentence">...</div>
        </div>

        <button class="btn-main" onclick="backToGrid()" style="background:var(--text-main); box-shadow:0 6px 0 #17202a;">ğŸ†— çœ‹å®Œäº†</button>
        <div style="display:flex; justify-content:space-between; margin-top:10px; gap:10px;">
            <button class="btn-small" onclick="prevReview()">â¬… ä¸Šä¸€å€‹</button>
            <button class="btn-small" onclick="nextReview()">ä¸‹ä¸€å€‹ â¡</button>
        </div>
    </div>

    <div id="quizScreen" class="screen">
        <div class="quiz-status">
            <span>ğŸš€ æŒ‘æˆ°ä¸­</span>
            <span><span id="quizIndex">1</span> / <span id="quizTotal">5</span></span>
        </div>
        
        <div class="quiz-control-row">
            <div style="text-align:center;">
                <button class="btn-audio-big" onclick="playQuestionSequence()">ğŸ”Š</button>
                <div style="font-size:0.8rem; color:#aaa; font-weight:bold; margin-top:5px;">è½é¡Œç›®</div>
            </div>
            <div class="timer-container">
                <button class="timer-btn" id="studentTimerBtn" onclick="manualStartTimer()">8</button>
                <div class="switch-wrapper">
                    <label class="switch">
                        <input type="checkbox" id="autoTimerSwitch">
                        <span class="slider round"></span>
                    </label>
                    <span>è‡ªå‹•å€’æ•¸</span>
                </div>
            </div>
        </div>

        <input type="text" id="userSpelling" class="quiz-input" placeholder="è¼¸å…¥å–®å­—..." autocomplete="off" autocapitalize="off">
        <div id="quizFeedback" class="feedback-area"></div>

        <button class="btn-main" onclick="checkAnswer()" style="background:var(--action); box-shadow:0 6px 0 var(--action-shadow);">âœ¨ é€å‡ºæª¢æŸ¥</button>
    </div>

    <div id="finishScreen" class="screen">
        <div style="text-align:center;">
            <div style="font-size:5rem; margin-top:20px; filter:drop-shadow(0 10px 0 rgba(0,0,0,0.1));">ğŸ‰</div>
            <h2 style="color:var(--primary); margin:10px 0;">æ¸¬é©—çµæŸï¼</h2>
            <p style="color:#7f8c8d; font-weight:bold;">ä¾†çœ‹çœ‹ä½ çš„æˆç¸¾å–®å§ï¼š</p>
        </div>
        <div id="summaryContainer" class="summary-container"></div>
        <button class="btn-main" onclick="goHome()" style="margin-top:20px;">ğŸ  å›é¸å–®</button>
    </div>

</div>

<div id="mistakeModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('mistakeModal')">&times;</span>
        <h2 style="color:var(--wrong); text-align:center; margin-top:0;">ğŸ“Š æˆ‘çš„å¸¸éŒ¯å­—</h2>
        <div id="mistakeListContainer"></div>
        <div style="text-align:center; margin-top:20px;">
            <button class="btn-small" onclick="clearMyMistakes()" style="color:var(--wrong); border-color:var(--wrong);">ğŸ—‘ï¸ æ¸…ç©ºç´€éŒ„</button>
        </div>
    </div>
</div>

<div id="helpModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('helpModal')">&times;</span>
        <h2 style="color:var(--primary); text-align:center; margin-top:0;">ğŸ“– å°æœ‹å‹æ“ä½œæŒ‡å—</h2>
        <h3 class="help-h3">ğŸ“– æ€éº¼é ç¿’ï¼Ÿ</h3><p class="help-p">é»æ“Šæ ¼å­çœ‹å–®å­—å¡ã€‚çœ‹éçš„å­—ï¼Œæ ¼å­æœƒè®Šæˆç¶ è‰²æ‰“å‹¾å‹¾å–” âœ…ï¼</p>
        <h3 class="help-h3">âœï¸ æ€éº¼è€ƒè©¦ï¼Ÿ</h3><p class="help-p">æŒ‰ä¸‹å¤§å–‡å­ ğŸ”Šï¼Œè½é¡Œç›®ï¼ˆå­—-å¥-å­—ï¼‰ï¼Œç„¶å¾ŒæŠŠå–®å­—æ‰“å‡ºä¾†ã€‚</p>
        <h3 class="help-h3">ğŸ“Š éŒ¯é¡Œæœ¬</h3><p class="help-p">é›»è…¦æœƒè‡ªå‹•å¹«ä½ è¨˜ä½å¸¸å¯«éŒ¯çš„å­—ï¼Œé»æ“Šã€ŒéŒ¯é¡Œæœ¬ã€å°±å¯ä»¥è¤‡ç¿’ã€‚</p>
        <div style="text-align:center; margin-top:25px;"><button class="btn-main" style="width:auto; padding:10px 40px;" onclick="closeModal('helpModal')">æˆ‘çŸ¥é“äº†</button></div>
    </div>
</div>

<script src="words.js"></script>
<script>
    let db = [], currentList = [], currentIndex = 0;
    // âœ… é—œéµå„ªåŒ–ï¼šå¾ LocalStorage è®€å–å·²è®€ç´€éŒ„
    let viewedIndices = new Set(JSON.parse(localStorage.getItem('viewedWords') || '[]'));
    let quizResults = [], timerValue = 8, timerInterval = null, isTimerRunning = false;

    window.onload = function() {
        if (typeof masterWordList !== 'undefined') {
            db = masterWordList;
            initSessions();
            document.getElementById('loadStatus').innerText = "v31.0 Ready";
        } else {
            document.getElementById('loadStatus').innerHTML = "<span style='color:red'>âš ï¸ æ‰¾ä¸åˆ° words.js</span>";
        }
    };

    function initSessions() {
        const sessions = [...new Set(db.map(x => x.session))].sort((a,b)=>a-b);
        const sel = document.getElementById('sessionSelect');
        sessions.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.innerText = `ç¬¬ ${s} å–®å…ƒ`; sel.appendChild(opt); });
    }

    function goHome() { showScreen('homeScreen'); }
    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function confirmExit() { if(confirm("ç¢ºå®šè¦é›¢é–‹ç·´ç¿’å€å›åˆ°å…¥å£å—ï¼Ÿ")) window.location.href = "index.html"; }

    function prepareList(mode) {
        const session = parseInt(document.getElementById('sessionSelect').value);
        let list = db.filter(x => x.session === session);
        if (mode === 'quiz') { list.sort(() => Math.random() - 0.5); if (list.length > 5) list = list.slice(0, 5); }
        currentList = list; currentIndex = 0;
    }

    // Grid
    function startReviewGrid() {
        prepareList('review');
        if(currentList.length === 0) { alert("ç„¡å–®å­—"); return; }
        renderGrid(); showScreen('gridScreen');
    }
    function renderGrid() {
        const container = document.getElementById('wordGrid'); container.innerHTML = "";
        currentList.forEach((item, index) => {
            const div = document.createElement('div'); div.className = 'grid-item'; div.innerText = item.word;
            if (viewedIndices.has(item.word)) div.classList.add('viewed');
            div.onclick = () => jumpToCard(index);
            container.appendChild(div);
        });
    }
    function jumpToCard(index) { currentIndex = index; showScreen('flashcardScreen'); updateReviewCard(); }
    function backToGrid() { renderGrid(); showScreen('gridScreen'); }

    function updateReviewCard() {
        const item = currentList[currentIndex];
        document.getElementById('revWord').innerText = item.word;
        document.getElementById('revSentence').innerText = item.sentence;
        markAsViewed(item.word);
    }
    // âœ… é—œéµå„ªåŒ–ï¼šå­˜æª”å·²è®€ç´€éŒ„
    function markAsViewed(word) {
        viewedIndices.add(word);
        localStorage.setItem('viewedWords', JSON.stringify([...viewedIndices]));
    }

    function playWord() { speak(currentList[currentIndex].word); }
    function speakText(type) { const item = currentList[currentIndex]; speak(type === 'word' ? item.word : item.sentence); }
    function prevReview() { if(currentIndex > 0) { currentIndex--; updateReviewCard(); } }
    function nextReview() { if(currentIndex < currentList.length - 1) { currentIndex++; updateReviewCard(); } else { if(confirm("å›ç¸½è¡¨ï¼Ÿ")) backToGrid(); } }

    // Quiz
    function startQuiz() {
        prepareList('quiz'); if(currentList.length === 0) { alert("ç„¡å–®å­—"); return; }
        quizResults = []; showScreen('quizScreen'); loadQuizQuestion();
    }
    function loadQuizQuestion() {
        resetTimer();
        document.getElementById('quizIndex').innerText = currentIndex + 1;
        document.getElementById('quizTotal').innerText = currentList.length;
        document.getElementById('userSpelling').value = "";
        document.getElementById('userSpelling').disabled = false;
        document.getElementById('quizFeedback').innerText = "";
        document.getElementById('quizFeedback').className = "feedback-area";
        setTimeout(() => { document.getElementById('userSpelling').focus(); playQuestionSequence(); }, 500);
    }
    function playQuestionSequence() {
        resetTimer(); const item = currentList[currentIndex]; window.speechSynthesis.cancel();
        const u1 = new SpeechSynthesisUtterance(item.word); u1.lang = 'en-US'; u1.rate = 0.8;
        const u2 = new SpeechSynthesisUtterance(item.sentence); u2.lang = 'en-US'; u2.rate = 0.8;
        const u3 = new SpeechSynthesisUtterance(item.word); u3.lang = 'en-US'; u3.rate = 0.8;
        u3.onend = function() { if(document.getElementById('autoTimerSwitch').checked) startTimer(); };
        window.speechSynthesis.speak(u1); window.speechSynthesis.speak(u2); window.speechSynthesis.speak(u3);
    }
    function checkAnswer() {
        const userAns = document.getElementById('userSpelling').value.trim().toLowerCase();
        const item = currentList[currentIndex]; const correctAns = item.word.trim().toLowerCase();
        const feedback = document.getElementById('quizFeedback');
        document.getElementById('userSpelling').disabled = true; resetTimer();
        let isCorrect = false;
        if (userAns === correctAns) {
            feedback.innerHTML = "âœ… ç­”å°äº†ï¼"; feedback.className = "feedback-area correct"; playDing(); isCorrect = true;
        } else {
            feedback.innerHTML = `âŒ ç­”æ¡ˆæ˜¯ï¼š${item.word}`; feedback.className = "feedback-area wrong"; speak(item.word); saveMyMistake(item.word); isCorrect = false;
        }
        quizResults.push({ word: item.word, correct: isCorrect });
        setTimeout(() => { nextQuiz(); }, 1500);
    }
    function nextQuiz() { currentIndex++; if (currentIndex < currentList.length) loadQuizQuestion(); else { renderSummary(); showScreen('finishScreen'); } }
    
    function renderSummary() {
        const container = document.getElementById('summaryContainer'); let html = "";
        quizResults.forEach(r => {
            const statusIcon = r.correct ? "âœ…" : "âŒ"; const color = r.correct ? "green" : "red";
            html += `<div class="summary-item"><div style="display:flex; align-items:center;"><span class="s-status">${statusIcon}</span><span class="s-word" style="color:${color}">${r.word}</span></div><button class="s-btn-audio" onclick="speak('${r.word}')">ğŸ”Š</button></div>`;
        });
        container.innerHTML = html;
    }

    // Timer & Audio
    function manualStartTimer() { if(isTimerRunning) resetTimer(); else startTimer(); }
    function startTimer() {
        if(isTimerRunning) return; isTimerRunning = true; timerValue = 8; updateTimerDisplay();
        const btn = document.getElementById('studentTimerBtn'); btn.classList.add('active', 'ticking');
        timerInterval = setInterval(() => {
            timerValue--; updateTimerDisplay();
            if(timerValue <= 0) { clearInterval(timerInterval); playDing(); isTimerRunning = false; btn.classList.remove('ticking'); }
        }, 1000);
    }
    function resetTimer() { clearInterval(timerInterval); isTimerRunning = false; timerValue = 8; const btn = document.getElementById('studentTimerBtn'); btn.innerText = "8"; btn.classList.remove('active', 'ticking'); }
    function updateTimerDisplay() { document.getElementById('studentTimerBtn').innerText = timerValue; }
    function speak(text) { const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; u.rate = 0.8; window.speechSynthesis.speak(u); }
    function playDing() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)(); const t = ctx.currentTime;
        const osc1 = ctx.createOscillator(); const osc2 = ctx.createOscillator(); const gain = ctx.createGain();
        osc1.connect(gain); osc2.connect(gain); gain.connect(ctx.destination);
        osc1.type = "sine"; osc1.frequency.setValueAtTime(880, t); osc2.type = "sine"; osc2.frequency.setValueAtTime(1760, t);
        gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(0.5, t + 0.01); gain.gain.exponentialRampToValueAtTime(0.001, t + 1.5);
        osc1.start(t); osc2.start(t); osc1.stop(t + 1.5); osc2.stop(t + 1.5);
    }

    // Mistakes Modal
    function saveMyMistake(word) { let m = JSON.parse(localStorage.getItem('myMistakes')) || {}; m[word] = (m[word] || 0) + 1; localStorage.setItem('myMistakes', JSON.stringify(m)); }
    function openMistakes() {
        document.getElementById('mistakeModal').style.display = 'block';
        const m = JSON.parse(localStorage.getItem('myMistakes')) || {};
        const c = document.getElementById('mistakeListContainer');
        if (Object.keys(m).length === 0) { c.innerHTML = "<p style='text-align:center; padding:20px;'>å¥½æ£’ï¼ç›®å‰æ²’æœ‰éŒ¯é¡Œç´€éŒ„ï¼ğŸ‘</p>"; return; }
        let s = Object.keys(m).map(k => ({ word: k, count: m[k] })).sort((a,b) => b.count - a.count).slice(0, 5);
        let html = "<ul class='mistake-list'>";
        s.forEach(i => { html += `<li class='mistake-item'><span>${i.word}</span><span class='mistake-count'>éŒ¯ ${i.count} æ¬¡</span></li>`; });
        c.innerHTML = html + "</ul>";
    }
    function openHelp() { document.getElementById('helpModal').style.display = 'block'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function clearMyMistakes() { if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) { localStorage.removeItem('myMistakes'); openMistakes(); } }
    window.onclick = function(e) { if(e.target.classList.contains('modal')) e.target.style.display = 'none'; }

</script>
</body>
</html>